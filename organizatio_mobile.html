<!--
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣤⣶⢶⣶⣄⠀⣠⣴⣾⠿⠿⣷⣄⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⢀⣠⣤⣤⣄⣀⡀⠀⠀⠀⠀⢀⣀⣀⣀⣠⣾⠋⠀⠀⠈⠹⣿⡟⠉⠀⠀⠀⠘⣿⡄⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⢀⣾⠟⠉⠉⠉⠛⠻⢿⣶⠿⠿⠟⠛⠛⠛⣿⠇⠀⢠⣶⣶⣶⣿⣷⣦⣤⣀⣠⣤⣿⣷⣄⠀⠀⠀⠀⠀
⠀⠀⠀⠀⢸⡟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢰⣿⠀⠀⢸⣿⣼⡿⠁⠀⠀⠙⣿⣯⡁⠀⠈⢿⡇⠀⠀⠀⠀
⠀⠀⠀⠀⢹⣧⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⣿⣄⠀⠀⢙⣿⣷⡀⠀⠀⢠⣿⣿⣿⡆⠀⣾⡇⠀⠀⠀⠀
⠀⠀⠀⠀⠈⢿⣿⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠛⠛⠛⠛⠋⠙⠻⠷⠾⣿⡟⠛⠋⠀⣴⡟⠀⠀⠀⠀⠀
⠀⠀⠀⠀⢀⣾⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠻⠷⡶⠿⠛⣿⡄⠀⠀⠀⠀
⠀⠀⠀⠀⣸⡟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⣹⣷⣤⣤⣤⡄
⠀⠀⠀⠀⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣄⡀⠀⠀⠀⠘⠋⢹⣿⠀⠀⠀⠀
⠀⣀⣀⣤⣿⣧⣤⡄⠀⠀⠀⢀⣤⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢿⣿⡷⠀⠀⠀⠀⢠⣼⣿⣤⣤⡤⠀
⠈⠛⠉⠉⠹⣿⠀⠀⠀⠀⠀⠸⣿⡿⠀⠀⠀⠀⠀⢀⣠⡤⣤⡀⠀⠀⠀⠀⠈⠉⠀⠀⠀⠀⠀⢀⣾⠏⠀⠀⠀⠀
⠀⠀⠀⣀⣤⣿⣷⠞⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⠷⠤⠼⣃⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢛⣿⡿⢶⣤⣄⠀⠀
⠀⠀⠀⠉⠁⠀⠹⣷⣤⡴⠆⠀⠀⠀⠀⠀⢀⣤⣤⣤⣤⣤⣼⡟⣻⡇⠀⠀⠀⠀⠀⠀⣀⣴⡿⠋⠀⠀⠀⠉⠀⠀
⠀⠀⠀⠀⢀⣠⡾⠟⠛⠿⣶⣤⣤⣤⣄⣰⣿⣍⣀⡀⠀⠈⠙⠳⠿⢷⣦⣀⣠⣤⣶⣿⣟⠉⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠘⠋⠀⠀⠀⣰⡟⠉⠀⠀⠙⣿⣅⣉⣿⣁⣀⣠⣶⡀⠀⠀⠈⣿⡏⠁⠀⠀⠹⣷⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠠⣿⠀⠀⠀⠀⠀⣿⣧⡽⠉⠛⢉⣉⣘⣷⣄⣰⣿⣿⠇⠀⠀⠀⠀⣿⡆⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⢀⣿⡄⠀⠀⠀⠀⣻⡷⡄⣞⣳⠘⢦⣇⡈⠙⡿⢿⡇⠀⠀⠀⠀⢠⣿⡀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⣴⡟⠉⢿⣦⣄⣠⣴⡿⠛⣡⣌⣿⢳⡞⠧⣿⣀⡙⠚⢿⣦⣄⣤⣴⠟⠙⢿⡄⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⢰⡿⠀⠀⠀⠈⠉⠉⢹⣧⠈⠳⠞⡉⢻⡷⢦⠸⢭⣧⣤⡿⠋⠉⠉⠀⠀⠀⠈⣿⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⢸⣇⠀⠀⠀⠀⠀⠀⠈⣿⣆⠀⢾⣹⠆⠙⢫⣶⣾⡿⠋⠀⠀⠀⠀⠀⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠘⣿⡀⠀⠀⠀⠀⠀⠀⠘⢿⣶⣤⣤⣴⣾⡿⠻⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⢰⡿⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠹⣷⣄⠀⠀⠀⠀⠀⢀⣼⣿⣿⡿⠿⠿⣷⣶⣿⣷⡀⠀⠀⠀⠀⠀⢀⣴⡿⠁⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠈⠻⢷⣦⣤⣤⣴⡿⠋⠁⠀⠀⠀⠀⠀⠀⠈⠙⢿⣦⣤⣀⣤⣴⡿⠛⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠉⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀               
 _         _       _        _       _   _                         
|_|___ ___| |_ ___| |___   | |_ ___| |_| |_ ___ ___   
| |_ -| .'| . | -_| | .'|  | . | .'| '_| '_| -_|  _|   
|_|___|__,|___|___|_|__,|  |___|__,|_,_|_,_|___|_|                                                   
♡‧₊˚🎀༺♡༻🎀˚₊‧♡ ♡‧₊˚🎀♡༻🎀˚₊‧♡ ♡‧₊˚🎀༺♡༻🎀˚₊‧♡ 
-->

<!DOCTYPE html>
<html lang="pt-br">

<head>

  <link rel="icon" type="image/png" href="./images/icon.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title> OrganizatIO</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* === DESIGN SYSTEM === */
    :root {
      /* Colors */
      --primary: #3586ff;
      --primary-hover: #3d71ff;
      --primary-light: #6b9aff;
      --success: #4CAF50;
      --success-hover: #45a049;
      --danger: #FF5252;
      --danger-hover: #f44336;
      --warning: #FF9800;
      --neutral: #9E9E9E;
      --neutral-hover: #757575;
      
      /* Text */
      --text-primary: #333;
      --text-secondary: #666;
      --text-muted: #999;
      
      /* Backgrounds */
      --bg-primary: #FFFFFF;
      --bg-secondary: #f8f9fa;
      --bg-tertiary: #f0f2f5;
      
      /* Borders */
      --border-light: #e6e5e5;
      --border-medium: #ddd;
      --border-dark: #ccc;
      
      /* Spacing Scale */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 12px;
      --space-lg: 16px;
      --space-xl: 20px;
      --space-2xl: 24px;
      --space-3xl: 32px;
      
      /* Border Radius */
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
      --radius-full: 50%;
      
      /* Shadows */
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 8px rgba(0,0,0,0.1);
      --shadow-lg: 0 8px 16px rgba(0,0,0,0.1);
      --category-icon-filter: grayscale(100%) brightness(0.55);
      
      /* Typography */
      --font-size-xs: 13px;
      --font-size-sm: 14px;
      --font-size-md: 16px;
      --font-size-lg: 18px;
      --font-size-xl: 20px;
      --font-size-2xl: 24px;
      
      --line-height-tight: 1.2;
      --line-height-normal: 1.4;
      --line-height-relaxed: 1.6;
    }

    /* Dark Mode */
    body.dark-mode {
      --text-primary: #E0E0E0;
      --text-secondary: #BDBDBD;
      --text-muted: #9E9E9E;
      
      --bg-primary: #1a1a1a;
      --bg-secondary: #2d2d2d;
      --bg-tertiary: #333;
      
      --border-light: #444;
      --border-medium: #555;
      --border-dark: #666;
      
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 8px rgba(0,0,0,0.3);
      --shadow-lg: 0 8px 16px rgba(0,0,0,0.3);
      --category-icon-filter: grayscale(100%) brightness(1.4);
    }
    /* === BASE STYLES === */
    * {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      box-sizing: border-box;
    }

    body {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: var(--font-size-md);
      line-height: var(--line-height-normal);
      margin: 0;
      padding: 0;
      text-transform: lowercase;
      transition: background 0.3s, color 0.3s;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    input,
    select,
    textarea {
      font-size: var(--font-size-md);
      line-height: var(--line-height-normal);
    }

    label,
    button {
      font-size: var(--font-size-sm);
    }

    /* === COMPONENT SYSTEM === */
    
    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      padding: var(--space-md) var(--space-lg);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      font-weight: 500;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 44px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }
    .btn-primary:hover {
      background: var(--primary-hover);
    }

    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-medium);
    }
    .btn-secondary:hover {
      background: var(--border-light);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }
    .btn-success:hover {
      background: var(--success-hover);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }
    .btn-danger:hover {
      background: var(--danger-hover);
    }

    .btn-sm {
      padding: var(--space-sm) var(--space-md);
      font-size: var(--font-size-xs);
      min-height: 32px;
    }

    .btn-lg {
      padding: var(--space-lg) var(--space-xl);
      font-size: var(--font-size-lg);
      min-height: 52px;
    }

    .btn-full {
      width: 100%;
    }

    /* Cards */
    .card {
      background: var(--bg-primary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      padding: var(--space-xl);
      border: 1px solid var(--border-light);
    }

    .card-header {
      margin-bottom: var(--space-lg);
      padding-bottom: var(--space-md);
      border-bottom: 1px solid var(--border-light);
    }

    .card-title {
      font-size: var(--font-size-lg);
      font-weight: 600;
      margin: 0;
      color: var(--text-primary);
    }

    /* Forms */
    .form-group {
      margin-bottom: var(--space-lg);
    }

    .form-label {
      display: block;
      margin-bottom: var(--space-sm);
      font-weight: 500;
      color: var(--text-primary);
    }

    .form-input {
      width: 100%;
      padding: var(--space-md);
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-md);
      font-size: var(--font-size-md);
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: border-color 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(53, 134, 255, 0.1);
    }

    .form-select {
      width: 100%;
      padding: var(--space-md);
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-md);
      font-size: var(--font-size-md);
      background: var(--bg-primary);
      color: var(--text-primary);
      cursor: pointer;
    }

    /* Layout */
    .container {
      max-width: 2000px;
      margin: 0 auto;
      padding: var(--space-lg);
      padding-bottom: 20px;
      flex: 1 0 auto;
      width: 100%;
      box-sizing: border-box;
    }

    .grid {
      display: grid;
      gap: var(--space-lg);
    }

    .grid-2 {
      grid-template-columns: repeat(2, 1fr);
    }

    .grid-3 {
      grid-template-columns: repeat(3, 1fr);
    }

    .flex {
      display: flex;
    }

    .flex-col {
      flex-direction: column;
    }

    .items-center {
      align-items: center;
    }

    .task-form-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .task-form-input {
      flex: 1 1 0;
      width: 100%;
      box-sizing: border-box;
      min-width: 0;
    }

    .justify-between {
      justify-content: space-between;
    }

    .gap-sm {
      gap: var(--space-sm);
    }

    .gap-md {
      gap: var(--space-md);
    }

    .gap-lg {
      gap: var(--space-lg);
    }

    /* Spacing utilities */
    .p-sm { padding: var(--space-sm); }
    .p-md { padding: var(--space-md); }
    .p-lg { padding: var(--space-lg); }
    .p-xl { padding: var(--space-xl); }

    .m-sm { margin: var(--space-sm); }
    .m-md { margin: var(--space-md); }
    .m-lg { margin: var(--space-lg); }
    .m-xl { margin: var(--space-xl); }

    .mb-sm { margin-bottom: var(--space-sm); }
    .mb-md { margin-bottom: var(--space-md); }
    .mb-lg { margin-bottom: var(--space-lg); }
    .mb-xl { margin-bottom: var(--space-xl); }

    /* Text utilities */
    .text-xs { font-size: var(--font-size-xs); }
    .text-sm { font-size: var(--font-size-sm); }
    .text-md { font-size: var(--font-size-md); }
    .text-lg { font-size: var(--font-size-lg); }
    .text-xl { font-size: var(--font-size-xl); }

    .text-primary { color: var(--text-primary); }
    .text-secondary { color: var(--text-secondary); }
    .text-muted { color: var(--text-muted); }

    .font-medium { font-weight: 500; }
    .font-semibold { font-weight: 600; }
    .font-bold { font-weight: 700; }

    /* Icon buttons */
    .icon-btn {
      width: 32px;
      height: 32px;
      padding: 0;
      border-radius: var(--radius-full);
      background: transparent;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
    }

    .icon-btn:hover {
      background: var(--bg-secondary);
    }

    /* === MOBILE NAVIGATION === */
    .bottom-nav {
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-primary);
      border-top: 1px solid var(--border-light);
      padding: var(--space-sm) 0;
      display: none;
      z-index: 1000;
      height: 70px;
      box-sizing: border-box;
      margin-top: auto;
      width: 100%;
      box-shadow: var(--shadow-sm);
    }

    /* Add padding to body to prevent content overlap */
    body {
      padding-bottom: 0;
    }

    /* Add padding on mobile */
    @media (max-width: 768px) {
      body {
        padding-bottom: 0;
      }
    }

    .bottom-nav-items {
      display: flex;
      justify-content: space-around;
      align-items: center;
      max-width: 400px;
      margin: 0 auto;
    }

    .bottom-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-xs);
      padding: var(--space-sm);
      border-radius: var(--radius-md);
      text-decoration: none;
      color: var(--text-secondary);
      transition: all 0.2s;
      min-width: 60px;
    }

    .bottom-nav-item.active {
      color: var(--primary);
      background: rgba(53, 134, 255, 0.1);
    }

    .bottom-nav-item img {
      width: 20px;
      height: 20px;
      filter: invert(40%); /* Cinza escuro no tema claro */
      transition: filter 0.3s ease;
    }

    /* Tema escuro - ícones cinza claro */
    body.dark-mode .bottom-nav-item img {
      filter: invert(70%); /* Cinza claro no tema escuro */
    }

    .bottom-nav-item.active img {
      filter: invert(0%) sepia(100%) saturate(10000%) hue-rotate(200deg) brightness(1); /* Azul para ativo */
    }

    .bottom-nav-item span {
      font-size: var(--font-size-xs);
      font-weight: 500;
    }

    /* === RESPONSIVE DESIGN === */
    @media (max-width: 768px) {
      .bottom-nav {
        display: block;
      }

      .container {
        padding-bottom: 20px !important;
      }

      .task-form-row {
        flex-direction: column;
        align-items: stretch;
      }

      .btn-full-mobile {
        width: 100%;
      }

      .grid-responsive {
        grid-template-columns: 1fr;
      }

      .hide-mobile {
        display: none;
      }

      .card {
        padding: var(--space-lg);
      }

      .form-input,
      .form-select {
        font-size: var(--font-size-md); /* Prevent zoom on iOS */
      }
    }

    @media (min-width: 769px) {
      .show-mobile-only {
        display: none;
      }
    }
    
    /* --- NOVO ESTILO PARA O BOTÃO DE EDITAR AGENDAMENTO --- */
    .edit-schedule-btn {
        background: #00BCD4; /* Ciano */
        border: none;
        cursor: pointer;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        padding: 0;
        display: inline-flex;
        justify-content: center;
        align-items: center;
        font-size: 14px;
        line-height: 1;
        flex-shrink: 0;
        margin-right: 5px;
        vertical-align: middle;
        transition: background 0.2s;
    }
    .edit-schedule-btn:hover {
        background: #0097A7;
    }
    body.dark-mode .edit-schedule-btn {
        background: #26C6DA;
    }
     body.dark-mode .edit-schedule-btn:hover {
        background: #00ACC1;
    }
    /* --- FIM DO NOVO ESTILO --- */

    /* --- NOVO ESTILO PARA ÍCONES NOS BOTÕES DE LISTAS --- */
    .delete-list-circular-btn img {
        width: 14px;
        height: 14px;
        filter: brightness(0) invert(1);
    }

    .edit-item-btn img,
    .delete-item-btn img,
    .edit-list-btn img {
        width: 14px;
        height: 14px;
        filter: brightness(0) invert(0.35);
        transition: filter 0.3s ease;
    }

    /* ------------------------------------------------ */
    /* ESTILOS TEMA CLARO (Padrão) - CORES VIVAS */
    /* ------------------------------------------------ */
    body {
      font-family: Arial, sans-serif;
      background: #F0F2F5;
      color: #333;
      height: 100vh;
      margin: 0;
      transition: background 0.3s, color 0.3s;
      text-transform: lowercase;
    }
    
    /* ---------------------------------------------------- */
    /* --- PADRONIZAÇÃO DOS BOTÕES DE EDITAR E EXCLUIR --- */
    /* ---------------------------------------------------- */

    /* ESTILO BASE PARA TEMA CLARO (BOTÕES QUADRADOS E REDONDOS) */
    .edit-btn, .delete-btn,
    .edit-task-btn, .task-list-item button,
    .edit-item-btn, .delete-item-btn,
    .edit-list-btn, .delete-list-circular-btn {
     background-color: #f5f5f5; 
     border: none;
     transition: background-color 0.2s, border-color 0.2s;
    }

    /* EFEITO HOVER PARA TEMA CLARO (BOTÕES QUADRADOS E REDONDOS) */
    .edit-btn:hover, .delete-btn:hover,
    .edit-task-btn:hover, .task-list-item button:hover,
    .edit-item-btn:hover, .delete-item-btn:hover,
    .edit-list-btn:hover, .delete-list-circular-btn:hover {
        background-color: #e5e5e5;
    }

    /* ÍCONE ESCURO PARA TEMA CLARO */
    .edit-task-btn img, .task-list-item button img {
        filter: invert(25%);
    }

    /* TEMA ESCURO: Botões quadrados e redondos com fundo da página e borda clara */
    body.dark-mode .edit-btn, body.dark-mode .delete-btn,
    body.dark-mode .edit-task-btn, body.dark-mode .task-list-item button,
    body.dark-mode .edit-item-btn, body.dark-mode .delete-item-btn,
    body.dark-mode .edit-list-btn, body.dark-mode .delete-list-circular-btn {
    background-color: #1F1F1F; 
    border: none; 
    }
    
    body.dark-mode .edit-btn:hover, body.dark-mode .delete-btn:hover,
    body.dark-mode .edit-task-btn:hover, body.dark-mode .task-list-item button:hover,
    body.dark-mode .edit-item-btn:hover, body.dark-mode .delete-item-btn:hover,
    body.dark-mode .edit-list-btn:hover, body.dark-mode .delete-list-circular-btn:hover {
    background-color: #282828;
    }

    #newListForm {
        display: flex;
        flex-direction: column;
        max-width: 500px;
        margin: 0 auto 30px auto;
        padding: 20px;
        padding-bottom: 60px;
        border: 1px solid #ddd;
        border-radius: 15px;
        gap: 10px;
        background: #fdfdfd;
        transition: background 0.3s, border-color 0.3s;
    }
    
    #newListForm label,
    #newListForm button[type="submit"] {
        font-size: var(--font-size-sm);
    }
    
    #planner-link-options label,
    #routine-options label,
    #list-weekly-recurrence-options label {
        font-size: var(--font-size-xs);
    }

    
    /* === CABEÇALHO SIMPLIFICADO === */
    .main-header {
        background: linear-gradient(135deg, #3586ff 0%, #6A8EFE 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(53, 134, 255, 0.3);
        position: relative;
        z-index: 1;
        padding: 15px 0;
    }
    
    .header-controls {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 10px;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
    }
    
    .header-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        width: 44px;
        height: 44px;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }
    
    .header-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
    }
    
    .header-btn img {
        width: 20px;
        height: 20px;
        filter: invert(1);
    }
    
    /* Tema escuro para o header */
    body.dark-mode .main-header {
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }
    
    .mensal-sub-toggle {
        background: #3586ff;
        border: none;
        border-radius: 8px;
        padding: 8px 15px;
        cursor: pointer;
        color: white;
        transition: 0.2s;
        text-transform: lowercase;
        font-weight: 500;
    }
    .mensal-sub-toggle:hover {
        background: #3d71ff;
    }
    .mensal-sub-toggle.active-sub {
        background: #3d71ff;
        font-weight: 600;
        color: white;
    }
    
    /* back-button styling is handled separately to keep it icon-only */

    .container {
      flex: 1;
      background: #FFFFFF;
      border-radius: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin: 20px;
      padding: 20px;
      overflow-y: auto;
      overflow-x: hidden;
      transition: background 0.3s, box-shadow 0.3s;
      max-width: 1400px;
      width: calc(100% - 40px);
      box-sizing: border-box;
    }
    h1, h2, h3 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
      text-transform: lowercase;
      transition: color 0.3s;
      font-weight: 600;
    }
    
    form#expense-form {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }
    @media (min-width: 600px) {
        form#expense-form {
             grid-template-columns: 2fr 1fr 1fr 1fr auto;
        }
    }

    input, select, button {
      padding: 8px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 14px;
      font-weight: 500;
      text-transform: lowercase;
      transition: background 0.3s, border-color 0.3s, color 0.3s;
    }
    
    .add-btn-group {
        display: flex;
        gap: 5px;
    }
    .add-btn-group button {
        flex-grow: 1;
    }
    
    button.add-btn {
      background: #3586ff;
      border: none;
      cursor: pointer;
      color: white;
      transition: 0.2s;
    }
    button.add-btn:hover {
      background: #3d71ff;
    }
    button.add-btn[type="submit"]:not(.add-btn) {
        background: #4CAF50;
        color: white;
    }
    
    #manage-categories-btn, #manage-categories-btn-budgets {
        background: #9E9E9E;
        color: white;
        border: none;
        padding: 8px;
        border-radius: 10px;
        cursor: pointer;
        text-align: center;
        transition: background 0.2s;
        display: inline-flex;
        justify-content: center;
        align-items: center;
        gap: 5px;
        min-width: 40px;
        height: 40px;
    }
    #manage-categories-btn:hover, #manage-categories-btn-budgets:hover {
        background: #757575;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      text-transform: lowercase;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }
    th {
      background: #E0F2F7;
      color: #333;
      transition: background 0.3s, color 0.3s;
    }
    tr:hover {
      background: #F5F5F5;
    }
    .total {
      text-align: right;
      font-weight: bold;
      margin-top: 10px;
      color: #333;
      transition: color 0.3s;
    }
    .delete-btn, .edit-btn {
      cursor: pointer;
      margin: 0 2px;
      display: inline-flex;
      justify-content: center;
      align-items: center;
    }

    #manage-categories-btn img, #manage-categories-btn-budgets img {
        width: 16px;
        height: 16px;
        filter: brightness(0) invert(1);
    }
    
    .edit-btn img,
    .delete-btn img {
        width: 16px;
        height: 16px;
        filter: brightness(0) invert(0.35);
        transition: filter 0.3s ease;
    }
    
    #charts-dual-container {
        display: flex;
        flex-direction: column;
        gap: 40px;
        margin-top: 30px;
        align-items: center;
    }
    
    #month-chart-container {
      width: 100%;
      max-width: 400px;
      min-width: 300px;
    }
    
    #annual-chart-container {
        width: 100%;
        max-width: 600px;
        min-width: 400px;
    }

    .summary-card {
        background: #f9f9f9;
        padding: 15px;
        border-radius: 12px;
        text-align: center;
        flex: 1;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .summary-card h4 {
        margin: 0 0 10px 0;
        font-size: 14px;
        color: #666;
        text-transform: lowercase;
        font-weight: 600;
    }
    .summary-card p {
        margin: 0;
        font-weight: 500;
    }
    #fab-add-expense {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: #3586ff;
        color: white;
        font-size: 28px;
        line-height: 56px;
        text-align: center;
        border: none;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        cursor: pointer;
        z-index: 1001;
        display: none;
    }

    .lists-container {
      display: none; /* Inicialmente escondido, será mostrado apenas na aba de listas */
      flex-direction: column;
      gap: 20px;
      align-items: stretch;
      position: relative;
      z-index: 10;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
    }
    .list {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 100%;
      transition: opacity 0.3s ease, background 0.3s, border-color 0.3s;
      flex-shrink: 0;
      border-left: 5px solid transparent;
    }
    
    .list .list-title-container {
      gap: 10px;
    }
    .list-title-icon {
        width: 28px;
        height: 28px;
        flex-shrink: 0;
        cursor: pointer; /* Para indicar que é clicável */
    }
    .list-title-container h2 {
        flex-grow: 1;
        text-align: left;
        font-size: 14px;
    }
    .change-list-icon-btn {
        background: #FFC107;
        border: none;
        cursor: pointer;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        padding: 0;
        display: inline-flex;
        justify-content: center;
        align-items: center;
        font-size: 14px;
        line-height: 1;
        flex-shrink: 0;
        margin-right: 5px;
        vertical-align: middle;
        transition: background 0.2s;
    }
    .change-list-icon-btn:hover {
        background: #FFA000;
    }
    body.dark-mode .change-list-icon-btn {
        background: #FFCA28;
    }
    body.dark-mode .change-list-icon-btn:hover {
        background: #FFB300;
    }
    
    .list-input-group {
        display: flex;
        gap: 5px;
        margin-bottom: 10px;
    }
    .list-input-group input {
        flex-grow: 1;
        margin-bottom: 0;
        font-size: 14px;
    }

    .list.completed {
        opacity: 0.6;
    }

    .list-priority-select {
        width: 100%;
        padding: 5px;
        margin: 5px 0 10px 0;
        border-radius: 5px;
        border: 1px solid #ccc;
        background-color: #f9f9f9;
        font-size: var(--font-size-sm);
    }

    .list.priority-baixa { border-left-color: #3586ff; }
    .list.priority-media { border-left-color: #FFC107; }
    .list.priority-alta { border-left-color: #FF5252; }
    
    .list ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid #eee;
    }
    
    .list li:last-child {
      border-bottom: none;
    }

    .list-item-content {
      display: flex;
      align-items: center;
      flex-grow: 1;
      gap: 8px;
      min-width: 0; /* Prevents overflow */
    }

    .list-item-content span {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 14px;
    }
    
    .list-item-value {
        color: #888;
        font-size: var(--font-size-xs);
        margin-left: auto;
        padding-left: 10px; /* Espaçamento do texto */
        flex-shrink: 0; /* Não encolher */
    }

    .list-item-content span,
    .list-item-content input[type="text"] {
      flex-grow: 1;
      border: 1px solid transparent;
      padding: 2px 4px;
      font-size: 14px;
    }
    
    .list-item-content input[type="text"] {
      border-color: #ccc;
    }

    .list-item-value-input {
      width: 45px;
      font-size: var(--font-size-xs);
      text-align: right;
      border-color: #ccc;
      padding: 2px 4px;
    }

    .list-item-actions {
      display: flex;
      flex-shrink: 0;
    }

    .list-item-actions button {
      font-size: var(--font-size-xs);
      margin-left: 4px;
    }
    
    .edit-list-btn,
    .delete-list-circular-btn {
        width: 24px;
        height: 24px;
        padding: 0;
        border-radius: 50%;
        display: inline-flex;
        justify-content: center;
        align-items: center;
        min-width: 24px;
        min-height: 24px;
    }

    /* === CLEANED UP ICON BUTTONS === */
    .save-item-btn,
    .cancel-item-btn {
        width: 24px;
        height: 24px;
        background: #EEEEEE;
        border: none;
        cursor: pointer;
        border-radius: 50%;
        padding: 0;
        display: inline-flex;
        justify-content: center;
        align-items: center;
        transition: background 0.2s;
    }

    .save-item-btn:hover,
    .cancel-item-btn:hover {
        background: #E0E0E0;
    }

    .save-item-btn img,
    .cancel-item-btn img,
    .delete-list-circular-btn img {
        width: 14px;
        height: 14px;
    }

    .save-item-btn img {
        filter: invert(48%) sepia(71%) saturate(415%) hue-rotate(75deg) brightness(95%) contrast(84%); /* Verde #4CAF50 */
    }

    .cancel-item-btn img,
    .delete-list-circular-btn img {
        filter: invert(41%) sepia(97%) saturate(1451%) hue-rotate(325deg) brightness(99%) contrast(106%); /* Vermelho #FF5252 */
    }

    /* --- ESTILO PARA BOTÕES DE EDITAR/EXCLUIR META --- */
    .edit-goal-form .edit-btn,
    .edit-goal-form .delete-btn {
        color: #BDBDBD; /* Cor do texto igual à da borda */
    }


    /* === CALENDAR OPTIMIZATION === */
    #planner-section {
      max-width: none !important;
      width: 100vw !important;
      margin-left: calc(-50vw + 50%) !important;
      margin-right: calc(-50vw + 50%) !important;
      padding: 0 var(--space-lg) !important;
      box-sizing: border-box;
    }

    #calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      max-width: 100%;
      width: 100%;
      box-sizing: border-box;
      align-items: start;
    }

    .calendar-day {
      background: var(--bg-primary);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      padding: var(--space-lg) var(--space-sm) var(--space-sm) var(--space-sm);
      min-height: 180px;
      text-align: left;
      vertical-align: top;
      transition: background 0.2s, border-color 0.3s;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      width: 100%;
      box-sizing: border-box;
    }

    .calendar-day:hover:not(.inactive) {
      background: var(--bg-secondary);
    }

    .calendar-day.inactive {
      background: var(--bg-tertiary);
      color: var(--text-muted);
      border: 1px dashed var(--border-light);
      cursor: default;
    }

    .calendar-day-number {
      font-size: var(--font-size-sm);
      font-weight: normal;
      color: var(--text-muted);
      display: block;
      margin: 0;
      transition: color 0.3s;
      position: absolute;
      top: var(--space-xs);
      right: var(--space-sm);
      z-index: 1;
    }

    .calendar-day-name {
      text-align: center;
      font-weight: 600;
      padding: var(--space-md) 0;
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
      text-transform: lowercase;
      font-size: var(--font-size-sm);
      transition: background 0.3s;
    }

    .calendar-task-icons {
      display: flex;
      flex-wrap: wrap;
      gap: 3px;
      margin-top: var(--space-md);
      margin-left: 3px;
      margin-right: 3px;
      justify-content: flex-start;
      align-items: flex-start;
      width: calc(100% - 6px);
      box-sizing: border-box;
    }

    .task-icon-grid-view {
      width: 16px;
      height: 16px;
      object-fit: contain;
      border-radius: var(--radius-sm);
      transition: transform 0.2s;
    }

    .task-icon-grid-view:hover {
      transform: scale(1.1);
    }
    .task-icon-grid-view {
      width: 18px;
      height: 18px;
      border-radius: 3px;
      border: 1px solid transparent;
      padding: 1px;
      box-sizing: border-box;
    }
    .task-icon-grid-view.priority-icon-alta { border-color: #FF5252; }

    /* Modal styles removed - now using sections instead */
    
    .details-flex-container {
        display: flex;
        gap: 20px;
        margin-top: 20px;
        align-items: flex-start;
    }
    .details-table-container {
        flex: 3;
        min-width: 0;
    }
    @media (max-width: 900px) {
        .details-flex-container {
            flex-direction: column;
        }
        
        #charts-dual-container {
            gap: 30px;
        }
        
        #month-chart-container {
            max-width: 350px;
            min-width: 280px;
        }
        
        #annual-chart-container {
            max-width: 500px;
            min-width: 350px;
        }
    }

    .task-actions {
        display: flex;
        gap: 5px;
    }
    
    .task-actions button {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .task-actions button img {
        width: 14px;
        height: 14px;
        filter: brightness(0) invert(0.35);
        transition: filter 0.3s ease;
    }

    .edit-task-btn {
        padding: 5px 8px;
        cursor: pointer;
    }

    .task-list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid #eee;
      transition: border-color 0.3s;
      border-left: 4px solid transparent;
    }
    .task-list-item[data-list-id]:hover {
        background: #f0f0f0;
    }
    .task-list-item.priority-alta { border-left-color: #FF5252; }

    .task-list-item button {
      padding: 5px 8px;
      cursor: pointer;
    }
    
    .task-icon {
        width: 16px;
        height: 16px;
        vertical-align: middle;
        margin-right: 8px;
    }
    
    .task-icon-option {
        width: 40px;
        height: 40px;
        border: 2px solid #ccc;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        padding: 5px;
        background: #f0f0f0;
    }

    #taskIconPicker .task-icon-option:first-child,
    #list-event-icon-picker .task-icon-option:first-child {
        font-size: var(--font-size-xs);
        line-height: 1;
        text-align: center;
        font-weight: bold;
        color: #777;
    }
    
    .task-icon-option.selected {
        border-color: #3586ff;
        box-shadow: 0 0 5px rgba(53, 134, 255, 0.5);
        transform: scale(1.05);
        background: #e8f0fe;
    }


    .task-icon-option:hover {
        opacity: 0.8;
    }

    .task-icon-option img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
    
    /* === FILTROS DE COR PARA ÍCONES SVG === */
    .icon-color-blue, .task-icon-option img[data-color="blue"] {
        filter: brightness(0) saturate(100%) invert(48%) sepia(79%) saturate(2476%) hue-rotate(197deg) brightness(103%) contrast(101%);
    }
    
    .icon-color-green, .task-icon-option img[data-color="green"] {
        filter: brightness(0) saturate(100%) invert(64%) sepia(57%) saturate(441%) hue-rotate(75deg) brightness(94%) contrast(89%);
    }
    
    .icon-color-red, .task-icon-option img[data-color="red"] {
        filter: brightness(0) saturate(100%) invert(33%) sepia(93%) saturate(1537%) hue-rotate(339deg) brightness(99%) contrast(96%);
    }
    
    .icon-color-yellow, .task-icon-option img[data-color="yellow"] {
        filter: brightness(0) saturate(100%) invert(92%) sepia(95%) saturate(2430%) hue-rotate(330deg) brightness(102%) contrast(104%);
    }
    
    .icon-color-purple, .task-icon-option img[data-color="purple"] {
        filter: brightness(0) saturate(100%) invert(21%) sepia(97%) saturate(3283%) hue-rotate(281deg) brightness(89%) contrast(90%);
    }
    
    .icon-color-pink, .task-icon-option img[data-color="pink"] {
        filter: brightness(0) saturate(100%) invert(51%) sepia(96%) saturate(4217%) hue-rotate(300deg) brightness(102%) contrast(101%);
    }
    
    .icon-color-orange, .task-icon-option img[data-color="orange"] {
        filter: brightness(0) saturate(100%) invert(64%) sepia(90%) saturate(1488%) hue-rotate(357deg) brightness(101%) contrast(103%);
    }

    /* --- ESTILOS PARA SELETORES DE COR --- */
    .color-option {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: 2px solid #ccc;
        cursor: pointer;
        transition: transform 0.2s, border-color 0.2s;
        display: block;
        margin: 2px;
    }

    .color-option:hover {
        transform: scale(1.1);
        border-color: #333;
    }

    .color-option.selected {
        border-color: #333 !important;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        transform: scale(1.1);
    }

    /* Tema escuro para seletores de cor */
    body.dark-mode .color-option {
        border-color: #555;
    }

    body.dark-mode .color-option:hover {
        border-color: #fff;
    }

    body.dark-mode .color-option.selected {
        border-color: #fff !important;
        box-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
    }
    
    #listDetailsItems {
        list-style: none;
        padding: 0;
    }
    #listDetailsItems li {
        padding: 8px 0;
        border-bottom: 1px solid #eee;
        font-size: 16px;
    }
    #modal-date-text {
        font-size: 14px;
        color: #888;
        margin-top: 10px;
        transition: color 0.3s;
    }

    #expense-category-list-container div,
    #revenue-category-list-container div {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 0;
        border-bottom: 1px solid #eee;
    }
    #expense-category-list-container div button,
    #revenue-category-list-container div button {
      font-size: var(--font-size-xs);
      padding: 3px 8px;
      margin-left: 4px;
    }
    #editing-category-input {
      flex-grow: 1;
      margin-right: 5px;
    }
    
    .progress-bar-container {
        width: 100%;
        background-color: #f1f1f1;
        border-radius: 10px;
        margin-top: 5px;
        overflow: hidden;
        cursor: pointer;
        position: relative;
        height: 20px;
    }
    
    .progress-bar {
        height: 100%;
        background-color: #4CAF50;
        transition: width 0.4s ease-in-out;
    }

    .progress-bar-text {
        position: absolute;
        width: 100%;
        left: 0;
        top: 0;
        line-height: 20px;
        text-align: center;
        font-size: var(--font-size-xs);
        font-weight: bold;
        color: white;
        mix-blend-mode: difference;
        pointer-events: none;
    }
    
    .category-icon {
        width: 24px;
        height: 24px;
        vertical-align: middle;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
    }
    .category-icon img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    /* Mobile-friendly table styles */
    @media (max-width: 768px) {
        #expense-table {
            font-size: var(--font-size-xs);
        }
        
        #expense-table th,
        #expense-table td {
            padding: 8px 4px !important;
        }
        
        .category-icon {
            width: 20px;
            height: 20px;
        }
        
        .edit-btn img,
        .delete-btn img {
            width: 14px !important;
            height: 14px !important;
        }
        
        .total {
            font-size: 16px !important;
            padding: 12px !important;
        }
    }

    #new-goal-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    .investment-goal-card {
      background: #f9f9f9;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 5px solid;
      transition: border-left-color 0.3s ease;
    }
    .goal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .goal-header h4 {
      margin: 0;
      text-align: left;
    }
    .goal-header .actions button {
      font-size: var(--font-size-xs);
      padding: 8px;
      margin-left: 5px;
    }
    .goal-details p {
      margin: 5px 0;
      font-size: 14px;
    }
    .add-contribution-form {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .add-contribution-form input {
      flex-grow: 1;
    }
    .contribution-history-list {
      list-style: none;
      padding: 0;
      margin-top: 10px;
      font-size: var(--font-size-xs);
      color: #666;
      max-height: 100px;
      overflow-y: auto;
    }
    .contribution-history-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 2px 0;
        gap: 8px;
    }
    .contribution-history-list li span {
        flex-grow: 1;
        min-width: 0;
    }
    .contribution-history-list li input {
        width: 80px;
        font-size: var(--font-size-xs);
        padding: 2px 4px;
        margin: 0 5px;
    }
     .contribution-history-list li button {
        width: 24px;
        height: 24px;
        padding: 0;
        margin-left: 3px;
     }

    .edit-goal-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .edit-goal-form .form-inputs {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 10px;
    }
    .color-picker {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .color-swatch {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      transition: transform 0.2s, border-color 0.2s;
    }
    .color-swatch:hover {
      transform: scale(1.1);
    }

    .goal-header-content {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .goal-icon {
        width: 28px;
        height: 28px;
    }
    .goal-icon-picker {
        display: flex;
        gap: 8px;
        margin-top: 10px;
        flex-wrap: wrap;
        max-height: 120px;
        overflow-y: auto;
        padding: 5px;
        border-radius: 8px;
        background-color: rgba(0,0,0,0.05);
    }

    /* --- ESTILOS PARA LISTA DE COMPRAS --- */
    .list-total {
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid #eee;
        text-align: right;
        font-weight: bold;
        font-size: 14px;
    }
    .finalize-purchase-btn {
        width: 100%;
        margin-top: 10px;
        background-color: #4CAF50;
        color: white;
    }
    .finalize-purchase-btn:hover {
        background-color: #45a049;
    }
    .list.finalized {
        opacity: 0.7;
    }
    body.dark-mode .list.finalized {
        opacity: 0.5;
    }
    .shopping-input-group {
        display: grid;
        grid-template-columns: 1fr 60px auto;
        gap: 5px;
        align-items: center;
    }
    .shopping-input-group .add-btn {
        padding: 8px 12px;
    }

    body.dark-mode .list-total {
        border-top-color: #333;
    }

    body.dark-mode {
      background: #121212;
      color: #E0E0E0;
    }
    
    body.dark-mode #theme-toggle {
        background: #616161;
    }

    body.dark-mode .container,
    body.dark-mode .calendar-day,
    body.dark-mode hr {
      background: #1F1F1F;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
      border-color: #444 !important;
    }
    
    body.dark-mode #newListForm {
        background: #282828;
        border-color: #444;
    }

    body.dark-mode .list {
      background: #1F1F1F; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }
    
    body.dark-mode .task-icon-option {
        border: 2px solid #555;
        background: #282828;
    }
    body.dark-mode .task-icon-option.selected {
        border-color: #6b9aff;
        box-shadow: 0 0 5px rgba(107, 154, 255, 0.5);
        background: #1F1F1F;
    }


    body.dark-mode #weekly-recurrence-options,
    body.dark-mode #list-weekly-recurrence-options,
    body.dark-mode #editor-weekly-recurrence-options {
        border-color: #444;
    }
    
    body.dark-mode h1,
    body.dark-mode h2,
    body.dark-mode h3,
    body.dark-mode .total {
      color: #FFFFFF;
    }
    
    body.dark-mode #modal-date-text {
        color: #aaa;
    }
    
    body.dark-mode .list.completed {
        opacity: 0.4;
    }

    body.dark-mode th {
      background: #333333;
      color: #E0E0E0;
    }

    body.dark-mode tr:hover {
      background: #282828;
    }
    
    body.dark-mode .task-list-item {
      border-bottom: 1px solid #333;
    }
    
    body.dark-mode .task-actions button img {
        filter: brightness(0) invert(0.8);
    }

    body.dark-mode .edit-item-btn img,
    body.dark-mode .delete-item-btn img,
    body.dark-mode .edit-btn img,
    body.dark-mode .delete-btn img,
    body.dark-mode .edit-list-btn img {
        filter: brightness(0) invert(0.8);
    }
    
    body.dark-mode .task-list-item[data-list-id]:hover {
        background: #282828;
    }
    
    body.dark-mode #listDetailsItems li {
        border-bottom: 1px solid #333;
    }
    
    body.dark-mode .list-item-value {
        color: #aaa;
    }

    body.dark-mode input,
    body.dark-mode select,
    /* Removed modal-content styles */
    body.dark-mode .list input[type="text"],
    body.dark-mode .list-item-value-input,
    body.dark-mode button:not(.add-btn):not(.delete-btn):not(.edit-btn):not(#theme-toggle):not(.mensal-sub-toggle):not(.back-button):not(.delete-list-circular-btn):not(.edit-task-btn):not(.task-list-item button):not(.edit-item-btn):not(.delete-item-btn):not(.edit-list-btn):not(.save-item-btn):not(.cancel-item-btn):not(.close-button) {
      background: #282828;
      border: 1px solid #555;
      color: #E0E0E0;
    }
    
    body.dark-mode .list-priority-select {
        background: #282828;
        border: 1px solid #555;
        color: #E0E0E0;
    }
    body.dark-mode .list.priority-baixa { border-left-color: #6b9aff; }
    body.dark-mode .list.priority-media { border-left-color: #FFCA28; }
    body.dark-mode .list.priority-alta { border-left-color: #FF1744; }
    
    body.dark-mode .task-list-item.priority-alta { border-left-color: #FF1744; }
    body.dark-mode .task-icon-grid-view.priority-icon-alta { border-color: #FF1744; }

    body.dark-mode .list li {
      border-bottom: 1px solid #333;
    }
    body.dark-mode .list-item-content input[type="text"] {
      border-color: #555;
      background-color: #333;
      color: #E0E0E0;
    }
    
    body.dark-mode button.add-btn {
        background: #6b9aff;
        color: white;
    }
    body.dark-mode button.add-btn:hover {
        background: #558bff;
    }

    body.dark-mode .mensal-sub-toggle,
    body.dark-mode .back-button {
        background: #6b9aff;
        color: white;
    }
    body.dark-mode .mensal-sub-toggle.active-sub {
        background: #558bff;
        color: white;
    }
    
    body.dark-mode .back-button {
        background: transparent !important;
        color: inherit;
    }
    body.dark-mode .back-button:hover {
        background: transparent !important;
    }
    
    body.dark-mode #manage-categories-btn, body.dark-mode #manage-categories-btn-budgets {
        background: #616161;
        color: white;
    }
    body.dark-mode #manage-categories-btn:hover, body.dark-mode #manage-categories-btn-budgets:hover {
        background: #424242;
    }
    
    body.dark-mode .calendar-day-name {
      background: #333333;
      color: #E0E0E0;
    }

    body.dark-mode .calendar-day:hover:not(.inactive) {
      background: #282828;
    }

    body.dark-mode .calendar-day.inactive {
      background: #1A1A1A;
      color: #666;
      border: 1px dashed #333;
      cursor: default;
    }

    body.dark-mode .calendar-day-number {
      color: #666;
    }
    
    /* Removed modal-content dark mode styles */

    body.dark-mode .summary-card {
        background: #282828;
        border: 1px solid #333;
    }
    body.dark-mode .summary-card h4 {
        color: #aaa;
    }
    body.dark-mode #fab-add-expense {
        background: #6b9aff;
    }

    body.dark-mode .investment-goal-card {
      background: #282828;
    }
    
    /* Garantir que apenas uma seção mensal esteja visível por vez */
    .mensal-content-section {
        display: none !important;
        position: relative;
        z-index: 1;
    }
    
    /* Garantir que a seção ativa seja visível */
    .mensal-content-section[style*="display: block"] {
        display: block !important;
    }
    body.dark-mode .contribution-history-list {
      color: #aaa;
    }
    body.dark-mode .color-swatch.selected {
      border-color: #fff;
    }
    
    body.dark-mode .close-button,
    body.dark-mode .save-item-btn,
    body.dark-mode .cancel-item-btn {
        background: #424242;
    }
    body.dark-mode .close-button:hover,
    body.dark-mode .save-item-btn:hover,
    body.dark-mode .cancel-item-btn:hover {
        background: #616161;
    }
    
    body.dark-mode .edit-goal-form .edit-btn,
    body.dark-mode .edit-goal-form .delete-btn {
        color: #9E9E9E; /* Cor do texto igual à da borda */
    }
    
    /* Removed modal dark mode styles - now using sections */
    
    /* ================================================================ */
    /* === ESTILOS PARA NOVOS BOTÕES DE ÍCONE (LISTAS) === */
    /* ================================================================ */

    /* 1. Esconde os checkboxes originais */
    #shopping-list-checkbox,
    #link-to-planner-checkbox,
    #link-as-routine-checkbox {
        display: none;
    }

    /* 2. Estiliza a base dos botões de ícone (que são as labels) */
    .icon-toggle-button {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        padding: 4px;
        border: 2px solid #ddd;
        border-radius: 7px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        background-color: #f9f9f9;
        flex-shrink: 0;
    }
    
    /* Botões específicos de lista menores */
    #shopping-list-container .icon-toggle-button,
    #link-to-planner-container .icon-toggle-button,
    #routine-container .icon-toggle-button {
        width: 18px;
        height: 18px;
        padding: 3px;
    }

    /* 3. Estiliza a imagem dentro do botão */
    .icon-toggle-button img {
        width: 100%;
        height: 100%;
        filter: grayscale(1);
        opacity: 0.6;
        transition: all 0.2s ease-in-out;
    }

    /* 4. Adiciona um efeito ao passar o mouse */
    .icon-toggle-button:hover {
        border-color: #3586ff;
        background-color: #f0f5ff;
    }

    /* 5. ESTILO QUANDO O ÍCONE ESTÁ SELECIONADO (a mágica acontece aqui) */
    /* Quando o checkbox invisível está marcado, estiliza a label dele */
    input[type="checkbox"]:checked + .icon-toggle-button {
        border-color: #3586ff;
        background-color: #e8f0fe;
    }
    input[type="checkbox"]:checked + .icon-toggle-button img {
        filter: grayscale(0);
        opacity: 1;
    }


    /* --- Ajustes para o Tema Escuro --- */
    body.dark-mode .icon-toggle-button {
        border-color: #555;
        background-color: #282828;
    }
    
    body.dark-mode .icon-toggle-button img {
        filter: invert(1) grayscale(1);
        opacity: 0.5;
    }
    body.dark-mode .icon-toggle-button:hover {
        border-color: #6b9aff;
        background-color: #1F1F1F;
    }
    body.dark-mode input[type="checkbox"]:checked + .icon-toggle-button {
        border-color: #6b9aff;
        background-color: #1F1F1F;
    }
    body.dark-mode input[type="checkbox"]:checked + .icon-toggle-button img {
        filter: invert(1) grayscale(0);
        opacity: 1;
    }

    /* ================================================================ */
    /* === ESTILO ESPECÍFICO PARA O BOTÃO DE ROTINA === */
    /* ================================================================ */

    #routine-container .icon-toggle-button {
        border-radius: 50%; /* Transforma em círculo */
        border-color: #ccc; /* Borda cinza, como solicitado */
    }

    body.dark-mode #routine-container .icon-toggle-button {
        border-color: #666;
    }
    
    /* ================================================================ */
    /* === ESTILO PARA MENSAGEM DE ROTINA COMPLETA === */
    /* ================================================================ */
    .routine-complete-message {
        text-align: center;
        font-size: var(--font-size-xs);
        font-style: italic;
        color: #4CAF50;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px dashed #ccc;
    }

    body.dark-mode .routine-complete-message {
        color: #81C784;
        border-top-color: #444;
    }

    /* ================================================================ */
    /* === ESTILO PARA BOTÃO DE DESFAZER FINALIZAÇÃO === */
    /* ================================================================ */
    .undo-finalize-btn {
        width: 100%;
        margin-top: 10px;
        background-color: #FF9800; /* Laranja */
        color: white;
        display: none; /* Começa escondido */
    }
    .undo-finalize-btn:hover {
        background-color: #FB8C00;
    }
    
    #planner-details-container, #finance-details-container {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }
     body.dark-mode #planner-details-container,
     body.dark-mode #finance-details-container {
        border-top-color: #333;
    }


    /* ================================================================ */
    /* === BLOCO DE ESTILOS PARA DISPOSITIVOS MÓVEIS (RESPONSIVO) === */
    /* ================================================================ */
    
    /* Media query para telas muito pequenas (≤480px) */
    @media (max-width: 480px) {
      .container {
        margin: 2px;
        padding: 8px;
        width: calc(100% - 4px);
        max-width: none;
      }
      
      .mensal-sub-toggle {
        padding: 8px 6px;
        font-size: var(--font-size-xs);
        min-width: 70px;
      }
      
      .calendar-day {
        padding: 10px 1px 1px 1px;
        width: 100%;
        box-sizing: border-box;
        aspect-ratio: 1 / 1.3;
      }
      
      .calendar-day-number {
        font-size: var(--font-size-sm);
        top: 1px;
        right: 3px;
      }
      
      .task-icon-grid-view {
        width: 12px;
        height: 12px;
      }
      
      .calendar-day-name {
        font-size: var(--font-size-xs);
        padding: 4px 1px;
      }
      
      input[type="text"], input[type="number"], input[type="time"], input[type="date"], select, textarea {
        padding: 10px 6px !important;
        font-size: 16px !important;
      }
      
      button, .add-btn, .edit-btn, .delete-btn {
        padding: 10px 12px !important;
        font-size: 14px !important;
        min-height: 40px !important;
      }
      
      .close-button {
        width: 32px !important;
        height: 32px !important;
        padding: 4px !important;
        border-radius: 50% !important;
      }
      
      .edit-list-btn, .delete-list-circular-btn {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 28px;
        min-height: 28px;
      }
      
      .save-item-btn, .cancel-item-btn {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .icon-toggle-button {
        width: 32px;
        height: 32px;
        padding: 4px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      #shopping-list-container .icon-toggle-button,
      #link-to-planner-container .icon-toggle-button,
      #routine-container .icon-toggle-button {
        width: 28px;
        height: 28px;
        padding: 3px;
      }
      
      .task-icon-option {
        width: 36px;
        height: 36px;
      }
      
      .color-option {
        width: 32px;
        height: 32px;
      }
      
      h1, h2, h3 {
        font-size: 20px;
        margin-bottom: 15px;
      }
      
      h4 {
        font-size: 16px;
        margin: 10px 0 8px 0;
      }
      
      /* Ajusta cabeçalho para telas muito pequenas */
      .header-controls {
        padding: 0 10px;
        gap: 6px;
      }
      
      .header-btn {
        width: 36px;
        height: 36px;
      }
      
      .header-btn img {
        width: 16px;
        height: 16px;
      }

  /* Botões da aba finanças em 12px no mobile */
  #financeiro-section .mensal-sub-toggle {
    font-size: 14px !important;
    padding: 8px 12px !important;
    line-height: 1 !important;
  }

      /* Ajuste consistente também para telas pequenas até 768px */
      #financeiro-section .mensal-sub-toggle {
        font-size: 14px !important;
        padding: 8px 12px !important;
        line-height: 1 !important;
      }
    }
    
    @media (max-width: 768px) {
    
      /* Ajusta o contêiner principal para ter menos margem em telas pequenas */
      .container {
        margin: 5px;
        padding: 10px;
        width: calc(100% - 10px);
        max-width: none;
      }
      
      /* Melhora a navegação principal */
      #mensal-controls {
        flex-direction: column;
        gap: 15px;
        margin-bottom: 15px;
      }
      
      #mensal-controls > div {
        width: 100%;
        justify-content: center;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .mensal-sub-toggle {
        flex: 1;
        min-width: 80px;
        padding: 10px 8px;
        font-size: 14px;
        text-align: center;
        white-space: nowrap;
      }
      
      /* Ajusta os dias do calendário */
      .calendar-day {
        min-height: unset;
        aspect-ratio: 1 / 1.2; 
        padding: 14px 3px 3px 3px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        width: 100%;
        box-sizing: border-box;
      }

      /* Ajusta o número do dia para mobile */
      .calendar-day-number {
        font-size: var(--font-size-xs);
        top: 2px;
        right: 4px;
      }
      
      /* Ajusta o tamanho dos ícones de tarefas para mobile */
      .task-icon-grid-view {
        width: 14px;
        height: 14px;
      }
      
      /* Ajusta o espaçamento dos ícones para mobile */
      .calendar-task-icons {
         gap: 3px;
         margin-top: 8px;
         margin-left: 2px;
         margin-right: 2px;
         align-items: flex-start;
         width: calc(100% - 4px);
         box-sizing: border-box;
      }

      /* Reduz o texto dos dias da semana para economizar espaço */
      .calendar-day-name {
        font-size: var(--font-size-xs);
        padding: 6px 2px;
      }
      
      /* Melhora formulários para mobile */
      input[type="text"], input[type="number"], input[type="time"], input[type="date"], select, textarea {
        font-size: 16px !important; /* Evita zoom no iOS */
        padding: 12px 8px !important;
        border-radius: 8px !important;
        border: 2px solid #ddd !important;
        width: 100%;
        box-sizing: border-box;
      }
      
      /* Melhora botões para mobile */
      button, .add-btn, .edit-btn, .delete-btn {
        min-height: 44px; /* Tamanho mínimo recomendado para touch */
        padding: 12px 16px;
        font-size: 16px;
        border-radius: 8px;
      }

      /* Overrides fortes para inline styles em botões no mobile (exclui botões icônicos) */
      button:not(.close-button):not(.back-button):not(.edit-list-btn):not(.delete-list-circular-btn):not(.save-item-btn):not(.cancel-item-btn):not(.icon-toggle-button),
      .add-btn, .edit-btn, .delete-btn {
        min-height: 44px !important;
        padding: 12px 16px !important;
        font-size: 16px !important;
        border-radius: 8px !important;
        max-width: 100%;
        line-height: 1.2;
      }

      /* Ajuste específico para textarea no mobile */
      textarea {
        min-height: 100px;
        line-height: 1.4;
      }

      /* Botões de salvar/cancelar icônicos maiores para toque confortável */
      .save-item-btn, .cancel-item-btn {
        width: 32px;
        height: 32px;
        min-height: unset;
        padding: 0;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      /* Mantém botões de lista redondos */
      .edit-list-btn, .delete-list-circular-btn {
        border-radius: 50% !important;
        min-height: unset;
        padding: 0;
        width: 32px;
        height: 32px;
        min-width: 32px;
        min-height: 32px;
      }
      
      /* Melhora seletores de ícones */
      .task-icon-option {
        width: 40px;
        height: 40px;
        min-width: 40px;
        min-height: 40px;
      }
      
      /* Melhora seletores de cor */
      .color-option {
        width: 36px;
        height: 36px;
        min-width: 36px;
        min-height: 36px;
      }
      
      /* Melhora tabelas */
      table {
        font-size: 14px;
        width: 100%;
      }
      
      th, td {
        padding: 8px 4px !important;
        text-align: left;
      }
      
      /* Melhora cards de investimento */
      .investment-goal-card {
        margin-bottom: 15px;
        padding: 15px;
      }
      
      /* Melhora listas */
      .list {
        margin-bottom: 15px;
        padding: 15px;
      }
      
      /* Melhora modais e seções */
      .mensal-content-section {
        padding: 15px;
      }
      
      /* Melhora botões de fechar */
      .close-button {
        width: 28px;
        height: 28px;
        padding: 4px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      /* Ajusta botão de voltar para mobile */
      .back-button {
        left: 8px !important;
        top: 8px !important;
        width: 32px !important;
        height: 32px !important;
        border-radius: 50% !important;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .back-button img {
        width: 10px;
        height: 10px;
      }
      
      .close-button img {
        width: 10px;
        height: 10px;
      }
      
      /* Melhora formulários de edição */
      .form-inputs {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      
      /* Ajusta gráficos para mobile */
      #charts-dual-container {
        gap: 25px;
      }
      
      #month-chart-container {
        max-width: 100%;
        min-width: 250px;
      }
      
      #annual-chart-container {
        max-width: 100%;
        min-width: 250px;
      }
      
      /* Centraliza listas no mobile */
      .lists-container {
        justify-content: flex-start;
        align-items: stretch;
      }
      
      .form-inputs input {
        width: 100%;
      }
      
      /* Melhora grid de formulários */
      div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
        gap: 10px !important;
      }
      
      /* Melhora flex containers */
      div[style*="display: flex"] {
        flex-wrap: wrap;
        gap: 10px;
      }

      /* Previne overflow horizontal em elementos com width inline maior que viewport */
      [style*="width:"] {
        max-width: 100% !important;
      }

      /* Garantir que inputs/botões ocupem largura disponível quando necessário */
      form input, form select, form textarea, form button {
        max-width: 100%;
      }
      
      /* Layout responsivo para mobile */
      #newListForm-main-line {
        flex-direction: column !important;
        align-items: stretch !important;
        flex-wrap: nowrap !important;
        gap: 8px !important;
      }
      
      #newListForm-main-line input {
        flex: none !important;
        min-width: auto !important;
        width: 100% !important;
        margin-bottom: 0 !important;
      }
      
      #newListForm-main-line > div {
        flex-direction: row !important;
        align-items: center !important;
        gap: 6px !important;
        margin-bottom: 0 !important;
        flex-shrink: 0 !important;
        justify-content: space-between !important;
      }
      
      #newListForm-main-line select {
        flex: 1 !important;
        margin-bottom: 0 !important;
        min-width: 120px !important;
      }
      
      /* Mantém seção de agendamento igual à versão web */
      #planner-link-options {
        flex-direction: column !important;
      }
      
      #planner-link-options > div {
        flex-direction: row !important;
        align-items: center !important;
        gap: 10px !important;
      }
      
      #planner-link-options > div > div {
        flex-direction: row !important;
        gap: 10px !important;
      }
      
      /* Melhora ícones de toggle - menores para lista de compras, agendar e rotina */
      .icon-toggle-button {
        width: 36px;
        height: 36px;
        padding: 6px;
      }
      
      /* Botões específicos de lista menores no mobile */
      #shopping-list-container .icon-toggle-button,
      #link-to-planner-container .icon-toggle-button,
      #routine-container .icon-toggle-button {
        width: 32px;
        height: 32px;
        padding: 4px;
        border-radius: 6px;
        font-size: 14px;
        min-height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }
      
      /* Containers dos botões menores no mobile */
      #shopping-list-container,
      #link-to-planner-container,
      #routine-container {
        width: auto;
        height: 32px;
        display: flex;
        align-items: center;
        margin-bottom: 0;
        flex-shrink: 0;
      }
      
      /* Melhora progress bars */
      .progress-bar-container {
        height: 24px;
      }
      
      .progress-bar-text {
        line-height: 24px;
        font-size: 14px;
      }
      
      /* Melhora espaçamento geral */
      h3, h4 {
        margin: 15px 0 10px 0;
        font-size: 18px;
      }
      
      /* Melhora labels */
      label {
        font-size: 14px;
        margin-bottom: 5px;
        display: block;
      }
      
      /* Melhora espaçamento de listas e cards */
      .list, .investment-goal-card, .task-list-item {
        margin-bottom: 12px;
        padding: 12px;
      }
      
      
      /* Ajusta cabeçalho para mobile */
      .main-header {
        padding: 12px 0;
      }
      
      .header-controls {
        padding: 0 15px;
        gap: 8px;
      }
      
      .header-btn {
        width: 40px;
        height: 40px;
      }
      
      .header-btn img {
        width: 18px;
        height: 18px;
      }
      
      /* Ajusta gaps em formulários */
      form {
        gap: 12px;
      }
      
      /* Melhora botões de ação em listas */
      .list-item-actions {
        gap: 6px;
      }
      
      .list-item-actions button {
        min-width: 32px;
        min-height: 32px;
        padding: 6px;
      }
      
      /* Melhora checkboxes */
      input[type="checkbox"] {
        width: 20px;
        height: 20px;
        margin-right: 8px;
      }
      
      /* Melhora selects */
      select {
        background-color: white;
        background-image: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        padding-right: 30px;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 8px center;
        background-size: 16px;
      }
    }

/* ================================================================ */
/* === ESTILOS PARA BOTÕES DE AGENDAMENTO NO EDITOR DE LISTAS === */
/* ================================================================ */

/* --- Estilo para o botão "Adicionar Agendamento" --- */
#add-schedule-btn {
    background: transparent;
    border: 1px solid #3586ff; /* Cor azul do tema */
    color: #3586ff;
    font-weight: bold;
}
#add-schedule-btn:hover {
    background: rgba(53, 134, 255, 0.05); /* Fundo azul bem claro no hover */
    color: #3d71ff;
}

/* --- Estilo para o botão "Remover Agendamento" --- */
#remove-schedule-btn {
    background: transparent;
    color: #BDBDBD;
    border: 2px solid #BDBDBD !important;
}
#remove-schedule-btn:hover {
    color: #9E9E9E;
    border-color: #9E9E9E !important;
}


/* --- Ajustes para o Tema Escuro --- */
body.dark-mode #add-schedule-btn {
    border-color: #6b9aff;
    color: #6b9aff;
}
body.dark-mode #add-schedule-btn:hover {
    background: rgba(107, 154, 255, 0.1); /* Fundo azul bem claro no hover */
    color: #558bff;
}

body.dark-mode #remove-schedule-btn {
    color: #9E9E9E;
    border: 2px solid #9E9E9E !important;
}
body.dark-mode #remove-schedule-btn:hover {
    color: #E0E0E0;
    border-color: #E0E0E0 !important;
}

    /* === OPTIMIZED NAVIGATION BUTTONS === */
    .close-button,
    .back-button {
      position: absolute;
      width: 32px;
      height: 32px;
      padding: 0;
      border: none;
      border-radius: var(--radius-full);
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease;
      z-index: 100;
    }

    .close-button {
      top: var(--space-md);
      right: var(--space-md);
    }

    .back-button {
      top: var(--space-md);
      left: var(--space-md);
    }

    .close-button:hover,
    .back-button:hover {
      background: var(--bg-secondary);
    }

    .close-button img,
    .back-button img {
      width: 16px;
      height: 16px;
      filter: invert(25%);
    }

    body.dark-mode .close-button img,
    body.dark-mode .back-button img {
      filter: brightness(0) invert(0.8);
    }

    /* === SPECIFIC CLOSE BUTTON OVERRIDES === */
    #close-transactions-view,
    #close-budgets-view,
    #close-investments-view,
    #close-category-section {
      background: transparent !important;
      box-shadow: none !important;
    }

    #close-transactions-view:hover,
    #close-budgets-view:hover,
    #close-investments-view:hover,
    #close-category-section:hover {
      background: var(--bg-secondary) !important;
    }

    /* === BUTTON VISIBILITY FIXES === */
    #show-add-transaction-form-btn,
    #open-add-investment-form-btn {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }

    #transaction-list-view,
    #goals-container {
      display: block !important;
    }

    #expense-table {
      width: 100%;
      border-collapse: collapse;
    }

    #expense-table td {
      padding: var(--space-md);
      border-bottom: 1px solid var(--border-light);
      vertical-align: middle;
    }

    /* === FORCE CONTAINER AND BUTTON VISIBILITY === */
    #planner-details-container,
    #finance-details-container {
      display: block !important;
    }

    #day-view-section,
    #transaction-list-view,
    #goals-container {
      display: block !important;
    }

    #day-view-section,
    #transaction-list-view {
      min-height: 400px;
      padding-bottom: 10px;
    }
    
    /* Ensure all content sections have enough bottom padding */
    .mensal-content-section {
      padding-bottom: 10px !important;
    }
    
    /* Ensure all detail views and forms have enough bottom padding */
    #planner-details-container,
    #finance-details-container,
    #transactions-view,
    #budgets-view,
    #investments-view,
    #add-transaction-container,
    #investment-form-view,
    #list-details-section,
    #task-form-view {
      padding-bottom: 10px !important;
    }

    /* === ULTRA AGGRESSIVE TASK BUTTON FORCE === */
    #open-add-task-form-btn,
    button#open-add-task-form-btn.add-btn {
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      visibility: visible !important;
      opacity: 1 !important;
      width: 100% !important;
      height: 50px !important;
      min-height: 50px !important;
      margin-top: 20px !important;
      margin-bottom: 20px !important;
      background: transparent !important;
      background-color: transparent !important;
      color: var(--primary) !important;
      border: 2px solid var(--primary) !important;
      padding: var(--space-md) !important;
      border-radius: var(--radius-md) !important;
      font-size: var(--font-size-md) !important;
      cursor: pointer !important;
      transition: all 0.2s ease !important;
      position: relative !important;
      z-index: 9999 !important;
      text-align: center !important;
    }

    #open-add-task-form-btn:hover,
    button#open-add-task-form-btn.add-btn:hover {
      background: rgba(53, 134, 255, 0.1) !important;
      background-color: rgba(53, 134, 255, 0.1) !important;
      color: var(--primary) !important;
      transform: translateY(-1px) !important;
    }

    /* Force visibility in all contexts */
    #planner-details-container #open-add-task-form-btn,
    #day-view-section #open-add-task-form-btn,
    .planner-details-container #open-add-task-form-btn,
    .day-view-section #open-add-task-form-btn {
      display: inline-flex !important;
      visibility: visible !important;
      opacity: 1 !important;
    }

    /* === TRANSACTION AND INVESTMENT BUTTONS === */
    #show-add-transaction-form-btn,
    #open-add-investment-form-btn {
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
      visibility: visible !important;
      opacity: 1 !important;
      width: 100% !important;
      height: 50px !important;
      min-height: 50px !important;
      margin-top: 20px !important;
      margin-bottom: 20px !important;
      background: transparent !important;
      color: var(--primary) !important;
      border: 2px solid var(--primary) !important;
      padding: var(--space-md) !important;
      border-radius: var(--radius-md) !important;
      font-size: var(--font-size-md) !important;
      cursor: pointer !important;
      transition: all 0.2s ease !important;
      position: relative !important;
      z-index: 9999 !important;
      text-align: center !important;
    }

    #show-add-transaction-form-btn:hover,
    #open-add-investment-form-btn:hover {
      background: rgba(53, 134, 255, 0.1) !important;
      color: var(--primary) !important;
      transform: translateY(-1px) !important;
    }

    /* Remove duplicate styles - button already styled above */


    /* Override any parent hiding */
    .mensal-content-section button,
    .planner-details-container button,
    .finance-details-container button {
      display: inline-flex !important;
      visibility: visible !important;
    }

    /* === FINANCE NAVIGATION BUTTONS === */
    #financeiro-section .mensal-sub-toggle,
    #view-details-btn,
    #view-category-spending-btn,
    #view-investments-btn {
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        background: transparent !important;
        background-color: transparent !important;
        border: 2px solid var(--primary) !important;
        color: var(--primary) !important;
        font-size: 14px !important;
        padding: 8px 12px !important;
        line-height: 1 !important;
        white-space: normal !important;
        word-break: break-word !important;
        box-sizing: border-box !important;
        min-width: 120px !important;
        transition: all 0.2s ease !important;
        border-radius: var(--radius-md) !important;
        cursor: pointer !important;
        text-align: center !important;
    }

    #financeiro-section .mensal-sub-toggle:hover,
    #view-details-btn:hover,
    #view-category-spending-btn:hover,
    #view-investments-btn:hover {
        background: rgba(53, 134, 255, 0.1) !important;
        background-color: rgba(53, 134, 255, 0.1) !important;
        border-color: var(--primary) !important;
        color: var(--primary) !important;
    }

    #financeiro-section .mensal-sub-toggle.active-sub,
    #view-details-btn.active-sub,
    #view-category-spending-btn.active-sub,
    #view-investments-btn.active-sub {
        background: var(--primary) !important;
        background-color: var(--primary) !important;
        border-color: var(--primary) !important;
        color: white !important;
    }

    #finance-dashboard-main > div:nth-of-type(2) {
        flex-wrap: wrap !important;
    }

    #total-revenue,
    #total-expense,
    #month-balance {
        font-size: 18px !important;
    }

    @media (max-width: 480px) {
        #total-revenue,
        #total-expense,
        #month-balance {
            font-size: 16px !important;
        }
        #financeiro-section .mensal-sub-toggle {
            font-size: 13px !important;
            padding: 8px 12px !important;
            min-width: 110px !important;
        }
    }

  </style>
  <script src="./js/chart.js"></script>
</head>
<body>
  
  <!-- Cabeçalho Simplificado -->
  <header class="main-header">
    <div class="header-controls">
      <button id="theme-toggle" class="header-btn theme-btn"><img src="buttons/moon.svg" alt="Modo escuro" id="theme-icon"></button>
      <button id="settings-btn" class="header-btn settings-btn"><img src="buttons/settings.svg" alt="Configurações"></button>
    </div>
  </header>

  <div class="container">
    
    <div id="mensal-page">

        <div id="mensal-controls" style="display: flex; justify-content: center; align-items: center; margin-bottom: 20px;">
            <select id="calendar-month-select" style="padding: 8px; border-radius: 8px; text-transform: lowercase; font-size: 14px; border-color: #6A8EFE; min-width: 120px;"></select>
        </div>
        
        <hr style="border-top: 1px solid #ddd; margin: 30px 0;">


        <div id="planner-section" class="mensal-content-section">
            <div id="calendar-grid"></div>

            <div id="planner-details-container" style="display: none;">
                
                <div id="day-view-section" style="display: none; position: relative;">
                    <button class="close-button" id="close-day-view-btn" style="top: 0; right: 0;"><img src="buttons/close.svg" alt="Fechar"></button>
                    <h3 id="day-view-title" style="text-align: center; margin-top: 0;"></h3>
                    <div id="tasksList"></div>
                    <button id="open-add-task-form-btn" class="add-btn" style="width: 100%; margin-top: 20px;">adicionar tarefa</button>
                </div>

                <div id="task-form-view" style="display: none; position: relative;">
                    <button class="close-button back-button" id="back-to-day-view-btn" style="right: auto; left: 15px; top: 15px;"><img src="buttons/back.svg" alt="Voltar"></button>
                    <h3 id="task-form-title">adicionar tarefa</h3>
                    <form id="task-form-modal">
                        <div class="task-form-row" style="margin-top: 30px;">
                            <input type="time" id="taskTime" value="09:00" class="task-form-input" style="padding: 8px; border-radius: 6px; border: 1px solid #ddd; font-size: 14px;">
                            <input type="text" id="taskDescription" placeholder="descrição da tarefa" required class="task-form-input" style="padding: 8px; border-radius: 6px; border: 1px solid #ddd; font-size: 14px;">
                        </div>
                        <div style="margin: 10px 0; display: flex; align-items: center;">
                            <input type="checkbox" id="taskPriority" style="width: 18px; height: 18px; margin-right: 8px; cursor: pointer;">
                            <label for="taskPriority" style="font-size: 14px; font-weight: bold; color: #FF5252; cursor: pointer;">tarefa prioritária</label>
                        </div>
                        <div id="task-icon-picker-container" style="padding: 5px 0 15px 0;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ícone:</label>
                            <div id="taskIconPicker" style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
                            <input type="hidden" id="taskIcon" value="">
                            
                            <div id="task-color-picker-container" style="margin-top: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">cor:</label>
                                <div id="taskColorPicker" style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <div class="color-option selected" data-color="blue" style="width: 30px; height: 30px; border-radius: 50%; background-color: #3586ff; border: 2px solid #333; cursor: pointer;"></div>
                                    <div class="color-option" data-color="green" style="width: 30px; height: 30px; border-radius: 50%; background-color: #4caf50; border: 2px solid #ccc; cursor: pointer;"></div>
                                    <div class="color-option" data-color="red" style="width: 30px; height: 30px; border-radius: 50%; background-color: #f44336; border: 2px solid #ccc; cursor: pointer;"></div>
                                    <div class="color-option" data-color="yellow" style="width: 30px; height: 30px; border-radius: 50%; background-color: #ffeb3b; border: 2px solid #ccc; cursor: pointer;"></div>
                                    <div class="color-option" data-color="purple" style="width: 30px; height: 30px; border-radius: 50%; background-color: #9c27b0; border: 2px solid #ccc; cursor: pointer;"></div>
                                    <div class="color-option" data-color="pink" style="width: 30px; height: 30px; border-radius: 50%; background-color: #ff66cc; border: 2px solid #ccc; cursor: pointer;"></div>
                                    <div class="color-option" data-color="orange" style="width: 30px; height: 30px; border-radius: 50%; background-color: #ff9800; border: 2px solid #ccc; cursor: pointer;"></div>
                                </div>
                                <input type="hidden" id="taskIconColor" value="blue">
                            </div>
                        </div>
                        <div id="recurrence-options" style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; align-items: center;">
                            <select id="recurrenceType">
                                <option value="none">não repetir</option>
                                <option value="daily">diariamente</option>
                                <option value="weekly">semanalmente</option>
                            </select>
                            <input type="date" id="recurrenceEndDate" title="data final da recorrência" style="display:none;">
                        </div>
                        <div id="weekly-recurrence-options" style="display: none; margin-bottom: 10px; padding: 10px; border: 1px solid #eee; border-radius: 8px;">
                            <label style="display: block; margin-bottom: 5px; font-size: var(--font-size-sm); font-weight: bold;">repetir nos dias:</label>
                            <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 5px; font-size: 14px;">
                                <label><input type="checkbox" name="weekday" value="0"> dom</label>
                                <label><input type="checkbox" name="weekday" value="1"> seg</label>
                                <label><input type="checkbox" name="weekday" value="2"> ter</label>
                                <label><input type="checkbox" name="weekday" value="3"> qua</label>
                                <label><input type="checkbox" name="weekday" value="4"> qui</label>
                                <label><input type="checkbox" name="weekday" value="5"> sex</label>
                                <label><input type="checkbox" name="weekday" value="6"> sáb</label>
                            </div>
                        </div>
                        <div id="task-form-submit-container" style="margin-top: 20px; display: flex; justify-content: flex-end;">
                            <button type="submit" id="add-task-btn" style="padding: 10px 16px; border-radius: 6px; font-size: 14px;">adicionar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        

        <div id="financeiro-section" class="mensal-content-section" style="display: none;">
            
            <div id="finance-dashboard-main">
                <div id="summary-container" style="display: flex; justify-content: space-around; gap: 15px; margin-bottom: 30px; flex-wrap: wrap;">
                    <div class="summary-card">
                        <h4>receitas do mês</h4>
                        <p id="total-revenue" style="color: #4CAF50; font-size: 24px; font-weight: bold;">R$ 0,00</p>
                    </div>
                    <div class="summary-card">
                        <h4>despesas do mês</h4>
                        <p id="total-expense" style="color: #FF5252; font-size: 24px; font-weight: bold;">R$ 0,00</p>
                    </div>
                    <div class="summary-card">
                        <h4>saldo do mês</h4>
                        <p id="month-balance" style="font-size: 24px; font-weight: bold;">R$ 0,00</p>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px; margin-bottom: 20px; display: flex; justify-content: center; gap: 10px;">
                    <button id="view-details-btn" class="mensal-sub-toggle">transações</button>
                    <button id="view-category-spending-btn" class="mensal-sub-toggle">orçamentos</button>
                    <button id="view-investments-btn" class="mensal-sub-toggle">investimentos</button>
                </div>

                <div id="charts-dual-container">
                    <div id="month-chart-container">
                        <h3 style="text-align: center; margin-top: 0;">gastos por categoria</h3>
                        <canvas id="month-chart"></canvas>
                    </div>
                    <div id="annual-chart-container">
                        <h3 style="text-align: center; margin-top: 0;">comparativo anual</h3>
                        <canvas id="annual-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <div id="finance-details-container">
                <div id="transactions-view" style="display: none; position: relative; padding-top: 15px; z-index: 5;">
                    <button class="close-button" id="close-transactions-view"><img src="buttons/close.svg" alt="Fechar"></button>
                    
                    <div id="transaction-list-view">
                        <h3 style="margin-top:0;">transações do mês</h3>
                        <div class="details-table-container" style="margin-top: 20px;">
                            <table id="expense-table" style="width: 100%; border-collapse: collapse;">
                                <tbody id="expense-list"></tbody>
                            </table>
                        </div>
                        <button id="show-add-transaction-form-btn" class="btn btn-primary btn-full" style="margin-top: 20px;">adicionar transação</button>
                    </div>
    
                    <div id="add-transaction-container" style="display: none; position: relative; z-index: 5;">
                        <button class="close-button back-button" id="back-to-transactions-list-btn"><img src="buttons/back.svg" alt="Voltar"></button>
                        
                        <h3 id="transaction-form-title" style="margin-top: 0;">adicionar transação</h3>
                        <form id="expense-form" style="margin-top: 30px; display: flex; flex-direction: column; gap: 15px;">
                            <input type="text" id="desc" placeholder="descrição" required style="padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 16px;">
                            <select id="type" style="padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 16px;">
                                <option value="despesa">despesa</option>
                                <option value="receita">receita</option>
                            </select>
                            <select id="category" placeholder="categoria" style="padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 16px;"></select>
                            <input type="number" id="value" placeholder="r$" step="0.01" required style="padding: 12px; border-radius: 8px; border: 2px solid #ddd; font-size: 16px;">
                            <div class="add-btn-group">
                                <button type="submit" class="add-btn" id="submit-expense-btn" style="padding: 12px 16px; font-size: 16px; min-height: 44px;">adicionar</button>
                            </div>
                        </form>
                    </div>
                </div>
    
                <div id="budgets-view" style="display: none; position: relative; padding-top: 15px; z-index: 5;">
                    <button class="close-button" id="close-budgets-view"><img src="buttons/close.svg" alt="Fechar"></button>
                    <h3 style="margin-top:0;">orçamentos</h3>
                    <form id="category-limit-form" style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <select id="categoryLimitCategory" required></select>
                        <input type="number" id="categoryLimitValue" placeholder="limite (R$)" step="0.01" required>
                        <button type="submit" class="add-btn">salvar limite</button>
                        <button type="button" id="manage-categories-btn-budgets"><img src="buttons/settings.svg" alt="Gerenciar"></button>
                    </form>
                    <table style="width: 100%;">
                        <tbody id="category-spending-list"></tbody>
                    </table>
                </div>
    
                <div id="investments-view" style="display: none; position: relative; padding-top: 15px; z-index: 5;">
                    <button class="close-button" id="close-investments-view"><img src="buttons/close.svg" alt="Fechar"></button>
                    <h3 style="margin-top:0;">investimentos</h3>
                    
                    <!-- Lista de metas existentes -->
                    <div id="goals-container"></div>
                    
                    <!-- Botão para adicionar nova meta -->
                    <button id="open-add-investment-form-btn" class="btn btn-primary btn-full" style="margin-top: 20px;">adicionar investimento</button>
                    
                    <!-- Formulário de nova meta (escondido inicialmente) -->
                    <div id="investment-form-view" style="display: none; position: relative;">
                        <button class="close-button back-button" id="back-to-investments-list-btn" style="right: auto; left: 15px; top: 15px;"><img src="buttons/back.svg" alt="Voltar"></button>
                        <h3 id="investment-form-title" style="margin-top: 0;">adicionar meta de investimento</h3>
                        
                        <form id="new-goal-form" style="display: flex; flex-direction: column; gap: 10px; margin-top: 30px;">
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                            <input type="text" id="newGoalName" placeholder="nome da nova meta" required style="padding: 8px; border-radius: 6px; border: 1px solid #ddd; font-size: 14px;">
                            <input type="number" id="newGoalTarget" placeholder="valor da meta (r$)" step="0.01" required style="padding: 8px; border-radius: 6px; border: 1px solid #ddd; font-size: 14px;">
                        </div>
                        
                        <!-- Seletor de Ícone e Cor -->
                        <div id="goal-icon-picker-container" style="padding: 5px 0 15px 0;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ícone:</label>
                            <div id="goalIconPicker" style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
                            <input type="hidden" id="goalIcon" value="">
                            
                            <div id="goal-color-picker-container" style="margin-top: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">cor:</label>
                                <div id="goalColorPicker" style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <div class="color-option" data-color="red" style="background-color: #f44336;"></div>
                                    <div class="color-option" data-color="blue" style="background-color: #3586ff;"></div>
                                    <div class="color-option" data-color="green" style="background-color: #4caf50;"></div>
                                    <div class="color-option" data-color="yellow" style="background-color: #ffeb3b;"></div>
                                    <div class="color-option" data-color="purple" style="background-color: #9c27b0;"></div>
                                    <div class="color-option" data-color="pink" style="background-color: #ff66cc;"></div>
                                    <div class="color-option" data-color="orange" style="background-color: #ff9800;"></div>
                                </div>
                                <input type="hidden" id="goalColor" value="blue">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; align-items: center;">
                             <input type="number" id="newGoalInterestRate" placeholder="juros mensais (%)" step="0.01">
                            <div style="text-align: right;">
                                <input type="checkbox" id="newGoalHasDeadline" style="width: auto; vertical-align: middle;">
                                <label for="newGoalHasDeadline" style="font-size: var(--font-size-sm); vertical-align: middle; cursor: pointer;">definir prazo</label>
                            </div>
                        </div>
                        <input type="date" id="newGoalDeadline" style="display: none;">
                        <button type="submit" class="add-btn">criar meta</button>
                        </form>
                    </div>
                </div>

                <!-- Seção de Gerenciamento de Categorias -->
                <div id="category-section" style="display: none; position: relative; padding-top: 15px; z-index: 5;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <button class="close-button back-button" id="back-from-categories" style="position: relative; left: 0; top: 0;"><img src="buttons/back.svg" alt="Voltar"></button>
                        <button class="close-button" id="close-category-section"><img src="buttons/close.svg" alt="Fechar"></button>
                    </div>
                    <h3 style="margin-top:0;">gerenciar categorias</h3>

                    <!-- Formulário de Adicionar Categoria -->
                    <div id="add-category-form" style="display: none; gap: 10px; margin-bottom: 20px; align-items: center;">
                        <select id="newCategoryType" style="padding: 8px; border-radius: 10px; border: 1px solid #ccc;">
                            <option value="despesa">despesa</option>
                            <option value="receita">receita</option>
                        </select>
                        <input type="text" id="newCategoryName" placeholder="nome da nova categoria" style="flex-grow: 1;">
                        <button id="addCategoryButton" class="add-btn">adicionar</button>
                    </div>

                    <!-- Formulário de Editar Categoria -->
                    <div id="edit-category-form" style="display: none; margin-bottom: 20px; padding: 15px; border: 2px solid #3586ff; border-radius: 10px; background: var(--secondary-bg);">
                        <h4 style="margin: 0 0 15px 0; color: #3586ff;">editando categoria</h4>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                            <select id="editCategoryType" style="padding: 8px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color);">
                                <option value="despesa">despesa</option>
                                <option value="receita">receita</option>
                            </select>
                            <input type="text" id="editCategoryName" placeholder="nome da categoria" style="flex-grow: 1; padding: 8px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color);">
                            <button id="saveCategoryButton" class="add-btn" style="background: #4CAF50;">salvar</button>
                            <button id="cancelEditButton" class="add-btn" style="background: #9E9E9E;">cancelar</button>
                        </div>
                    </div>

                    <!-- Seletor de Ícone e Cor para Categorias -->
                    <div id="category-icon-picker-container" style="display: none; padding: 15px 0; border: 1px solid var(--border-color); border-radius: 10px; margin-bottom: 20px; background: var(--secondary-bg);">
                        <label style="display: block; margin-bottom: 10px; font-weight: bold; color: var(--text-color);">ícone da categoria:</label>
                        <div id="categoryIconPicker" style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px;"></div>
                        <input type="hidden" id="categoryIcon" value="">
                        
                        <p style="font-size: var(--font-size-xs); color: #888; margin-top: 10px; text-align: center;">
                            💡 A cor do ícone é definida automaticamente pelo nome da categoria
                        </p>
                        
                        <!-- Seletor de cor oculto (cor baseada no nome da categoria) -->
                        <div style="display: none;">
                            <div id="categoryColorPicker"></div>
                            <input type="hidden" id="categoryIconColor" value="blue">
                        </div>
                    </div>

                    <h4>categorias de despesa</h4>
                    <div id="expense-category-list-container"></div>

                    <hr style="border-top: 1px solid #ddd; margin: 15px 0;">

                    <h4>categorias de receita</h4>
                    <div id="revenue-category-list-container"></div>
                </div>
            </div>

        </div>

        <div id="listas-section" class="mensal-content-section" style="display: none;">
            <form id="newListForm">
                <div id="newListForm-main-line" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <input type="text" id="newListName" placeholder="nome da nova lista" required style="flex-grow: 1; min-width: 200px; padding: 8px; border-radius: 6px; border: 1px solid #ddd; font-size: var(--font-size-md);">
                    
                    <div style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                        <select id="newListPriority" style="text-transform: none; padding: 8px; border-radius: 6px; border: 1px solid #ddd; font-size: var(--font-size-md);">
                            <option value="baixa">prioridade: baixa</option>
                            <option value="media">prioridade: média</option>
                            <option value="alta">prioridade: alta</option>
                        </select>

                        <div id="shopping-list-container" title="Marcar como lista de compras">
                            <input type="checkbox" id="shopping-list-checkbox">
                            <label for="shopping-list-checkbox" class="icon-toggle-button">
                                <img src="buttons/lists/compras.svg" alt="Lista de Compras">
                            </label>
                        </div>
                        
                        <div id="link-to-planner-container" title="Agendar no planner">
                            <input type="checkbox" id="link-to-planner-checkbox">
                            <label for="link-to-planner-checkbox" class="icon-toggle-button">
                                <img src="buttons/lists/agendar.svg" alt="Agendar no Planner">
                            </label>
                        </div>
                    </div>
                </div>

                <div id="planner-link-options" style="display: none; flex-direction: column; gap: 10px; margin-top: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; flex-grow: 1;">
                            <input type="date" id="list-event-date">
                            <input type="time" id="list-event-time" value="10:00">
                        </div>
                        
                        <div id="routine-container" title="Marcar como rotina" style="display: none;">
                             <input type="checkbox" id="link-as-routine-checkbox">
                             <label for="link-as-routine-checkbox" class="icon-toggle-button">
                                 <img src="buttons/lists/rotina.svg" alt="Marcar como Rotina">
                             </label>
                        </div>
                    </div>

                    <div id="routine-options" style="display: none; flex-direction: column; gap: 10px; margin-top: 5px;">
                        <select id="list-recurrence-type">
                            <option value="none">não repetir</option>
                            <option value="daily">diariamente</option>
                            <option value="weekly">semanalmente</option>
                        </select>
                        <input type="date" id="list-recurrence-end-date" title="data final da recorrência" style="display: none;">
                        <div id="list-weekly-recurrence-options" style="display: none; margin-top: 5px; padding: 10px; border: 1px solid #eee; border-radius: 8px;">
                            <label style="display: block; margin-bottom: 5px; font-size: var(--font-size-sm); font-weight: bold;">repetir nos dias:</label>
                            <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 5px; font-size: var(--font-size-xs);">
                                <label><input type="checkbox" name="list-weekday" value="0"> dom</label>
                                <label><input type="checkbox" name="list-weekday" value="1"> seg</label>
                                <label><input type="checkbox" name="list-weekday" value="2"> ter</label>
                                <label><input type="checkbox" name="list-weekday" value="3"> qua</label>
                                <label><input type="checkbox" name="list-weekday" value="4"> qui</label>
                                <label><input type="checkbox" name="list-weekday" value="5"> sex</label>
                                <label><input type="checkbox" name="list-weekday" value="6"> sáb</label>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit" style="width: 100%; margin-top: 15px;">criar lista</button>
            </form>

            <hr style="border-top: 1px solid #ddd; margin: 30px 0;">

            <div class="lists-container" id="listsContainer"></div>
        </div>

    </div>
    </div>

  
  <!-- Seção de Detalhes de Tarefa -->
  <div id="description-section" class="mensal-content-section" style="display: none;">
    <div style="padding: 20px; max-width: 500px; margin: 0 auto;">
      <button class="close-button back-button" onclick="closeDescriptionSection()" style="position: relative; top: 0; left: 0; margin-bottom: 15px;"><img src="buttons/back.svg" alt="Voltar"></button>
      <h3 style="margin-top: 0; text-align: center; color: var(--text-color, #333); font-size: 24px; font-weight: 600;">detalhes</h3>
      <div style="background: var(--secondary-bg, #f8f9fa); border-radius: 12px; padding: 20px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div style="text-align: center;">
          <p id="modal-description-text" style="font-size: 18px; margin: 15px 0; line-height: 1.6; color: var(--text-color, #333); font-weight: 500;"></p>
          <p id="modal-date-text" style="font-size: 16px; margin: 10px 0; line-height: 1.5; color: var(--text-color-secondary, #666);"></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Seção de Detalhes de Lista -->
  <div id="list-details-section" class="mensal-content-section" style="display: none;">
    <div style="padding: 20px;">
      <button class="close-button back-button" onclick="closeListDetailsSection()" style="position: relative; top: 0; left: 0; margin-bottom: 10px;"><img src="buttons/back.svg" alt="Voltar"></button>
      <h3 id="listDetailsTitle" style="margin-top: 0;"></h3>
      <ul id="listDetailsItems"></ul>
    </div>
  </div>

  <!-- Seção de Escolha de Ícone da Lista -->
  <div id="list-icon-section" class="mensal-content-section" style="display: none;">
    <div style="padding: 20px; max-width: 500px; margin: 0 auto;">
        <button class="close-button back-button" onclick="closeListIconSection()"><img src="buttons/back.svg" alt="Voltar"></button>
        <h3>escolha um ícone para a lista</h3>
        
        <!-- Seletor de Ícone -->
        <div style="margin-top: 20px;">
            <label style="display: block; margin-bottom: 10px; font-weight: bold;">ícone:</label>
            <div id="list-icon-picker-grid" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; max-height: 300px; overflow-y: auto;">
            </div>
        </div>
        
        <!-- Seletor de Cor (oculto - cor baseada em prioridade) -->
        <div style="display: none;">
            <div id="list-color-picker"></div>
            <input type="hidden" id="listColor" value="blue">
        </div>
    </div>
  </div>

  <!-- Seção de Editor de Lista -->
  <div id="list-editor-section" class="mensal-content-section" style="display: none;">
    <div style="padding: 20px; padding-bottom: 80px; max-width: 450px; margin: 0 auto;">
        <button class="close-button back-button" onclick="closeListEditorSection()"><img src="buttons/back.svg" alt="Voltar"></button>
        <h3>Editar Lista</h3>
        <form id="list-editor-form" style="display: flex; flex-direction: column; gap: 15px; margin-top: 15px;">
            <input type="hidden" id="editor-list-id-main">

            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Nome da Lista:</label>
                <input type="text" id="editor-list-name" required style="width: 100%; box-sizing: border-box;">
            </div>

            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Prioridade (define a cor do ícone):</label>
                <select id="editor-list-priority" style="width: 100%; padding: 8px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #ccc; font-size: var(--font-size-md);">
                    <option value="baixa">Baixa (Azul)</option>
                    <option value="media">Média (Amarelo)</option>
                    <option value="alta">Alta (Vermelho)</option>
                </select>
                
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Ícone da Lista:</label>
                <div id="editor-list-icon-picker" style="display: flex; flex-wrap: wrap; gap: 8px; max-height: 140px; overflow-y: auto; padding: 5px; border-radius: 8px; background: rgba(0,0,0,0.05);"></div>
                <input type="hidden" id="editor-list-icon-main">
                
                <!-- Seletor de Cor oculto (cor baseada em prioridade) -->
                <div style="display: none;">
                    <div id="editor-list-color-picker"></div>
                    <input type="hidden" id="editor-list-color-main" value="blue">
                </div>
            </div>

            <hr>

            <button type="button" id="add-schedule-btn" class="add-btn" style="width: 100%;">Adicionar Agendamento</button>

            <div id="editor-scheduling-section" style="display: none;">
                <h4 style="margin-top: 0; margin-bottom: 10px;">Agendamento no Planner</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <input type="date" id="editor-event-date">
                    <input type="time" id="editor-event-time">
                </div>
                 <div id="editor-routine-container" style="display: flex; align-items: center; gap: 8px; font-size: 14px; padding-left: 5px; cursor: pointer; margin-top: 5px;">
                     <input type="checkbox" id="editor-link-as-routine-checkbox" style="width: 18px; height: 18px; cursor: pointer;">
                     <label for="editor-link-as-routine-checkbox" style="cursor: pointer;">marcar como rotina</label>
                </div>
                <div id="editor-routine-options" style="display: none; flex-direction: column; gap: 10px; margin-top: 10px;">
                    <select id="editor-recurrence-type" style="width: 100%;">
                        <option value="none">não repetir</option>
                        <option value="daily">diariamente</option>
                        <option value="weekly">semanalmente</option>
                    </select>
                    <input type="date" id="editor-recurrence-end-date" title="data final da recorrência" style="display: none; width: 100%; box-sizing: border-box;">
                    <div id="editor-weekly-recurrence-options" style="display: none; margin-top: 5px; padding: 10px; border: 1px solid #eee; border-radius: 8px;">
                        <label style="display: block; margin-bottom: 5px; font-size: var(--font-size-sm); font-weight: bold;">repetir nos dias:</label>
                        <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 5px; font-size: 14px;">
                            <label><input type="checkbox" name="editor-weekday" value="0"> dom</label>
                            <label><input type="checkbox" name="editor-weekday" value="1"> seg</label>
                            <label><input type="checkbox" name="editor-weekday" value="2"> ter</label>
                            <label><input type="checkbox" name="editor-weekday" value="3"> qua</label>
                            <label><input type="checkbox" name="editor-weekday" value="4"> qui</label>
                            <label><input type="checkbox" name="editor-weekday" value="5"> sex</label>
                            <label><input type="checkbox" name="editor-weekday" value="6"> sáb</label>
                        </div>
                    </div>
                </div>
                <button type="button" id="remove-schedule-btn" class="delete-btn" style="width: 100%; margin-top: 15px;">Remover Agendamento</button>
            </div>

            <button type="submit" class="add-btn" style="background-color: #4CAF50; width: 100%; margin-top: 10px;">Salvar Alterações</button>
        </form>
    </div>
  </div>
  
  <script>
    // --- ELEMENTOS DO FORMULÁRIO FINANCEIRO
    const form = document.getElementById('expense-form');
    const expenseList = document.getElementById('expense-list');
    const totalEl = document.getElementById('total');
    const descInput = document.getElementById('desc');
    const categoryInput = document.getElementById('category');
    const typeInput = document.getElementById('type');
    const valueInput = document.getElementById('value');
    const submitButton = document.getElementById('submit-expense-btn');
    const buttonGroup = document.querySelector('.add-btn-group');
    const showAddTransactionBtn = document.getElementById('show-add-transaction-form-btn');
    const addTransactionContainer = document.getElementById('add-transaction-container');
    const transactionFormTitle = document.getElementById('transaction-form-title');
    const transactionListView = document.getElementById('transaction-list-view');
    const backToTransactionsListBtn = document.getElementById('back-to-transactions-list-btn');
    
    // --- ELEMENTOS DE GERENCIAMENTO DE CATEGORIAS ---
    const manageCategoriesBtnBudgets = document.getElementById('manage-categories-btn-budgets');
    const categorySection = document.getElementById('category-section');
    const newCategoryNameInput = document.getElementById('newCategoryName');
    const addCategoryButton = document.getElementById('addCategoryButton');
    const newCategoryTypeInput = document.getElementById('newCategoryType');
    const categoryIconPicker = document.getElementById('categoryIconPicker');
    const categoryIconHiddenInput = document.getElementById('categoryIcon');
    const categoryIconColorInput = document.getElementById('categoryIconColor');
    const categoryColorPicker = document.getElementById('categoryColorPicker');
    const goalColorPicker = document.getElementById('goalColorPicker');
    const listColorPicker = document.getElementById('list-color-picker');
    const goalColor = document.getElementById('goalColor');
    const listColor = document.getElementById('listColor');
    
    // Elementos do formulário de edição
    const addCategoryForm = document.getElementById('add-category-form');
    const editCategoryForm = document.getElementById('edit-category-form');
    const editCategoryNameInput = document.getElementById('editCategoryName');
    const editCategoryTypeInput = document.getElementById('editCategoryType');
    const saveCategoryButton = document.getElementById('saveCategoryButton');
    const cancelEditButton = document.getElementById('cancelEditButton');
    
    // --- ELEMENTOS DO DASHBOARD E SUB-VIEWS FINANCEIRAS ---
    const financeDashboardMain = document.getElementById('finance-dashboard-main');
    const transactionsView = document.getElementById('transactions-view');
    const closeTransactionsViewBtn = document.getElementById('close-transactions-view');
    const viewDetailsBtn = document.getElementById('view-details-btn');
    const viewCategorySpendingBtn = document.getElementById('view-category-spending-btn');
    const viewInvestmentsBtn = document.getElementById('view-investments-btn');
    const descriptionSection = document.getElementById('description-section'); 

    // --- ELEMENTOS DE ORÇAMENTOS (BUDGETS) ---
    const categoryLimitForm = document.getElementById('category-limit-form');
    const budgetsView = document.getElementById('budgets-view');
    const closeBudgetsViewBtn = document.getElementById('close-budgets-view');
    
    // --- ELEMENTOS DE INVESTIMENTOS ---
    const newGoalForm = document.getElementById('new-goal-form');
    const goalsContainer = document.getElementById('goals-container');
    const newGoalHasDeadlineCheckbox = document.getElementById('newGoalHasDeadline');
    const newGoalDeadlineInput = document.getElementById('newGoalDeadline');
    const investmentsView = document.getElementById('investments-view');
    const closeInvestmentsViewBtn = document.getElementById('close-investments-view');
    const goalIconPicker = document.getElementById('goalIconPicker');
    const goalIconHiddenInput = document.getElementById('goalIcon');
    const openAddInvestmentFormBtn = document.getElementById('open-add-investment-form-btn');
    const investmentFormView = document.getElementById('investment-form-view');
    const backToInvestmentsListBtn = document.getElementById('back-to-investments-list-btn');
    const investmentFormTitle = document.getElementById('investment-form-title');


    // --- ELEMENTOS DO CABEÇALHO ---
    const themeToggle = document.getElementById('theme-toggle');
    const settingsBtn = document.getElementById('settings-btn');
    
    // --- ELEMENTOS DO CALENDÁRIO E SUAS VIEWS ---
    const calendarGrid = document.getElementById('calendar-grid');
    const calendarMonthSelect = document.getElementById('calendar-month-select');
    const plannerDetailsContainer = document.getElementById('planner-details-container');
    
    const dayViewSection = document.getElementById('day-view-section');
    const dayViewTitle = document.getElementById('day-view-title');
    const taskFormView = document.getElementById('task-form-view');
    const tasksList = document.getElementById('tasksList');
    const openAddTaskFormBtn = document.getElementById('open-add-task-form-btn');
    const closeDayViewBtn = document.getElementById('close-day-view-btn');
    const backToDayViewBtn = document.getElementById('back-to-day-view-btn');
    
    // --- ELEMENTOS DO FORMULÁRIO DE TAREFAS (agora em uma view) ---
    const taskFormModal = document.getElementById('task-form-modal'); // Mantido para o form
    const taskFormTitle = document.getElementById('task-form-title');
    const taskTimeInput = document.getElementById('taskTime');
    const taskDescriptionInput = document.getElementById('taskDescription');
    const taskIconHiddenInput = document.getElementById('taskIcon');
    const taskIconPicker = document.getElementById('taskIconPicker');
    const taskIconColorInput = document.getElementById('taskIconColor');
    const taskColorPicker = document.getElementById('taskColorPicker');
    const addTaskBtn = document.getElementById('add-task-btn');
    const taskPriorityInput = document.getElementById('taskPriority'); 
    const recurrenceTypeInput = document.getElementById('recurrenceType');
    const recurrenceEndDateInput = document.getElementById('recurrenceEndDate');
    const weeklyRecurrenceOptions = document.getElementById('weekly-recurrence-options');
    
    // --- ELEMENTOS DE LISTAS ---
    const listsContainer = document.getElementById("listsContainer");
    const newListForm = document.getElementById('newListForm');
    const newListNameInput = document.getElementById("newListName");
    const newListPriorityInput = document.getElementById("newListPriority");
    const shoppingListContainer = document.getElementById('shopping-list-container');
    const linkToPlannerContainer = document.getElementById('link-to-planner-container');
    const linkToPlannerCheckbox = document.getElementById('link-to-planner-checkbox');
    const plannerLinkOptions = document.getElementById('planner-link-options');
    const listEventDateInput = document.getElementById('list-event-date');
    const listEventTimeInput = document.getElementById('list-event-time');
    const routineContainer = document.getElementById('routine-container');
    const linkAsRoutineCheckbox = document.getElementById('link-as-routine-checkbox');
    const routineOptions = document.getElementById('routine-options');
    const listRecurrenceTypeInput = document.getElementById('list-recurrence-type');
    const listRecurrenceEndDateInput = document.getElementById('list-recurrence-end-date');
    const listWeeklyRecurrenceOptions = document.getElementById('list-weekly-recurrence-options');
    const listDetailsSection = document.getElementById('list-details-section');
    const listDetailsTitle = document.getElementById('listDetailsTitle');
    const listDetailsItems = document.getElementById('listDetailsItems');
    const shoppingListCheckbox = document.getElementById('shopping-list-checkbox');
    
    // --- ELEMENTOS DO MODAL DE ÍCONE DE LISTA ---
    const listIconSection = document.getElementById('list-icon-section');
    const listIconPickerGrid = document.getElementById('list-icon-picker-grid');

    // --- ELEMENTOS DO NOVO MODAL DE EDIÇÃO DE LISTA ---
    const listEditorSection = document.getElementById('list-editor-section');
    const listEditorForm = document.getElementById('list-editor-form');
    const editorListIdInput = document.getElementById('editor-list-id-main');
    const editorListNameInput = document.getElementById('editor-list-name');
    const editorListPriorityInput = document.getElementById('editor-list-priority');
    const editorListIconPicker = document.getElementById('editor-list-icon-picker');
    const editorListIconInput = document.getElementById('editor-list-icon-main');
    const addScheduleBtn = document.getElementById('add-schedule-btn');
    const editorSchedulingSection = document.getElementById('editor-scheduling-section');
    const editorEventDateInput = document.getElementById('editor-event-date');
    const editorEventTimeInput = document.getElementById('editor-event-time');
    const removeScheduleBtn = document.getElementById('remove-schedule-btn');
    const editorRoutineContainer = document.getElementById('editor-routine-container');
    const editorLinkAsRoutineCheckbox = document.getElementById('editor-link-as-routine-checkbox');
    const editorRoutineOptions = document.getElementById('editor-routine-options');
    const editorRecurrenceTypeInput = document.getElementById('editor-recurrence-type');
    const editorRecurrenceEndDateInput = document.getElementById('editor-recurrence-end-date');
    const editorWeeklyRecurrenceOptions = document.getElementById('editor-weekly-recurrence-options');


    // --- ÍCONES DE TAREFAS (USADOS TAMBÉM PARA LISTAS) ---
    const taskIcons = {
        // === ÍCONES CIRCULARES/BÁSICOS ===
        "nenhum": "./images/circledashed.svg", "lista": "./images/circledashed.svg", "coração": "./images/heart.svg", "estrela": "./images/star.svg", "dinheiro": "./images/money.svg",
        
        // === SAÚDE E BEM-ESTAR ===
        "médico": "./images/health.svg", "medicação": "./images/pills.svg", "dentista": "./images/tooth.svg", "escova": "./images/hairbrush.svg", 
        "injeção": "./images/injection.svg", "unhas": "./images/nails.svg", "pele": "./images/body.svg", "meditação": "./images/meditation.svg",
        
        // === ESPORTES E ATIVIDADES ===
        "exercício": "./images/gym.svg", "esportes": "./images/football.svg",
        
        // === TRABALHO E ESTUDO ===
        "trabalho": "./images/work.svg", "estudo": "./images/study.svg", "pessoas": "./images/people.svg", "computador": "./images/computer.svg",
        "escrever": "./images/write.svg",
        
        // === CASA E FAMÍLIA ===
        "casa": "./images/house.svg", "pet": "./images/pet.svg", "presente": "./images/gift.svg",
        "aniversário": "./images/birthday.svg", "festa": "./images/party.svg",
        
        // === TRANSPORTE E VIAGEM ===
        "viagem": "./images/plane.svg", "férias": "./images/vacation.svg",
        
        // === COMIDA E BEBIDA ===
        "comida": "./images/burger.svg", "maçã": "./images/apple.svg", "cenoura": "./images/carrot.svg", "sorvete": "./images/icecream.svg",
        "pipoca": "./images/popcorn.svg", "cogumelo": "./images/mushroom.svg",
        
        // === ENTRETENIMENTO E LAZER ===
        "mídia": "./images/picture.svg", "música": "./images/music.svg",
        
        // === NATUREZA E PLANTAS ===
        "flor": "./images/flower.svg", "planta": "./images/plant.svg", "lesma": "./images/snail.svg",
        
        // === COMPRAS E FINANÇAS ===
        "compras": "./images/shopping.svg", "comprar": "./images/buy.svg", "assinaturas": "./images/infinite.svg",
        
        // === ROUPAS E ACESSÓRIOS ===
        "camisa": "./images/shirt.svg", "caixa": "./images/box.svg",
        
        // === OUTROS/VARIADOS ===
        "cigarro": "./images/cigarette.svg", "olho": "./images/eye.svg", "arma": "./images/gun.svg"
    };

    const supportedIconColors = ['blue', 'green', 'red', 'yellow', 'purple', 'pink', 'orange'];

    const iconColorHexMap = {
        blue: '#3586ff',
        green: '#4caf50',
        red: '#f44336',
        yellow: '#ffeb3b',
        purple: '#9c27b0',
        pink: '#ff66cc',
        orange: '#ff9800'
    };

    const hexToIconColorMap = Object.fromEntries(
        Object.entries(iconColorHexMap).map(([name, hex]) => [hex.toLowerCase(), name])
    );

    const hexColorAliases = {
        '#ff5252': 'red',
        '#ff1744': 'red',
        '#ffc107': 'yellow',
        '#ffca28': 'yellow',
        '#6b9aff': 'blue',
        '#3d71ff': 'blue',
        '#45a049': 'green',
        '#26c6da': 'blue',
        '#00acc1': 'blue'
    };

    Object.assign(hexToIconColorMap, hexColorAliases);

    function getColorHexFromName(colorName) {
        if (!colorName) return iconColorHexMap.blue;
        const normalized = colorName.toLowerCase();
        return iconColorHexMap[normalized] || iconColorHexMap.blue;
    }

    function getColorNameFromValue(colorValue) {
        if (!colorValue) return 'blue';
        const normalized = colorValue.toString().trim().toLowerCase();

        if (iconColorHexMap[normalized]) {
            return normalized;
        }

        if (hexToIconColorMap[normalized]) {
            return hexToIconColorMap[normalized];
        }

        const rgbMatch = normalized.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)$/);
        if (rgbMatch) {
            const [r, g, b] = rgbMatch.slice(1, 4).map(Number);
            const hex = '#' + [r, g, b]
                .map(value => value.toString(16).padStart(2, '0'))
                .join('');
            return hexToIconColorMap[hex] || 'blue';
        }

        return 'blue';
    }

    function normalizeGoalColorData(goal) {
        if (!goal) return false;
        const colorName = getColorNameFromValue(goal.colorName || goal.color);
        const colorHex = getColorHexFromName(colorName);
        let changed = false;

        if (goal.color !== colorHex) {
            goal.color = colorHex;
            changed = true;
        }
        if (goal.colorName !== colorName) {
            goal.colorName = colorName;
            changed = true;
        }
        return changed;
    }

    function sanitizeIconPath(iconSrc) {
        if (!iconSrc) return '';
        const withoutQuery = iconSrc.split('?')[0];
        const imagesIndex = withoutQuery.indexOf('/images/');
        if (imagesIndex !== -1) {
            return '.' + withoutQuery.substring(imagesIndex);
        }
        const relativeIndex = withoutQuery.indexOf('images/');
        if (relativeIndex !== -1) {
            const path = withoutQuery.substring(relativeIndex);
            return path.startsWith('./') ? path : `./${path}`;
        }
        if (withoutQuery.startsWith('/')) {
            return `.${withoutQuery}`;
        }
        return withoutQuery.startsWith('./') ? withoutQuery : `./${withoutQuery}`;
    }

    function normalizeListData(list) {
        if (!list) return false;
        let changed = false;
        let inferredColorName = null;

        if (list.icon && list.icon.includes('images/colored/')) {
            inferredColorName = getIconColorFromPath(list.icon);
            const fileName = list.icon.split('/').pop();
            const iconName = fileName.replace('.svg', '');
            const newIconName = legacyIconNameMap[iconName] || iconName;
            const newIconPath = `./images/${newIconName}.svg`;
            if (list.icon !== newIconPath) {
                list.icon = newIconPath;
                changed = true;
            }
        }

        const sanitizedIcon = sanitizeIconPath(list.icon || '');
        if (sanitizedIcon && sanitizedIcon !== list.icon) {
            list.icon = sanitizedIcon;
            changed = true;
        }

        if (!list.icon) {
            list.icon = sanitizeIconPath(taskIcons.lista || taskIcons.nenhum || './images/circledashed.svg');
            changed = true;
        }

        const resolvedColorName = getColorNameFromValue(list.colorName || list.color || inferredColorName);
        const resolvedColorHex = getColorHexFromName(resolvedColorName);

        if (list.color !== resolvedColorHex) {
            list.color = resolvedColorHex;
            changed = true;
        }

        if (list.colorName !== resolvedColorName) {
            list.colorName = resolvedColorName;
            changed = true;
        }

        return changed;
    }

    const iconFileNameToKeyMap = Object.entries(taskIcons).reduce((map, [key, path]) => {
        if (!path) return map;
        const cleanPath = path.split('?')[0];
        const fileName = cleanPath.substring(cleanPath.lastIndexOf('/') + 1).replace('.svg', '');
        if (!map[fileName]) {
            map[fileName] = key;
        }
        return map;
    }, {});

    const legacyIconNameMap = {
        'none': 'circledashed', 'hair': 'hairbrush', 'lotion': 'body',
        'fute': 'football', 'ping': 'football', 'voleyball': 'football',
        'brain': 'study', 'car': 'plane', 'trip': 'plane', 'food': 'burger',
        'movie': 'picture', 'art': 'picture', 'leaf': 'plant', 'slug': 'snail',
        'list': 'shopping', 'assinatura': 'infinite', 'phone': 'computer',
        'date': 'circledashed', 'person': 'people', 'meeting': 'people',
        'toothbrush': 'hairbrush', 'dna': 'health', 'judge': 'people'
    };

    // --- ÍCONES DE CATEGORIA (MAPEAMENTO NOME -> CAMINHO) ---
    const categoryIcons = {
        // === CATEGORIAS BÁSICAS ===
        "outros": "./images/star.svg", "saúde": "./images/health.svg", "educação": "./images/study.svg",
        
        // === FINANÇAS ===
        "comida": "./images/burger.svg", "compras": "./images/shopping.svg", "dinheiro": "./images/money.svg", "salário": "./images/money.svg", "assinaturas": "./images/infinite.svg",
        "freela": "./images/work.svg",
        
        // === CASA E FAMÍLIA ===
        "moradia": "./images/house.svg", "pet": "./images/pet.svg", "presente": "./images/gift.svg",
        
        // === TRANSPORTE E VIAGEM ===
        "transporte": "./images/plane.svg",
        
        // === ENTRETENIMENTO E LAZER ===
        "lazer": "./images/picture.svg", "beleza": "./images/hairbrush.svg",
        
        // === SAÚDE E BEM-ESTAR ===
        "injeção": "./images/injection.svg",
        
        // === NATUREZA E PLANTAS ===
        "folha": "./images/plant.svg", "lesma": "./images/snail.svg",
        
        // === OUTROS/VARIADOS ===
        "olho": "./images/eye.svg", "pessoas": "./images/people.svg"
    };


    // --- VARIÁVEIS DE ESTADO ---
    let monthChart, annualChart;
    let dataByMonth = {};
    let revenueCategories = ["salário", "freela", "outros"];
    let expenseCategories = [
        {
            name: "alimentação",
            icon: "./images/burger.svg",
            color: "red"
        },
        {
            name: "lazer",
            icon: "./images/picture.svg",
            color: "purple"
        },
        {
            name: "moradia",
            icon: "./images/house.svg",
            color: "blue"
        },
        {
            name: "transporte",
            icon: "./images/plane.svg",
            color: "blue"
        },
        {
            name: "saúde",
            icon: "./images/health.svg",
            color: "green"
        },
        {
            name: "educação",
            icon: "./images/study.svg",
            color: "red"
        },
        {
            name: "assinaturas",
            icon: "./images/infinite.svg",
            color: "blue"
        },
        {
            name: "compras",
            icon: "./images/shopping.svg",
            color: "orange"
        },
        {
            name: "beleza",
            icon: "./images/nails.svg",
            color: "pink"
        }
    ];
    let investmentGoals = [];
    let editingGoalId = null;
    let editingContributionKey = null;

    const disallowedCategoryNames = new Set(["jogos", "esportes", "pizza", "bebidas"]);

    function sanitizeCategoryList(list) {
        return list.filter(category => {
            const categoryName = typeof category === 'string' ? category : category.name;
            return !disallowedCategoryNames.has(categoryName);
        });
    }

    function sanitizeAllCategories() {
        expenseCategories = sanitizeCategoryList(expenseCategories);
        revenueCategories = sanitizeCategoryList(revenueCategories);
    }

    sanitizeAllCategories();
    
    // --- NAVEGAÇÃO ENTRE SEÇÕES ---
    let previousSection = 'planner-section'; // Seção padrão
    let editingCategoryId = null;
    let currentMonth = null;
    let currentCalendarDate = new Date();
    let selectedDateKey = null, editingIndex = null;
    let calendarTasks = {};
    const monthNamesPt = ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"];
    const goalColors = ['#FF5252', '#3F51B5', '#4CAF50', '#FFC107', '#9C27B0', '#00BCD4', '#FF9800'];
    let currentListIconBeingEdited = null;
    let categoryLimits = {};


    // ----------------------------------------------------
    // FUNÇÕES DE UTILIDADE E TEMA
    // ----------------------------------------------------
    
    // Função para converter prioridade em cor
    function getPriorityColor(priority, darkMode = false) {
        if (darkMode) {
            const colors = {
                'baixa': '#6b9aff',
                'media': '#FFCA28',
                'alta': '#FF1744'
            };
            return colors[priority] || '#6b9aff';
        } else {
            const colors = {
                'baixa': '#3586ff',
                'media': '#FFC107',
                'alta': '#FF5252'
            };
            return colors[priority] || '#3586ff';
        }
    }
    
    // Função para converter cor em nome de cor para ícone
    function getColorNameFromPriority(priority) {
        const colorNames = {
            'baixa': 'blue',
            'media': 'yellow',
            'alta': 'red'
        };
        return colorNames[priority] || 'blue';
    }
    
    // Função para obter cor pré-definida baseada no nome da categoria
    function getCategoryColor(categoryName) {
        const name = categoryName.toLowerCase();
        
        // Mapeamento de categorias para cores
        if (name.includes('aliment') || name.includes('comida') || name.includes('restaur') || name.includes('lanche')) {
            return 'orange'; // Laranja
        } else if (name.includes('transport') || name.includes('uber') || name.includes('carro') || name.includes('gasolina')) {
            return 'blue'; // Azul
        } else if (name.includes('saúde') || name.includes('médico') || name.includes('farmá') || name.includes('hospital')) {
            return 'green'; // Verde
        } else if (name.includes('lazer') || name.includes('entretenimento') || name.includes('cinema') || name.includes('festa') || name.includes('diversão')) {
            return 'purple'; // Roxo
        } else if (name.includes('moradia') || name.includes('casa') || name.includes('aluguel') || name.includes('água') || name.includes('luz') || name.includes('energia')) {
            return 'blue'; // Azul
        } else if (name.includes('educação') || name.includes('estudo') || name.includes('curso') || name.includes('escola') || name.includes('faculdade')) {
            return 'blue'; // Azul
        } else if (name.includes('compra') || name.includes('shopping') || name.includes('roupa') || name.includes('vestuário')) {
            return 'pink'; // Rosa
        } else if (name.includes('salário') || name.includes('receita') || name.includes('renda') || name.includes('ganho')) {
            return 'green'; // Verde
        } else if (name.includes('beleza') || name.includes('cabelo') || name.includes('unha') || name.includes('estética')) {
            return 'pink'; // Rosa
        } else if (name.includes('pet') || name.includes('animal')) {
            return 'orange'; // Laranja
        } else if (name.includes('assinatura') || name.includes('streaming') || name.includes('netflix') || name.includes('spotify')) {
            return 'purple'; // Roxo
        } else if (name.includes('presente') || name.includes('gift')) {
            return 'red'; // Vermelho
        } else if (name.includes('freela') || name.includes('extra')) {
            return 'yellow'; // Amarelo
        } else {
            return 'blue'; // Azul como padrão
        }
    }
    function parseMonthYear(monthYearString) {
        const [monthName, year] = monthYearString.split('-');
        const monthIndex = monthNamesPt.indexOf(monthName.toLowerCase());
        return { year: parseInt(year), month: monthIndex };
    }

    function formatDateToBRL(dateString) {
        if (!dateString || dateString.length !== 10) return dateString;
        const [year, month, day] = dateString.split('-');
        return `${day}/${month}`;
    }
    
    function formatCurrency(value) {
        return `R$ ${parseFloat(value).toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`;
    }

    function applyTheme(theme) {
        document.body.classList.toggle('dark-mode', theme === 'dark');
        const themeIcon = document.getElementById('theme-icon');
        themeIcon.src = theme === 'dark' ? 'buttons/sun.svg' : 'buttons/moon.svg';
        themeIcon.alt = theme === 'dark' ? 'Modo claro' : 'Modo escuro';
        localStorage.setItem('theme', theme);
        if (document.getElementById('financeiro-section').style.display !== 'none') {
            updateFinanceDisplay();
        }
    }

    // ----------------------------------------------------
    // PERSISTÊNCIA (localStorage)
    // ----------------------------------------------------
    function saveFinancialData() {
        localStorage.setItem('financialData', JSON.stringify(dataByMonth));
        localStorage.setItem('expenseCategories', JSON.stringify(expenseCategories));
        localStorage.setItem('revenueCategories', JSON.stringify(revenueCategories));
        localStorage.setItem('categoryLimits', JSON.stringify(categoryLimits));
    }

    function loadFinancialData() {
        dataByMonth = JSON.parse(localStorage.getItem('financialData')) || {};
        // Não carrega categorias do localStorage - usa apenas as categorias básicas definidas no código
        categoryLimits = JSON.parse(localStorage.getItem('categoryLimits')) || {};
    }

    function saveCalendarTasks() { localStorage.setItem('calendarTasks', JSON.stringify(calendarTasks)); }
    
    function fixIconPathsInCalendarTasks() {
        // Função para corrigir apenas ícones que não têm caminho completo (compatibilidade)
        let needsSave = false;

        for (const dateKey in calendarTasks) {
            const tasks = calendarTasks[dateKey];
            if (Array.isArray(tasks)) {
                tasks.forEach(task => {
                    // Corrige ícones antigos da pasta colored/ para os novos
                    if (task.icon && task.icon.includes('images/colored/')) {
                        // Extrai o nome do arquivo e mapeia para o novo caminho
                        const fileName = task.icon.split('/').pop();
                        const iconName = fileName.replace('.svg', '');
                        
                        // Mapeamento de nomes antigos para novos
                        const newIconName = legacyIconNameMap[iconName] || iconName;
                        task.icon = `./images/${newIconName}.svg`;
                        needsSave = true;
                    }
                });
            }
        }
        
        if (needsSave) {
            saveCalendarTasks();
        }
    }

    function fixIconPathsInInvestmentGoals() {
        let needsSave = false;

        investmentGoals = investmentGoals.map(goal => {
            if (goal && goal.icon && goal.icon.includes('images/colored/')) {
                const fileName = goal.icon.split('/').pop();
                const iconName = fileName.replace('.svg', '');
                const newIconName = legacyIconNameMap[iconName] || iconName;
                const newIconPath = `./images/${newIconName}.svg`;
                if (goal.icon !== newIconPath) {
                    goal.icon = newIconPath;
                    needsSave = true;
                }
            }
            if (normalizeGoalColorData(goal)) {
                needsSave = true;
            }
            return goal;
        });

        if (needsSave) {
            saveInvestmentGoals();
        }
    }

    function loadCalendarTasks() {
        calendarTasks = JSON.parse(localStorage.getItem('calendarTasks')) || {};
        // Corrige apenas ícones que não têm caminho completo (compatibilidade)
        fixIconPathsInCalendarTasks();
    }

    function saveLists() {
        const lists = Array.from(listsContainer.querySelectorAll('.list')).map(listDiv => {
            const isShopping = listDiv.dataset.isShopping === 'true';
            const iconImg = listDiv.querySelector('.list-title-icon');
            const rawBorderColor = listDiv.style.borderLeftColor || window.getComputedStyle(listDiv).borderLeftColor || null;
            const colorName = listDiv.dataset.colorName || (iconImg ? iconImg.dataset.color : null) || getColorNameFromValue(rawBorderColor);
            const colorHex = getColorHexFromName(colorName);
            const sanitizedIcon = sanitizeIconPath(iconImg ? iconImg.src : '');
            const iconPath = sanitizedIcon || sanitizeIconPath(taskIcons.lista || taskIcons.nenhum || './images/circledashed.svg');

            if (iconImg) {
                iconImg.dataset.color = colorName;
            }
            listDiv.dataset.colorName = colorName;

            const colorValue = rawBorderColor || colorHex;

            const items = Array.from(listDiv.querySelectorAll('ul li')).map(li => {
                const baseItem = {
                    text: li.querySelector('.list-item-content span').textContent.trim(),
                    checked: li.querySelector('input[type="checkbox"]').checked
                };
                if (isShopping) {
                    baseItem.value = parseFloat(li.dataset.value) || 0;
                }
                return baseItem;
            });
            
            const isRoutine = listDiv.dataset.isRoutine === 'true';
            let lastCompletedDate = null;
            if (isRoutine && listDiv.classList.contains('completed')) {
                lastCompletedDate = new Date().toISOString().split('T')[0];
            }

            return {
                id: listDiv.dataset.listId,
                name: listDiv.querySelector('h2').textContent.trim(),
                items: items,
                priority: listDiv.querySelector('.list-priority-select').value,
                icon: iconPath,
                color: colorValue,
                colorName: colorName,
                isShoppingList: isShopping,
                isFinalized: listDiv.classList.contains('finalized'),
                isRoutine: isRoutine,
                lastCompletedDate: lastCompletedDate,
                transactionId: listDiv.dataset.transactionId || null,
                transactionMonth: listDiv.dataset.transactionMonth || null
            };
        }).filter(Boolean);
        localStorage.setItem('todoLists', JSON.stringify(lists));
    }

    function loadAndRenderLists() {
        listsContainer.innerHTML = '';
        const listsData = JSON.parse(localStorage.getItem('todoLists')) || [];
        const todayString = new Date().toISOString().split('T')[0];

        // Lógica de Reset de Rotinas e normalização de dados
        let listsModified = false;
        listsData.forEach(listData => {
            if (listData.isRoutine && listData.lastCompletedDate && listData.lastCompletedDate < todayString) {
                listData.items.forEach(item => item.checked = false);
                listData.lastCompletedDate = null;
                listsModified = true;
            }

            if (normalizeListData(listData)) {
                listsModified = true;
            }
        });

        // Se alguma rotina foi resetada ou dados normalizados, salva antes de renderizar
        if (listsModified) {
            localStorage.setItem('todoLists', JSON.stringify(listsData));
        }

        // Renderização das listas
        listsData.forEach(listData => {
            createList(
                listData.name,
                listData.items,
                listData.priority,
                listData.id,
                listData.icon,
                listData.isShoppingList,
                listData.isFinalized,
                listData.isRoutine,
                listData.transactionId,
                listData.transactionMonth,
                listData.color,
                listData.colorName
            );
        });
    }


    function saveInvestmentGoals() { localStorage.setItem('investmentGoals', JSON.stringify(investmentGoals)); }
    function loadInvestmentGoals() {
        investmentGoals = JSON.parse(localStorage.getItem('investmentGoals')) || [];
        fixIconPathsInInvestmentGoals();
    }


    // ----------------------------------------------------
    // MODAIS (APENAS PARA LISTAS E PARTES DE FINANÇAS)
    // ----------------------------------------------------
    function openCategorySection() {
        // Esconde outras views financeiras
        transactionsView.style.display = 'none';
        budgetsView.style.display = 'none';
        investmentsView.style.display = 'none';
        
        // Mostra a seção de categorias
        categorySection.style.display = 'block';
        
        editingCategoryId = null;
        renderCategoryModalList();
    }
    
    function openDescriptionSection(description, date) {
        const modalDescText = document.getElementById('modal-description-text');
        const modalDateText = document.getElementById('modal-date-text');
        const detailsContent = document.getElementById('transaction-details-content');
        const noSelectionMessage = document.getElementById('no-selection-message');
        
        if (modalDescText) modalDescText.textContent = description;
        if (modalDateText) {
            if (date) {
                const [year, month, day] = date.split('-');
                modalDateText.textContent = `${day}/${month}/${year}`;
            } else {
                modalDateText.textContent = '';
            }
        }
        
        // Mostra os detalhes e esconde a mensagem de nenhuma seleção
        if (detailsContent) detailsContent.style.display = 'block';
        if (noSelectionMessage) noSelectionMessage.style.display = 'none';
    }

    function closeDescriptionSection() {
        // Função mantida para compatibilidade, mas não faz mais nada
        // Os detalhes agora ficam sempre visíveis no painel lateral
    }
    
    function openListDetailsSection(listId) {
        // Track current section as previous
        const currentActiveSection = document.querySelector('.mensal-content-section[style*="block"]');
        if (currentActiveSection) {
            previousSection = currentActiveSection.id;
        }
        
        // Hide day view section but keep planner-details-container visible
        dayViewSection.style.setProperty('display', 'none', 'important');
        taskFormView.style.setProperty('display', 'none', 'important');
        
        const allLists = JSON.parse(localStorage.getItem('todoLists')) || [];
        const targetList = allLists.find(list => list.id === listId);

        if (targetList) {
            listDetailsTitle.textContent = targetList.name;
            listDetailsItems.innerHTML = '';
            if (targetList.items.length === 0) {
                listDetailsItems.innerHTML = '<li>esta lista não tem itens.</li>';
            } else {
                targetList.items.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item.text;
                    if (item.checked) {
                        li.style.textDecoration = 'line-through';
                        li.style.opacity = '0.6';
                    }
                    listDetailsItems.appendChild(li);
                });
            }
            
            // Show list details section
            listDetailsSection.style.setProperty('display', 'block', 'important');
        } else {
            alert("Erro: não foi possível encontrar a lista vinculada.");
        }
    }

    function closeListDetailsSection() {
        listDetailsSection.style.setProperty('display', 'none', 'important');
        
        // Volta para as tarefas do dia
        plannerDetailsContainer.style.setProperty('display', 'block', 'important');
        dayViewSection.style.setProperty('display', 'block', 'important');
        
        // Garante que o botão de adicionar tarefa seja visível
        openAddTaskFormBtn.style.setProperty('display', 'inline-flex', 'important');
        openAddTaskFormBtn.style.setProperty('visibility', 'visible', 'important');
        openAddTaskFormBtn.style.setProperty('opacity', '1', 'important');
    }

    function openListIconSection(listId) {
        // Track current section as previous
        const currentActiveSection = document.querySelector('.mensal-content-section[style*="block"]');
        if (currentActiveSection) {
            previousSection = currentActiveSection.id;
        }
        
        // Hide all other sections first
        document.querySelectorAll('.mensal-content-section').forEach(section => section.style.display = 'none');
        
        currentListIconBeingEdited = listId;
        listIconSection.style.display = 'block';
    }

    function closeListIconSection() {
        listIconSection.style.display = 'none';
        // Não volta para seção anterior para evitar conflitos com navegação principal
        // A navegação principal já gerencia qual seção deve estar visível
    }

    function selectListIcon(iconPath) {
        if (currentListIconBeingEdited) {
            const listDiv = document.querySelector(`.list[data-list-id="${currentListIconBeingEdited}"]`);
            if (listDiv) {
                // Usa a cor selecionada para o ícone
                const selectedColor = listColor.value || 'blue';
                const colorMap = {
                    'blue': '#3586ff',
                    'green': '#4caf50',
                    'red': '#f44336',
                    'yellow': '#ffeb3b',
                    'purple': '#9c27b0',
                    'pink': '#ff66cc',
                    'orange': '#ff9800'
                };
                const color = colorMap[selectedColor] || '#3586ff';

                // Atualiza o ícone da lista
                const iconImg = listDiv.querySelector('.list-title-icon');
                const sanitizedIcon = sanitizeIconPath(iconPath);
                if (iconImg) {
                    iconImg.src = sanitizedIcon + '?t=' + Date.now();
                    iconImg.className = 'list-title-icon icon-color-' + selectedColor;
                    iconImg.dataset.color = selectedColor;
                }

                // Atualiza a cor da borda da lista para combinar com o ícone
                listDiv.style.borderLeftColor = color;
                listDiv.dataset.colorName = selectedColor;

                // Salva a lista com a nova cor
                const allLists = JSON.parse(localStorage.getItem('todoLists')) || [];
                const listIndex = allLists.findIndex(list => list.id === currentListIconBeingEdited);
                if (listIndex !== -1) {
                    allLists[listIndex].icon = sanitizedIcon;
                    allLists[listIndex].color = color;
                    allLists[listIndex].colorName = selectedColor;
                    localStorage.setItem('todoLists', JSON.stringify(allLists));
                }

                saveLists();
            }
        }
        closeListIconSection();
    }


    function openListEditorSection(listId) {
        // Track current section as previous
        const currentActiveSection = document.querySelector('.mensal-content-section[style*="block"]');
        if (currentActiveSection) {
            previousSection = currentActiveSection.id;
        }
        
        // Hide all other sections first
        document.querySelectorAll('.mensal-content-section').forEach(section => section.style.display = 'none');
        
        currentListIconBeingEdited = null; 
        const allLists = JSON.parse(localStorage.getItem('todoLists')) || [];
        const listData = allLists.find(list => list.id === listId);
        if (!listData) return;

        editorLinkAsRoutineCheckbox.checked = false;
        editorRoutineOptions.style.display = 'none';
        editorRecurrenceTypeInput.value = 'none';
        editorRecurrenceEndDateInput.style.display = 'none';
        editorWeeklyRecurrenceOptions.style.display = 'none';
        editorWeeklyRecurrenceOptions.querySelectorAll('input').forEach(cb => cb.checked = false);


        editorListIdInput.value = listId;
        editorListNameInput.value = listData.name;
        
        // Define a prioridade atual
        const currentPriority = listData.priority || 'baixa';
        editorListPriorityInput.value = currentPriority;
        
        // Obtém a cor baseada nos dados salvos ou prioridade
        const storedColorName = listData.colorName || getColorNameFromValue(listData.color);
        const currentColorName = storedColorName || getColorNameFromPriority(currentPriority);

        // Renderiza o picker de ícones com a cor da prioridade
        renderIconPicker(editorListIconPicker, editorListIconInput, taskIcons, null, null);

        // Aplica a cor aos ícones
        editorListIconPicker.querySelectorAll('.task-icon-option img').forEach(img => {
            img.className = 'icon-color-' + currentColorName;
            img.dataset.color = currentColorName;
        });

        const editorListColorInput = document.getElementById('editor-list-color-main');
        if (editorListColorInput) {
            editorListColorInput.value = currentColorName;
        }
        const editorListColorPicker = document.getElementById('editor-list-color-picker');
        if (editorListColorPicker) {
            editorListColorPicker.querySelectorAll('.color-option').forEach(option => {
                option.classList.toggle('selected', option.dataset.color === currentColorName);
            });
        }

        // Agora seleciona o ícone atual
        const currentIconPath = sanitizeIconPath(listData.icon);
        editorListIconInput.value = currentIconPath;

        // Procura pelo nome do ícone
        const currentIconName = Object.keys(taskIcons).find(key => {
            return currentIconPath.includes(taskIcons[key].split('/').pop().replace('.svg', ''));
        });
        
        if (currentIconName) {
            editorListIconPicker.querySelectorAll('.task-icon-option').forEach(option => {
                option.classList.toggle('selected', option.dataset.iconName === currentIconName);
            });
            editorListIconInput.value = getColoredIcons(currentIconName, currentColorName);
        }

        const linkedTaskInfo = findLinkedTask(listId);
        if (linkedTaskInfo) {
            addScheduleBtn.style.display = 'none';
            editorSchedulingSection.style.display = 'block';
            editorEventDateInput.value = linkedTaskInfo.dateKey;
            editorEventTimeInput.value = linkedTaskInfo.task.time;
            editorRoutineContainer.style.display = 'flex';

            if (linkedTaskInfo.task.recurrenceId) {
                editorLinkAsRoutineCheckbox.checked = true;
                editorRoutineOptions.style.display = 'flex';
                
                const recurrenceId = linkedTaskInfo.task.recurrenceId;
                const allRecurringTasks = [];
                Object.keys(calendarTasks).forEach(dateKey => {
                    calendarTasks[dateKey].forEach(task => {
                        if (task.recurrenceId === recurrenceId) {
                            allRecurringTasks.push({ task, dateKey });
                        }
                    });
                });
                allRecurringTasks.sort((a, b) => new Date(a.dateKey) - new Date(b.dateKey));
                
                if (allRecurringTasks.length > 0) {
                    const endDate = allRecurringTasks[allRecurringTasks.length - 1].dateKey;
                    editorRecurrenceEndDateInput.value = endDate;
                    editorRecurrenceEndDateInput.style.display = 'block';
                    
                    const weekdays = new Set(allRecurringTasks.map(item => new Date(item.dateKey + 'T12:00:00').getDay()));
                    if (weekdays.size >= 6 && allRecurringTasks.length > 1) {
                         editorRecurrenceTypeInput.value = 'daily';
                    } else {
                        editorRecurrenceTypeInput.value = 'weekly';
                        editorWeeklyRecurrenceOptions.style.display = 'block';
                        weekdays.forEach(day => {
                            const checkbox = editorWeeklyRecurrenceOptions.querySelector(`input[value="${day}"]`);
                            if(checkbox) checkbox.checked = true;
                        });
                    }
                }
            }


        } else {
            addScheduleBtn.style.display = 'block';
            editorSchedulingSection.style.display = 'none';
            editorRoutineContainer.style.display = 'none';
            editorEventDateInput.value = new Date().toISOString().split('T')[0];
            editorEventTimeInput.value = "09:00";
        }

        listEditorSection.style.display = 'block';
    }

    function closeListEditorSection() {
        listEditorSection.style.display = 'none';
        // Volta para a seção anterior
        if (previousSection) {
            const targetSection = document.getElementById(previousSection);
            if (targetSection) {
                targetSection.style.display = 'block';
            }
        } else {
            // Se não há seção anterior, volta para a seção de listas
            document.getElementById('listas-section').style.display = 'block';
        }
    }

    // ----------------------------------------------------
    // GERENCIAMENTO DE CATEGORIAS
    // ----------------------------------------------------
    function renderCategorySelect(isRevenue = false) {
        sanitizeAllCategories();
        const categories = isRevenue ? revenueCategories : expenseCategories;
        categoryInput.innerHTML = categories.map(c => {
            const categoryName = typeof c === 'string' ? c : c.name;
            return `<option value="${categoryName}">${categoryName}</option>`;
        }).join('');
        if (editingIndex !== null && dataByMonth[currentMonth]?.[editingIndex]) {
            categoryInput.value = dataByMonth[currentMonth][editingIndex].category;
        }
    }
    
    function renderCategoryLimitSelect() {
        sanitizeAllCategories();
        const categorySelect = document.getElementById('categoryLimitCategory');
        categorySelect.innerHTML = expenseCategories.map(c => {
            const categoryName = typeof c === 'string' ? c : c.name;
            return `<option value="${categoryName}">${categoryName}</option>`;
        }).join('');
    }

    function renderCategoryModalList() {
        sanitizeAllCategories();
        const renderList = (categories, container, type) => {
            container.innerHTML = categories.length === 0 ? `<p style="color: #777;">nenhuma categoria de ${type} cadastrada.</p>` :
                categories.map(category => {
                    const categoryName = typeof category === 'string' ? category : category.name;
                    const categoryIcon = typeof category === 'object' ? category.icon : categoryIcons[categoryName] || './images/money.svg';
                    const categoryColorSource = typeof category === 'object' && category.color ? category.color : getCategoryColor(categoryName);
                    const iconColorName = getColorNameFromValue(categoryColorSource);
                    const iconMarkup = `<img src="${categoryIcon}" alt="${categoryName}" class="category-icon icon-color-${iconColorName}">`;

                    if (editingCategoryId && editingCategoryId.name === categoryName && editingCategoryId.type === type) {
                        return `<div style="padding: 8px; border: 2px solid #3586ff; border-radius: 8px; background: rgba(53, 134, 255, 0.1); margin-bottom: 5px;">
                                    <span style="color: #3586ff; font-weight: bold;">editando: ${categoryName}</span>
                                </div>`;
                    } else {
                        return `<div style="display: flex; align-items: center; gap: 10px; padding: 8px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 5px;">
                                    ${iconMarkup}
                                    <span style="flex-grow: 1;">${categoryName}</span>
                                    <span>
                                        <button class="edit-btn" onclick="editCategory('${categoryName}', '${type}')"><img src="buttons/pencil.svg" alt="Editar"></button>
                                        <button class="delete-btn" onclick="removeCategory('${categoryName}', '${type}')"><img src="buttons/trash.svg" alt="Remover"></button>
                                    </span>
                                </div>`;
                    }
                }).join('');
        };
        renderList(expenseCategories, document.getElementById('expense-category-list-container'), 'despesa');
        renderList(revenueCategories, document.getElementById('revenue-category-list-container'), 'receita');
    }

    window.addCategory = function() {
        const name = newCategoryNameInput.value.trim().toLowerCase();
        const type = newCategoryTypeInput.value;
        if (!name) return alert('o nome da categoria é obrigatório.');
        if (disallowedCategoryNames.has(name)) return alert('esta categoria não está disponível.');

        let targetArray = type === 'receita' ? revenueCategories : expenseCategories;
        const categoryExists = targetArray.some(cat => {
            const catName = typeof cat === 'string' ? cat : cat.name;
            return catName === name;
        });
        if (categoryExists) return alert('categoria já existe.');
        
        // Obtém o ícone e cor selecionados
        const selectedIconName = categoryIconPicker.querySelector('.task-icon-option.selected')?.dataset.iconName || 'dinheiro';
        
        // Obtém cor automática baseada no nome da categoria
        const selectedColor = getCategoryColor(name);
        
        // Gera o ícone com a cor automática
        const coloredIcon = getColoredIcons(selectedIconName, selectedColor);
        
        // Cria o objeto da categoria com ícone e cor
        const categoryData = {
            name: name,
            icon: coloredIcon,
            color: selectedColor
        };
        
        targetArray.push(categoryData);
        newCategoryNameInput.value = '';
        
        // Reset do seletor de ícones e cores
        categoryIconPicker.querySelectorAll('.task-icon-option').forEach(option => {
            option.classList.remove('selected');
        });
        const firstIcon = categoryIconPicker.querySelector('.task-icon-option');
        if (firstIcon) firstIcon.classList.add('selected');
        categoryIconHiddenInput.value = getColoredIcons('dinheiro', 'blue');
        
        categoryColorPicker.querySelectorAll('.color-option').forEach(option => {
            option.classList.remove('selected');
        });
        const blueOption = categoryColorPicker.querySelector('[data-color="blue"]');
        if (blueOption) blueOption.classList.add('selected');
        categoryIconColorInput.value = 'blue';

        sanitizeAllCategories();
        saveFinancialData();
        renderCategoryModalList();
        updateFinanceDisplay();
    }

    window.removeCategory = function(category, type) {
        const categoryName = typeof category === 'string' ? category : category.name;
        if (confirm(`tem certeza que deseja remover a categoria "${categoryName}"? todas as transações associadas serão movidas para "outros".`)) {
            if (type === 'receita') {
                revenueCategories = revenueCategories.filter(c => {
                    const catName = typeof c === 'string' ? c : c.name;
                    return catName !== categoryName;
                });
            } else {
                expenseCategories = expenseCategories.filter(c => {
                    const catName = typeof c === 'string' ? c : c.name;
                    return catName !== categoryName;
                });
            }
            
            Object.values(dataByMonth).flat().forEach(item => {
                if (item.category === categoryName) item.category = 'outros';
            });
            
            saveFinancialData();
            renderCategoryModalList();
            updateFinanceDisplay();
        }
    }

    window.editCategory = function(name, type) {
        editingCategoryId = { name, type };
        
        // Encontra a categoria sendo editada
        const categoryArray = type === 'despesa' ? expenseCategories : revenueCategories;
        const categoryData = categoryArray.find(cat => {
            const catName = typeof cat === 'string' ? cat : cat.name;
            return catName === name;
        });
        
        // Preenche o formulário de edição
        editCategoryNameInput.value = name;
        editCategoryTypeInput.value = type;
        
        // Obtém cor automática baseada no nome da categoria
        const currentColor = getCategoryColor(name);
        categoryIconColorInput.value = currentColor;
        
        // Atualiza os ícones com a cor automática
        categoryIconPicker.querySelectorAll('.task-icon-option').forEach(iconOption => {
            const iconName = iconOption.dataset.iconName;
            const coloredPath = getColoredIcons(iconName, currentColor);
            
            const img = iconOption.querySelector('img');
            img.remove();
            
            const newImg = document.createElement('img');
            newImg.src = coloredPath + '?t=' + Date.now() + '&r=' + Math.random();
            newImg.className = `icon-color-${currentColor}`;
            newImg.dataset.color = currentColor;
            newImg.style.width = '100%';
            newImg.style.height = '100%';
            newImg.style.objectFit = 'contain';
            newImg.style.borderRadius = '5px';
            
            iconOption.appendChild(newImg);
            iconOption.dataset.iconPath = coloredPath;
        });
        
        // Seleciona o ícone atual da categoria
        if (typeof categoryData === 'object' && categoryData.icon) {
            const currentIconName = Object.keys(taskIcons).find(key => 
                getColoredIcons(key, currentColor) === categoryData.icon
            );
            if (currentIconName) {
                categoryIconPicker.querySelectorAll('.task-icon-option').forEach(option => {
                    option.classList.toggle('selected', option.dataset.iconName === currentIconName);
                });
                categoryIconHiddenInput.value = getColoredIcons(currentIconName, currentColor);
            }
        }
        
        // Mostra o formulário de edição e esconde o de adicionar
        addCategoryForm.style.display = 'none';
        editCategoryForm.style.display = 'block';
        
        renderCategoryModalList();
    }

    window.cancelCategoryEdit = function() {
        editingCategoryId = null;
        addCategoryForm.style.display = 'none'; // Mantém escondido
        editCategoryForm.style.display = 'none';
        renderCategoryModalList();
    }

    window.saveCategoryEdit = function() {
        const newName = editCategoryNameInput.value.trim().toLowerCase();
        const newType = editCategoryTypeInput.value;

        if (!newName) return alert('o nome da categoria não pode ficar em branco.');
        if (disallowedCategoryNames.has(newName)) return alert('esta categoria não está disponível.');

        const categoryArray = newType === 'despesa' ? expenseCategories : revenueCategories;
        
        // Verifica se a nova categoria já existe (considerando objetos e strings)
        const categoryExists = categoryArray.some(cat => {
            const catName = typeof cat === 'string' ? cat : cat.name;
            return catName === newName;
        });
        
        if (newName !== editingCategoryId.name && categoryExists) {
            return alert('essa categoria já existe.');
        }

        // Obtém o ícone selecionado e cor automática baseada no novo nome
        const selectedIconName = categoryIconPicker.querySelector('.task-icon-option.selected')?.dataset.iconName || 'dinheiro';
        const selectedColor = getCategoryColor(newName);
        const coloredIcon = getColoredIcons(selectedIconName, selectedColor);
        
        // Encontra o índice da categoria (considerando objetos e strings)
        const oldName = editingCategoryId.name;
        const oldType = editingCategoryId.type;
        
        // Se mudou o tipo, remove da array antiga e adiciona na nova
        if (newType !== oldType) {
            const oldCategoryArray = oldType === 'despesa' ? expenseCategories : revenueCategories;
            const index = oldCategoryArray.findIndex(cat => {
                const catName = typeof cat === 'string' ? cat : cat.name;
                return catName === oldName;
            });
            
            if (index > -1) {
                oldCategoryArray.splice(index, 1);
                categoryArray.push({
                    name: newName,
                    icon: coloredIcon,
                    color: selectedColor
                });
            }
        } else {
            // Se não mudou o tipo, apenas atualiza a categoria existente
            const index = categoryArray.findIndex(cat => {
                const catName = typeof cat === 'string' ? cat : cat.name;
                return catName === oldName;
            });
            
            if (index > -1) {
                categoryArray[index] = {
                    name: newName,
                    icon: coloredIcon,
                    color: selectedColor
                };
            }
        }
        
        Object.values(dataByMonth).flat().forEach(item => {
            if (item.category === oldName) {
                item.category = newName;
            }
        });

        if (categoryLimits[oldName]) {
            categoryLimits[newName] = categoryLimits[oldName];
            delete categoryLimits[oldName];
        }

        sanitizeAllCategories();
        saveFinancialData();
        editingCategoryId = null;
        renderCategoryModalList();
        updateFinanceDisplay();
    }
    
    // ----------------------------------------------------
    // LÓGICA DE GASTOS POR CATEGORIA (ORÇAMENTOS)
    // ----------------------------------------------------
    
    window.toggleBudgetDisplay = function(container) {
        const textElement = container.querySelector('.progress-bar-text');
        const currentState = container.dataset.view || 'percentage';

        if (currentState === 'percentage') {
            const spent = parseFloat(container.dataset.spent);
            textElement.textContent = formatCurrency(spent);
            textElement.style.fontSize = '11px';
            container.dataset.view = 'currency';
        } else if (currentState === 'currency') {
            const limit = parseFloat(container.dataset.limit);
            textElement.textContent = formatCurrency(limit);
            textElement.style.fontSize = '11px';
            container.dataset.view = 'limit';
        } else {
            textElement.textContent = container.dataset.percentage;
            textElement.style.fontSize = '';
            container.dataset.view = 'percentage';
        }
    }
    
    function updateCategorySpending() {
        sanitizeAllCategories();
        const tableEl = document.getElementById('category-spending-list');
        tableEl.innerHTML = '';

        const allExpenses = Object.values(dataByMonth).flat().filter(item => item.value < 0);
        const totals = {};
        allExpenses.forEach(item => {
            const category = item.category;
            totals[category] = (totals[category] || 0) + Math.abs(item.value);
        });

        const allExpenseCategories = [...new Set(expenseCategories)];
        allExpenseCategories.forEach(category => {
            // Extrai o nome da categoria (pode ser string ou objeto)
            const categoryName = typeof category === 'string' ? category : category.name;
            const limit = categoryLimits[categoryName] || 0;
            const spent = totals[categoryName] || 0;
            const percentage = limit > 0 ? (spent / limit) * 100 : 0;
            const row = document.createElement('tr');
            
            // Procura o ícone e cor da categoria personalizada
            let iconPath = categoryIcons[categoryName] || categoryIcons["outros"];
            let iconColorName = getCategoryColor(categoryName);

            const categoryData = expenseCategories.find(cat => {
                const catName = typeof cat === 'string' ? cat : cat.name;
                return catName === categoryName;
            });

            if (categoryData && typeof categoryData === 'object') {
                iconPath = categoryData.icon;
                iconColorName = getColorNameFromValue(categoryData.color);
            }

            const hexColor = getColorHexFromName(iconColorName);

            const progressBarColor = percentage > 100 ? '#FF5252' : (percentage > 80 ? '#FF9800' : hexColor);

            const categoryDisplay = `<img src="${iconPath}" alt="${categoryName}" class="category-icon icon-color-${iconColorName}">`;
            
            row.innerHTML = `
                <td title="${categoryName}" style="width: 15%; text-align: center;">${categoryDisplay}</td>
                <td style="width: 85%;">
                    <div class="progress-bar-container"
                         data-spent="${spent}"
                         data-percentage="${percentage.toFixed(0)}%"
                         data-limit="${limit}"
                         onclick="toggleBudgetDisplay(this)"
                         title="clique para alternar visualização">
                        <div class="progress-bar" style="width: ${Math.min(100, percentage)}%; background-color: ${progressBarColor};"></div>
                        <span class="progress-bar-text">${percentage.toFixed(0)}%</span>
                    </div>
                </td>
            `;
            tableEl.appendChild(row);
        });
    }

    
    categoryLimitForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const category = document.getElementById('categoryLimitCategory').value;
        const limit = parseFloat(document.getElementById('categoryLimitValue').value);
        if (category && !isNaN(limit)) {
            categoryLimits[category] = limit;
            saveFinancialData();
            updateCategorySpending();
            this.reset();
        }
    });

    // ----------------------------------------------------
    // LÓGICA DE INVESTIMENTOS
    // ----------------------------------------------------

    window.editContribution = (goalId, monthYearKey) => {
        editingContributionKey = `${goalId}-${monthYearKey}`;
        renderInvestmentGoals();
    };

    window.cancelContributionEdit = () => {
        editingContributionKey = null;
        renderInvestmentGoals();
    };

    window.saveContributionEdit = (goalId, monthYearKey) => {
        const input = document.getElementById(`contribution-input-${goalId}-${monthYearKey}`);
        const newValue = parseFloat(input.value);
        if (isNaN(newValue) || newValue < 0) {
            alert("Por favor, insira um valor válido.");
            return;
        }
        
        const goal = investmentGoals.find(g => g.id === goalId);
        if (goal) {
            goal.contributions[monthYearKey] = newValue;
            saveInvestmentGoals();
            editingContributionKey = null;
            renderInvestmentGoals();
        }
    };

    window.deleteContribution = (goalId, monthYearKey) => {
        if (confirm(`Tem certeza que deseja remover o aporte de ${monthYearKey.replace('-', '/')}?`)) {
            const goal = investmentGoals.find(g => g.id === goalId);
            if (goal) {
                delete goal.contributions[monthYearKey];
                saveInvestmentGoals();
                renderInvestmentGoals();
            }
        }
    };

    window.toggleContributions = (goalId) => {
        const contributionsSection = document.getElementById(`contributions-${goalId}`);
        const button = contributionsSection.previousElementSibling;
        
        if (contributionsSection.style.display === 'none') {
            contributionsSection.style.display = 'block';
            button.textContent = `ocultar aportes (${Object.keys(investmentGoals.find(g => g.id === goalId).contributions).length})`;
        } else {
            contributionsSection.style.display = 'none';
            button.textContent = `ver aportes (${Object.keys(investmentGoals.find(g => g.id === goalId).contributions).length})`;
        }
    };



    function cancelEditGoal() {
        editingGoalId = null;
        renderInvestmentGoals();
    }

    function renderGoalIconPicker() {
        // Renderiza ícones com cores
        renderIconPicker(goalIconPicker, goalIconHiddenInput, taskIcons, null, goalColorPicker);

        // Seleciona a cor azul por padrão
        if (goalColorPicker) {
            goalColorPicker.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
            });
            const blueOption = goalColorPicker.querySelector('[data-color="blue"]');
            if (blueOption) blueOption.classList.add('selected');
            if (goalColor) goalColor.value = 'blue';
        }
    }

    function resetGoalIconsToBlue() {
        const defaultColor = 'blue';
        if (goalColorPicker) {
            selectColorOption(goalColorPicker, defaultColor);
        }
        if (goalColor) {
            goalColor.value = defaultColor;
        }
        if (goalIconPicker) {
            applyColorToIconOptions(goalIconPicker, defaultColor);
            const options = goalIconPicker.querySelectorAll('.task-icon-option');
            options.forEach(option => option.classList.remove('selected'));
            const firstOption = options[0];
            if (firstOption) {
                firstOption.classList.add('selected');
                goalIconHiddenInput.value = firstOption.dataset.iconPath;
            }
        }
    }

    function renderInvestmentGoals() {
      if (!goalsContainer) {
          console.error('goalsContainer não encontrado');
          return;
      }
      
      goalsContainer.innerHTML = '';
      if (investmentGoals.length === 0 && editingGoalId === null) {
        goalsContainer.innerHTML = '<p style="text-align: center; color: #777;">nenhuma meta de investimento criada.</p>';
        return;
      }

      investmentGoals.forEach(goal => {
        const card = document.createElement('div');
        card.className = 'investment-goal-card';
        card.setAttribute('data-goal-id', goal.id);

        const goalColorName = getColorNameFromValue(goal.colorName || goal.color);
        const goalColorHex = getColorHexFromName(goalColorName);
        card.style.borderLeftColor = goalColorHex;
        
        if (goal.id === editingGoalId) {
            card.innerHTML = `
                <div style="position: relative;">
                    <button class="close-button back-button" onclick="cancelEditGoal()" style="right: auto; left: 15px; top: 15px;"><img src="buttons/back.svg" alt="Voltar"></button>
                    <h4 style="margin-top: 0; text-align: center; padding-top: 10px;">editar meta de investimento</h4>
                </div>
                <form class="edit-goal-form">
                    <div class="form-inputs">
                        <input type="text" value="${goal.name}" required>
                        <input type="number" value="${goal.target}" step="0.01" required>
                    </div>
                    <div class="form-inputs">
                         <input type="number" class="editing-goal-interest" value="${goal.interestRate || 0}" step="0.01" placeholder="juros mensais (%)">
                         <input type="date" class="editing-goal-deadline" value="${goal.deadline || ''}" style="${goal.deadline ? '' : 'display:none;'}">
                    </div>
                    <div style="text-align: right;">
                        <input type="checkbox" class="editing-goal-has-deadline" id="deadline-check-${goal.id}" ${goal.deadline ? 'checked' : ''} style="width:auto; vertical-align: middle;">
                        <label for="deadline-check-${goal.id}" style="font-size: var(--font-size-sm); vertical-align: middle; cursor: pointer;">definir prazo</label>
                    </div>
                    
                    <label style="font-size: var(--font-size-sm); font-weight: bold; margin-top: 10px; display: block;">ícone:</label>
                    <div class="goal-icon-picker" style="display: flex; gap: 8px; flex-wrap: wrap;"></div> 
                    <input type="hidden" class="editing-goal-icon-input" value="${goal.icon}">
                    
                    <label style="font-size: var(--font-size-sm); font-weight: bold; margin-top: 10px; display: block;">cor:</label>
                    <div class="editing-goal-color-picker" style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <div class="color-option" data-color="red" style="background-color: #f44336;"></div>
                        <div class="color-option" data-color="blue" style="background-color: #3586ff;"></div>
                        <div class="color-option" data-color="green" style="background-color: #4caf50;"></div>
                        <div class="color-option" data-color="yellow" style="background-color: #ffeb3b;"></div>
                        <div class="color-option" data-color="purple" style="background-color: #9c27b0;"></div>
                        <div class="color-option" data-color="pink" style="background-color: #ff66cc;"></div>
                        <div class="color-option" data-color="orange" style="background-color: #ff9800;"></div>
                    </div>
                    <input type="hidden" class="editing-goal-color-input" value="${goalColorName}">
                    
                    <div class="actions" style="margin-top: 15px;">
                        <button type="submit" class="edit-btn">salvar</button>
                        <button type="button" class="delete-btn">cancelar</button>
                    </div>
                </form>
            `;

            const iconPickerContainer = card.querySelector('.goal-icon-picker');
            const hiddenIconInput = card.querySelector('.editing-goal-icon-input');
            const colorPickerContainer = card.querySelector('.editing-goal-color-picker');
            const hiddenColorInput = card.querySelector('.editing-goal-color-input');

            const currentColorName = goalColorName;
            if (hiddenColorInput) {
                hiddenColorInput.value = currentColorName;
            }
            
            // Inicializa o seletor de cor
            colorPickerContainer.querySelectorAll('.color-option').forEach(option => {
                option.classList.toggle('selected', option.dataset.color === currentColorName);
            });
            
            // Renderiza os ícones com a cor atual
            for (const key in taskIcons) {
                const iconPath = getColoredIcons(key, currentColorName);
                const optionDiv = document.createElement('div');
                optionDiv.className = 'task-icon-option';
                optionDiv.dataset.iconPath = iconPath;
                optionDiv.dataset.iconName = key;

                const img = document.createElement('img');
                img.src = iconPath + '?t=' + Date.now() + '&r=' + Math.random();
                img.className = `icon-color-${currentColorName}`;
                img.dataset.color = currentColorName;
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'contain';
                img.style.borderRadius = '5px';
                optionDiv.appendChild(img);

                if (goal.icon === iconPath || goal.icon === taskIcons[key]) {
                    optionDiv.classList.add('selected');
                }

                optionDiv.addEventListener('click', () => {
                    iconPickerContainer.querySelector('.selected')?.classList.remove('selected');
                    optionDiv.classList.add('selected');
                    hiddenIconInput.value = optionDiv.dataset.iconPath;
                });

                iconPickerContainer.appendChild(optionDiv);
            }
            
            // Event listener para o seletor de cor
            colorPickerContainer.addEventListener('click', (e) => {
                const colorOption = e.target.closest('.color-option');
                if (colorOption) {
                    colorPickerContainer.querySelectorAll('.color-option').forEach(option => {
                        option.classList.remove('selected');
                    });
                    colorOption.classList.add('selected');
                    const selectedColor = colorOption.dataset.color;

                    if (hiddenColorInput) {
                        hiddenColorInput.value = selectedColor;
                    }
                    
                    // Atualiza os ícones com a nova cor
                    iconPickerContainer.querySelectorAll('.task-icon-option').forEach(iconOption => {
                        const iconName = iconOption.dataset.iconName;
                        const coloredPath = getColoredIcons(iconName, selectedColor);
                        const img = iconOption.querySelector('img');
                        img.src = coloredPath;
                        img.className = `icon-color-${selectedColor}`;
                        img.dataset.color = selectedColor;
                        iconOption.dataset.iconPath = coloredPath;
                    });
                    
                    // Atualiza o ícone selecionado
                    const selectedIcon = iconPickerContainer.querySelector('.task-icon-option.selected');
                    if (selectedIcon) {
                        const iconName = selectedIcon.dataset.iconName;
                        const coloredPath = getColoredIcons(iconName, selectedColor);
                        hiddenIconInput.value = coloredPath;
                    }
                }
            });

            


        } else {
            
            const monthlyInterestRate = (goal.interestRate || 0) / 100;
            let totalAccumulated = 0;
            let historyHtml = '';
            let lastDate;

            if (Object.keys(goal.contributions).length > 0) {
                const contributionEntries = Object.entries(goal.contributions).map(([monthYear, amount]) => {
                    const { year, month } = parseMonthYear(monthYear);
                    return { year, month, amount, date: new Date(year, month), key: monthYear };
                }).sort((a, b) => a.date - b.date);

                lastDate = new Date(contributionEntries[0].year, contributionEntries[0].month);

                contributionEntries.forEach(entry => {
                    const currentDate = entry.date;
                    let monthsPassed = (currentDate.getFullYear() - lastDate.getFullYear()) * 12 + (currentDate.getMonth() - lastDate.getMonth());
                    
                    if (monthsPassed > 0) {
                        totalAccumulated *= Math.pow(1 + monthlyInterestRate, monthsPassed);
                    }
                    
                    totalAccumulated += entry.amount;
                    lastDate = currentDate;
                });
                
                const today = new Date();
                const startOfCurrentMonth = new Date(today.getFullYear(), today.getMonth(), 1); 
                let finalMonthsPassed = (startOfCurrentMonth.getFullYear() - lastDate.getFullYear()) * 12 + (startOfCurrentMonth.getMonth() - lastDate.getMonth());

                if (finalMonthsPassed > 0) {
                    totalAccumulated *= Math.pow(1 + monthlyInterestRate, finalMonthsPassed);
                }

                contributionEntries.forEach(entry => {
                    const currentKey = `${goal.id}-${entry.key}`;
                    if (editingContributionKey === currentKey) {
                         historyHtml += `
                            <li>
                                <span>${entry.key.replace('-', '/')}: </span>
                                <input id="contribution-input-${currentKey}" type="number" value="${entry.amount}" step="0.01">
                                <button class="save-item-btn" onclick="saveContributionEdit(${goal.id}, '${entry.key}')"><img src="buttons/ok.svg" alt="Salvar"></button>
                                <button class="cancel-item-btn" onclick="cancelContributionEdit()"><img src="buttons/close.svg" alt="Cancelar"></button>
                            </li>`;
                    } else {
                         historyHtml += `
                            <li>
                                <span>${entry.key.replace('-', '/')}: ${formatCurrency(entry.amount)}</span>
                                <span>
                                    <button class="edit-btn" onclick="editContribution(${goal.id}, '${entry.key}')"><img src="buttons/pencil.svg" alt="Editar"></button>
                                    <button class="delete-btn" onclick="deleteContribution(${goal.id}, '${entry.key}')"><img src="buttons/trash.svg" alt="Remover"></button>
                                </span>
                            </li>`;
                    }
                });
            }
            
            const totalSaved = totalAccumulated;
            const percentage = goal.target > 0 ? (totalSaved / goal.target) * 100 : 0;

            card.innerHTML = `
              <div class="goal-header">
                <div class="goal-header-content">
                    <img src="${goal.icon || taskIcons.money}" class="goal-icon icon-color-${goalColorName}" alt="ícone da meta">
                    <h4>${goal.name}</h4>
                </div>
                <div class="actions">
                    <button class="edit-btn"><img src="buttons/pencil.svg" alt="Editar"></button>
                    <button class="delete-btn"><img src="buttons/trash.svg" alt="Remover"></button>
                </div>
              </div>
              <div class="goal-details">
                <p><strong>${formatCurrency(totalSaved)}</strong> / ${formatCurrency(goal.target)}</p>
                <div class="progress-bar-container" style="cursor: default;">
                  <div class="progress-bar" style="width: ${Math.min(100, percentage)}%; background-color: ${goalColorHex};"></div>
                   <span class="progress-bar-text">${percentage.toFixed(1)}%</span>
                </div>
                 <p style="font-size: var(--font-size-xs); color: #888; margin-top: 8px; margin-bottom: 0;">
                    juros: ${goal.interestRate || 0}% a.m. | prazo: ${goal.deadline ? new Date(goal.deadline + 'T12:00:00').toLocaleDateString('pt-BR') : 'indefinido'}
                </p>
              </div>
              <form class="add-contribution-form">
                <input type="number" placeholder="valor a investir este mês" step="0.01" required>
                <button type="submit" class="add-btn">adicionar</button>
              </form>
              ${historyHtml ? `
                <button class="show-contributions-btn" onclick="toggleContributions(${goal.id})" style="width: 100%; margin-top: 10px; padding: 8px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: var(--font-size-xs);">
                  ver aportes (${Object.keys(goal.contributions).length})
                </button>
                <div class="contributions-section" id="contributions-${goal.id}" style="display: none;">
                  <ul class="contribution-history-list">${historyHtml}</ul>
                </div>
              ` : ''}
            `;
        }
        goalsContainer.appendChild(card);
      });
    }

    newGoalForm.addEventListener('submit', e => {
      e.preventDefault();
      const name = document.getElementById('newGoalName').value.trim();
      const target = parseFloat(document.getElementById('newGoalTarget').value);
      const interestRate = parseFloat(document.getElementById('newGoalInterestRate').value) || 0;
      const deadline = newGoalHasDeadlineCheckbox.checked ? newGoalDeadlineInput.value : null;
      const iconPath = goalIconHiddenInput.value;
      const selectedColor = goalColor.value || 'blue';

      if (name && !isNaN(target) && target > 0) {
        const colorName = getColorNameFromValue(selectedColor);
        const colorHex = getColorHexFromName(colorName);

        investmentGoals.push({
          id: Date.now(),
          name: name,
          target: target,
          color: colorHex,
          colorName: colorName,
          icon: iconPath,
          contributions: {},
          interestRate: interestRate,
          deadline: deadline
        });
        saveInvestmentGoals();
        renderInvestmentGoals();
        newGoalForm.reset();
        newGoalDeadlineInput.style.display = 'none';
        
        // Volta para a lista de metas
        investmentFormView.style.display = 'none';
        goalsContainer.style.display = 'block';
        openAddInvestmentFormBtn.style.display = 'block';
        
      } else {
        alert('por favor, preencha o nome e um valor válido para a meta.');
      }
    });
    
    goalsContainer.addEventListener('submit', e => {
        const card = e.target.closest('.investment-goal-card');
        if (!card) return;
        const goalId = Number(card.dataset.goalId);

        if(e.target.classList.contains('add-contribution-form')) {
            e.preventDefault();
            const amountInput = e.target.querySelector('input[type="number"]');
            const amount = parseFloat(amountInput.value);

            if (isNaN(amount) || amount <= 0) {
                alert('por favor, insira um valor válido para o aporte.');
                return;
            }

            const goal = investmentGoals.find(g => g.id === goalId);
            if (goal) {
                const monthYearKey = `${monthNamesPt[currentCalendarDate.getMonth()]}-${currentCalendarDate.getFullYear()}`;
                goal.contributions[monthYearKey] = (goal.contributions[monthYearKey] || 0) + amount;
                saveInvestmentGoals();
                renderInvestmentGoals();
            }
        } else if (e.target.classList.contains('edit-goal-form')) {
            e.preventDefault();
            const goal = investmentGoals.find(g => g.id === goalId);
            const newName = e.target.querySelector('input[type="text"]').value.trim();
            const newTarget = parseFloat(e.target.querySelector('input[type="number"]').value);
            const newInterest = parseFloat(e.target.querySelector('.editing-goal-interest').value) || 0;
            const hasDeadline = e.target.querySelector('.editing-goal-has-deadline').checked;
            const newDeadline = hasDeadline ? e.target.querySelector('.editing-goal-deadline').value : null;

            const newIcon = e.target.querySelector('.editing-goal-icon-input').value;
            const selectedColorOption = e.target.querySelector('.editing-goal-color-picker .color-option.selected');
            const selectedColorName = selectedColorOption ? selectedColorOption.dataset.color : 'blue';
            const normalizedColorName = getColorNameFromValue(selectedColorName);
            const newColorHex = getColorHexFromName(normalizedColorName);

            if (newName && !isNaN(newTarget) && newTarget > 0) {
                goal.name = newName;
                goal.target = newTarget;
                goal.color = newColorHex;
                goal.colorName = normalizedColorName;
                goal.icon = newIcon;
                goal.interestRate = newInterest;
                goal.deadline = newDeadline;

                editingGoalId = null;
                saveInvestmentGoals();
                renderInvestmentGoals();
            } else {
                alert('por favor, preencha o nome e um valor válido para a meta.');
            }
        }
    });

    goalsContainer.addEventListener('click', e => {
        const card = e.target.closest('.investment-goal-card');
        if (!card) return;
        const goalId = Number(card.dataset.goalId);
        
        if (e.target.closest('.goal-header .actions .delete-btn')) {
            if (confirm('tem certeza que deseja excluir esta meta?')) {
              investmentGoals = investmentGoals.filter(g => g.id !== goalId);
              saveInvestmentGoals();
              renderInvestmentGoals();
            }
        }
        else if (e.target.closest('.goal-header .actions .edit-btn')) {
            editingGoalId = goalId;
            renderInvestmentGoals();
        }
        else if (e.target.matches('.edit-goal-form .delete-btn')) {
            editingGoalId = null;
            renderInvestmentGoals();
        }
        else if (e.target.matches('.editing-goal-has-deadline')) {
            const deadlineInput = card.querySelector('.editing-goal-deadline');
            deadlineInput.style.display = e.target.checked ? 'block' : 'none';
        }
    });


    // ----------------------------------------------------
    // LÓGICA FINANCEIRA CENTRAL E GRÁFICOS
    // ----------------------------------------------------

    function createOrUpdateChart(canvasId, existingChartInstance, chartConfig) {
        if (typeof Chart === 'undefined') {
            console.error("A biblioteca Chart.js não foi carregada. Gráficos não podem ser criados.");
            return null;
        }
        
        const canvas = document.getElementById(canvasId);
        if (!canvas) {
            console.error(`Elemento canvas com id "${canvasId}" não encontrado.`);
            return null;
        }
        
        const ctx = canvas.getContext('2d');
        if (existingChartInstance) {
            existingChartInstance.destroy();
        }

        return new Chart(ctx, chartConfig);
    }
    
    function renderMonthChart() {
        const monthData = dataByMonth[currentMonth] || [];
        const categoryTotals = {};
        monthData.forEach(item => {
            if (item.value < 0) {
                categoryTotals[item.category] = (categoryTotals[item.category] || 0) + Math.abs(item.value);
            }
        });

        const isDarkMode = document.body.classList.contains('dark-mode');
        const textColor = isDarkMode ? '#E0E0E0' : '#333';
        const chartLabels = Object.keys(categoryTotals).filter(key => categoryTotals[key] > 0);
        const chartData = chartLabels.map(key => categoryTotals[key]);
        
        const monthChartConfig = {
            type: 'pie',
            data: {
                labels: chartLabels,
                datasets: [{
                    data: chartData,
                    backgroundColor: ['#FF5252', '#4CAF50', '#00BCD4', '#9C27B0', '#FFC107', '#FF9800', '#795548', '#607D8B', '#E91E63']
                }]
            },
            options: {
                plugins: {
                    legend: {
                        labels: { color: textColor }
                    }
                }
            }
        };
        monthChart = createOrUpdateChart('month-chart', monthChart, monthChartConfig);
    }

    function updateFinanceDisplay() {
        updateSummaryCards();
        renderAnnualChart();
        renderMonthChart();
    }
    
    function updateSummaryCards() {
        const monthData = dataByMonth[currentMonth] || [];
        const totalRevenue = monthData.filter(item => item.value > 0).reduce((acc, item) => acc + item.value, 0);
        const totalExpenses = monthData.filter(item => item.value < 0).reduce((acc, item) => acc + item.value, 0);
        const monthBalance = totalRevenue + totalExpenses;

        document.getElementById('total-revenue').textContent = formatCurrency(totalRevenue);
        document.getElementById('total-expense').textContent = formatCurrency(Math.abs(totalExpenses));
        const balanceEl = document.getElementById('month-balance');
        balanceEl.textContent = formatCurrency(monthBalance);
        balanceEl.style.color = monthBalance >= 0 ? '#4CAF50' : '#FF5252';
    }

    function renderExpenses() {
        expenseList.innerHTML = '';
        let total = 0;
        const monthData = dataByMonth[currentMonth] || [];

        monthData.forEach((item, index) => {
            const transactionType = item.type || (item.value >= 0 ? 'receita' : 'despesa');
            const escapedDesc = (item.desc || '').replace(/'/g, "&apos;").replace(/"/g, "&quot;");
            
            // Procura o ícone da categoria personalizada
            let iconPath = item.icon;
            
            if (!iconPath) {
                const allCategories = [...expenseCategories, ...revenueCategories];
                const categoryData = allCategories.find(cat => {
                    const catName = typeof cat === 'string' ? cat : cat.name;
                    return catName === item.category;
                });
                
                if (categoryData && typeof categoryData === 'object') {
                    iconPath = categoryData.icon;
                } else {
                    iconPath = categoryIcons[item.category] || categoryIcons["outros"];
                }
            }
            
            // Cores simplificadas: vermelho para despesas, verde para receitas
            const defaultIconColor = transactionType === 'receita' ? 'green' : 'red';
            const valueColor = transactionType === 'receita' ? '#4CAF50' : '#f44336';
            
            // Usa o ícone diretamente (cores serão aplicadas via CSS)
            const coloredIconPath = iconPath;
            const iconColor = item.categoryColor || defaultIconColor;
            
            const iconHtml = `<img src="${coloredIconPath}" class="category-icon icon-color-${iconColor}" alt="${item.category}" style="width: 24px; height: 24px; object-fit: contain;">`;
            
            const row = document.createElement('tr');
            row.style.borderBottom = '1px solid var(--border-color, #eee)';
            row.innerHTML = `
                <td style="text-align:center; padding: 12px 8px;">${iconHtml}</td>
                <td style="padding: 12px 8px; font-size: 14px;">${item.desc}</td>
                <td style="color: ${valueColor}; font-weight: bold; text-align:right; padding: 12px 8px; font-size: 14px;">${formatCurrency(Math.abs(item.value))}</td>
                <td style="text-align:center; padding: 12px 8px;">
                    <button class="edit-btn" data-index="${index}" style="margin-right: 5px;"><img src="buttons/pencil.svg" alt="Editar" style="width: 16px; height: 16px;"></button>
                    <button class="delete-btn" data-index="${index}"><img src="buttons/trash.svg" alt="Remover" style="width: 16px; height: 16px;"></button>
                </td>
            `;
            expenseList.appendChild(row);
            total += item.value;
        });
    }

    window.deleteExpense = function(index) {
        if (confirm("tem certeza que deseja excluir esta transação?")) {
            dataByMonth[currentMonth].splice(index, 1);
            saveFinancialData();
            renderExpenses();
            updateFinanceDisplay();
        }
    }

    window.editExpense = function(index) {
        editingIndex = index;
        const item = dataByMonth[currentMonth][index];
        descInput.value = item.desc;
        typeInput.value = item.type || (item.value >= 0 ? 'receita' : 'despesa');
        renderCategorySelect(typeInput.value === 'receita');
        categoryInput.value = item.category;
        valueInput.value = Math.abs(item.value);
        
        
        transactionListView.style.display = 'none';
        addTransactionContainer.style.display = 'block';
        transactionFormTitle.textContent = 'editar transação';

        submitButton.textContent = 'salvar';
        submitButton.style.background = '#4CAF50';

        if (!document.getElementById('cancel-edit-btn')) {
            const cancelButton = document.createElement('button');
            cancelButton.id = 'cancel-edit-btn';
            cancelButton.type = 'button';
            cancelButton.textContent = 'cancelar';
            cancelButton.className = 'add-btn';
            cancelButton.style.background = '#FF9800';
            cancelButton.onclick = cancelEdit;
            buttonGroup.appendChild(cancelButton);
        }
    }

    window.cancelEdit = function() {
        editingIndex = null;
        form.reset();
        submitButton.textContent = 'adicionar';
        submitButton.style.background = '#3586ff';
        transactionFormTitle.textContent = 'adicionar transação';

        typeInput.value = 'despesa';
        renderCategorySelect(false);
        const cancelButton = document.getElementById('cancel-edit-btn');
        if (cancelButton) cancelButton.remove();
        

        addTransactionContainer.style.display = 'none';
        transactionListView.style.display = 'block';
    }

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const desc = descInput.value, category = categoryInput.value, type = typeInput.value;
        let value = parseFloat(valueInput.value);
        
        // Obtém o ícone da categoria automaticamente
        let icon = null;
        const allCategories = [...expenseCategories, ...revenueCategories];
        const categoryData = allCategories.find(cat => {
            const catName = typeof cat === 'string' ? cat : cat.name;
            return catName === category;
        });
        
        if (categoryData && typeof categoryData === 'object') {
            icon = categoryData.icon;
        } else {
            icon = categoryIcons[category] || categoryIcons["outros"];
        }

        if (!desc || !category || isNaN(value)) {
            alert('Por favor, preencha a descrição, categoria e valor.');
            return;
        }
        
        let date;
        const expenseMonth = currentMonth;

        if (editingIndex !== null) {
            date = dataByMonth[currentMonth][editingIndex].date;
        } else {
            const today = new Date();
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const day = (year === today.getFullYear() && month === today.getMonth()) ? today.getDate() : 1;
            date = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }

        value = type === 'despesa' ? -Math.abs(value) : Math.abs(value);
        const newItem = { date, desc, category, type, value, icon };

        if (editingIndex !== null) {
            dataByMonth[currentMonth][editingIndex] = newItem;
        } else {
            if (!dataByMonth[expenseMonth]) dataByMonth[expenseMonth] = [];
            dataByMonth[expenseMonth].push(newItem);
        }

        saveFinancialData();
        renderExpenses();
        updateFinanceDisplay();
        
        if (editingIndex !== null) {
            cancelEdit();
        } else {
            form.reset();
            typeInput.value = 'despesa';
            renderCategorySelect(false);
            addTransactionContainer.style.display = 'none';
            transactionListView.style.display = 'block';
        }
    });

    function renderAnnualChart() {
        const isDarkMode = document.body.classList.contains('dark-mode');
        const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        const textColor = isDarkMode ? '#E0E0E0' : '#333';
        const year = currentCalendarDate.getFullYear();
        
        const monthlyRevenues = monthNamesPt.map(m => {
            const monthKey = `${m}-${year}`;
            return (dataByMonth[monthKey] || [])
                .filter(item => item.value > 0)
                .reduce((acc, item) => acc + item.value, 0);
        });

        const monthlyExpenses = monthNamesPt.map(m => {
            const monthKey = `${m}-${year}`;
            return (dataByMonth[monthKey] || [])
                .filter(item => item.value < 0)
                .reduce((acc, item) => acc + Math.abs(item.value), 0);
        });

        const annualChartConfig = {
            type: 'bar',
            data: {
                labels: monthNamesPt,
                datasets: [{
                    label: `receitas (${year})`,
                    data: monthlyRevenues,
                    backgroundColor: '#4CAF50'
                }, {
                    label: `despesas (${year})`,
                    data: monthlyExpenses,
                    backgroundColor: '#FF5252'
                }]
            },
            options: {
                scales: {
                    y: { beginAtZero: true, ticks: { color: textColor }, grid: { color: gridColor } },
                    x: { ticks: { color: textColor }, grid: { color: gridColor } }
                },
                plugins: {
                    legend: { labels: { color: textColor } }
                }
            }
        };
        annualChart = createOrUpdateChart('annual-chart', annualChart, annualChartConfig);
    }

    // ----------------------------------------------------
    // CÓDIGO DO PLANNER, TAREFAS E LISTAS
    // ----------------------------------------------------

    function findLinkedTask(listId) {
        for (const dateKey in calendarTasks) {
            const taskIndex = calendarTasks[dateKey].findIndex(task => task.linkedListId === listId);
            if (taskIndex > -1) {
                return {
                    task: calendarTasks[dateKey][taskIndex],
                    dateKey: dateKey,
                    taskIndex: taskIndex
                };
            }
        }
        return null;
    }

    function initCalendarSelect() {
        if (calendarMonthSelect.options.length === 0) {
             monthNamesPt.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = month;
                calendarMonthSelect.appendChild(option);
            });
        }
    }
    
    function renderCalendar(date) {
        calendarGrid.innerHTML = `<div class="calendar-day-name">dom</div> <div class="calendar-day-name">seg</div><div class="calendar-day-name">ter</div> <div class="calendar-day-name">qua</div><div class="calendar-day-name">qui</div><div class="calendar-day-name">sex</div><div class="calendar-day-name">sáb</div>`;
        const year = date.getFullYear(), month = date.getMonth();
        calendarMonthSelect.value = month;
        const firstDayOfMonth = new Date(year, month, 1).getDay(), daysInMonth = new Date(year, month + 1, 0).getDate(), daysInPrevMonth = new Date(year, month, 0).getDate();
        
        for (let i = firstDayOfMonth; i > 0; i--) {
            const dayDiv = document.createElement('div'); dayDiv.className = 'calendar-day inactive'; dayDiv.innerHTML = `<span class="calendar-day-number">${daysInPrevMonth - i + 1}</span>`; calendarGrid.appendChild(dayDiv);
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            dayDiv.innerHTML = `<span class="calendar-day-number">${day}</span>`;
            const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            dayDiv.addEventListener('click', () => openDayView(dateKey));

            const tasks = calendarTasks[dateKey] || [];
            if (tasks.length > 0) {
                dayDiv.style.borderColor = '#a572ff';
                const iconContainer = document.createElement('div');
                iconContainer.className = 'calendar-task-icons';
                
                tasks.forEach(task => {
                    if (task.icon) { 
                        const iconEl = document.createElement('img');
                        iconEl.src = task.icon;
                        const iconColor = task.color || task.iconColor || getIconColorFromPath(task.icon);
                        iconEl.className = `task-icon-grid-view icon-color-${iconColor}`;
                        if (task.priority === 'alta') {
                            iconEl.classList.add('priority-icon-alta');
                        }
                        iconContainer.appendChild(iconEl);
                    }
                });
                dayDiv.appendChild(iconContainer);
            }
            
            const today = new Date();
            if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                dayDiv.style.borderColor = '#e3e3e3';
                dayDiv.style.borderWidth = '2px';
            }
            calendarGrid.appendChild(dayDiv);
        }

        const totalSlots = Math.ceil((firstDayOfMonth + daysInMonth) / 7) * 7;
        for (let i = 1; i <= totalSlots - (firstDayOfMonth + daysInMonth); i++) {
            const dayDiv = document.createElement('div'); dayDiv.className = 'calendar-day inactive'; dayDiv.innerHTML = `<span class="calendar-day-number">${i}</span>`; calendarGrid.appendChild(dayDiv);
        }
    }

    // NOVA LÓGICA DE NAVEGAÇÃO DO PLANNER
    function openDayView(dateKey) {
        selectedDateKey = dateKey;
        dayViewTitle.textContent = `tarefas do dia`;
        renderDayTasks();
        
        // Força visibilidade com !important
        plannerDetailsContainer.style.setProperty('display', 'block', 'important');
        dayViewSection.style.setProperty('display', 'block', 'important');
        taskFormView.style.setProperty('display', 'none', 'important');
        
        // Scroll para garantir que o botão seja visível
        setTimeout(() => {
            // Scroll para o final da seção com margem extra
            const rect = dayViewSection.getBoundingClientRect();
            const scrollTop = window.pageYOffset + rect.bottom - window.innerHeight + 100;
            window.scrollTo({ top: scrollTop, behavior: 'smooth' });
        }, 200);
        
        // Debug: verifica se o botão existe
        console.log('Botão encontrado:', openAddTaskFormBtn);
        console.log('Botão display atual:', openAddTaskFormBtn.style.display);
        
        // Remove qualquer estilo inline que possa estar interferindo
        openAddTaskFormBtn.removeAttribute('style');
        
        // Garante que o botão de adicionar tarefa seja visível com !important
        openAddTaskFormBtn.style.setProperty('display', 'inline-flex', 'important');
        openAddTaskFormBtn.style.setProperty('visibility', 'visible', 'important');
        openAddTaskFormBtn.style.setProperty('opacity', '1', 'important');
        openAddTaskFormBtn.style.setProperty('width', '100%', 'important');
        openAddTaskFormBtn.style.setProperty('margin-top', '20px', 'important');
        
        console.log('Botão display após setProperty:', openAddTaskFormBtn.style.display);
        console.log('Botão computed style:', window.getComputedStyle(openAddTaskFormBtn).display);
        
        // Debug adicional para verificar visibilidade
        console.log('Container planner-details-container display:', window.getComputedStyle(plannerDetailsContainer).display);
        console.log('Container day-view-section display:', window.getComputedStyle(dayViewSection).display);
        console.log('Botão visibility:', window.getComputedStyle(openAddTaskFormBtn).visibility);
        console.log('Botão opacity:', window.getComputedStyle(openAddTaskFormBtn).opacity);
        console.log('Botão width:', window.getComputedStyle(openAddTaskFormBtn).width);
        console.log('Botão height:', window.getComputedStyle(openAddTaskFormBtn).height);
        console.log('Botão position:', window.getComputedStyle(openAddTaskFormBtn).position);
        console.log('Botão z-index:', window.getComputedStyle(openAddTaskFormBtn).zIndex);
        
        cancelTaskEdit(); // Garante que o formulário esteja limpo
    }
    
    function cancelTaskEdit() {
        taskFormModal.removeAttribute('data-editing-id');
        taskFormTitle.textContent = 'adicionar tarefa';
        taskDescriptionInput.value = '';
        taskTimeInput.value = '09:00';
        taskPriorityInput.checked = false; 
        
        // Garante que os ícones estejam renderizados
        if (taskIconPicker && taskIconPicker.children.length === 0) {
            renderIconPicker(taskIconPicker, taskIconHiddenInput, taskIcons, null, taskColorPicker);
        }
        
        // Reset da cor para azul
        if (taskColorPicker && taskIconColorInput) {
            taskColorPicker.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
            });
            const blueOption = taskColorPicker.querySelector('[data-color="blue"]');
            if (blueOption) blueOption.classList.add('selected');
            taskIconColorInput.value = 'blue';
        }
        
        const defaultOption = taskIconPicker.querySelector('.task-icon-option');
        if (defaultOption) defaultOption.click();
        
        addTaskBtn.textContent = 'adicionar';
        addTaskBtn.classList.remove('save-edit-btn');
        
        recurrenceTypeInput.value = 'none';
        recurrenceEndDateInput.value = '';
        recurrenceEndDateInput.style.display = 'none';
        recurrenceTypeInput.disabled = false;
        recurrenceEndDateInput.disabled = false;
        weeklyRecurrenceOptions.style.display = 'none';
        weeklyRecurrenceOptions.querySelectorAll('input').forEach(cb => {
            cb.checked = false;
            cb.disabled = false;
        });
    }

    window.editTask = function(taskId) {
        const tasks = calendarTasks[selectedDateKey] || [];
        const taskToEdit = tasks.find(t => t.id === taskId);
        if (!taskToEdit) return;
        
        if (taskToEdit.linkedListId) {
            // Listas agendadas só podem ser editadas na aba listas
            alert('Esta é uma lista agendada. Para editá-la, vá para a aba "listas".');
            return;
        }

        taskTimeInput.value = taskToEdit.time;
        taskDescriptionInput.value = taskToEdit.description;
        taskPriorityInput.checked = taskToEdit.priority === 'alta';

        addTaskBtn.textContent = 'salvar';
        addTaskBtn.classList.add('save-edit-btn');
        taskFormModal.setAttribute('data-editing-id', taskId);
        taskFormTitle.textContent = 'editar tarefa';
        taskIconHiddenInput.value = taskToEdit.icon;

        if (taskIconPicker && taskIconPicker.children.length === 0) {
            renderIconPicker(taskIconPicker, taskIconHiddenInput, taskIcons, null, taskColorPicker);
        }

        const iconPath = taskToEdit.icon;
        const iconName = getIconKeyFromPath(iconPath);
        const iconColor = normalizeIconColor(taskToEdit.color || taskToEdit.iconColor || getIconColorFromPath(iconPath));

        if (taskColorPicker && taskIconColorInput) {
            selectColorOption(taskColorPicker, iconColor);
            taskIconColorInput.value = iconColor;
        }

        applyColorToIconOptions(taskIconPicker, iconColor);

        let selectedOption = null;
        taskIconPicker.querySelectorAll('.task-icon-option').forEach(option => {
            const isSelected = option.dataset.iconName === iconName;
            option.classList.toggle('selected', isSelected);
            if (isSelected) {
                selectedOption = option;
            }
        });

        if (!selectedOption) {
            selectedOption = taskIconPicker.querySelector('.task-icon-option');
            selectedOption?.classList.add('selected');
        }

        if (selectedOption) {
            taskIconHiddenInput.value = selectedOption.dataset.iconPath;
        }



        if (taskToEdit.recurrenceId) {
            recurrenceTypeInput.value = 'none';
            recurrenceTypeInput.disabled = true;
            recurrenceEndDateInput.style.display = 'none';
            recurrenceEndDateInput.disabled = true;
            weeklyRecurrenceOptions.querySelectorAll('input').forEach(cb => cb.disabled = true);
        }
        
        // Navega para a view do formulário - esconde tarefas do dia
        dayViewSection.style.setProperty('display', 'none', 'important');
        taskFormView.style.setProperty('display', 'block', 'important');
    }
    
    function renderDayTasks() {
        tasksList.innerHTML = '';
        const tasks = calendarTasks[selectedDateKey] || [];
        tasks.forEach(task => { if (!task.id) task.id = Date.now() + Math.random().toString().substring(2, 6); });
        tasks.sort((a, b) => (a.time > b.time) ? 1 : -1);
        if (tasks.length === 0) { tasksList.innerHTML = '<p style="text-align: center; color: #777;">nenhuma tarefa agendada.</p>'; return; }
        
        tasks.forEach((task) => {
            const taskItem = document.createElement('div');
            taskItem.className = 'task-list-item';
            if (task.priority === 'alta') {
                taskItem.classList.add('priority-alta');
            }
            if (task.linkedListId) {
                taskItem.dataset.listId = task.linkedListId;
                taskItem.style.cursor = 'pointer';
            }

            const iconColor = task.color || task.iconColor || getIconColorFromPath(task.icon);
            const iconHtml = task.icon ? `<img src="${task.icon}" class="task-icon icon-color-${iconColor}" alt="ícone da tarefa">` : '';
            
            // Para listas agendadas, não mostra o botão de editar
            const editButton = task.linkedListId ? '' : `<button class="edit-task-btn" onclick="editTask('${task.id}')"><img src="buttons/pencil.svg" alt="Editar"></button>`;
            
            taskItem.innerHTML = `
                <span>${iconHtml}<strong>${task.time}</strong> - ${task.description}</span>
                <div class="task-actions">
                    ${editButton}
                    <button onclick="removeTask('${task.id}')"><img src="buttons/trash.svg" alt="Remover"></button>
                </div>`;
            tasksList.appendChild(taskItem);
        });
    }

    taskFormModal.addEventListener('submit', function(e) {
        e.preventDefault();
        const time = taskTimeInput.value;
        const description = taskDescriptionInput.value.trim();
        
        // Obtém o ícone com a cor selecionada
        const selectedIconName = taskIconPicker.querySelector('.task-icon-option.selected')?.dataset.iconName || 'nenhum';
        const selectedColor = taskIconColorInput.value || 'blue';
        const icon = getColoredIcons(selectedIconName, selectedColor);
        
        
        const priority = taskPriorityInput.checked ? 'alta' : 'nenhuma';
        
        if (!time || !description) return alert('por favor, preencha o horário e a descrição da tarefa.');

        const editingId = taskFormModal.getAttribute('data-editing-id');
        const recurrenceType = recurrenceTypeInput.value;

        if (editingId) {
            const taskIndex = (calendarTasks[selectedDateKey] || []).findIndex(t => t.id == editingId);
            if (taskIndex === -1) return;

            const originalTask = calendarTasks[selectedDateKey][taskIndex];
            const updatedTaskData = { time, description, icon, priority, color: selectedColor };

            if (originalTask.recurrenceId) {
                const updateAll = confirm("esta é uma tarefa recorrente. deseja atualizar TODAS as futuras ocorrências?\n\n(clique em 'ok' para atualizar todas, ou 'cancelar' para atualizar apenas esta.)");
                if (updateAll) {
                    const taskDate = new Date(`${selectedDateKey}T12:00:00`);
                    for (const dateKey in calendarTasks) {
                        const currentDate = new Date(`${dateKey}T12:00:00`);
                        if (currentDate >= taskDate) {
                            calendarTasks[dateKey].forEach(task => {
                                if (task.recurrenceId === originalTask.recurrenceId) {
                                    Object.assign(task, updatedTaskData);
                                }
                            });
                        }
                    }
                } else {
                    Object.assign(originalTask, updatedTaskData);
                    originalTask.recurrenceId = null;
                }
            } else {
                Object.assign(originalTask, updatedTaskData);
            }
        } else {
            if (recurrenceType === 'none') {
                if (!calendarTasks[selectedDateKey]) calendarTasks[selectedDateKey] = [];
                calendarTasks[selectedDateKey].push({ id: Date.now().toString(), time, description, icon, priority, color: selectedColor, recurrenceId: null });
            } else {
                const endDateStr = recurrenceEndDateInput.value;
                if (!endDateStr) return alert('por favor, selecione uma data final para a recorrência.');

                const startDate = new Date(`${selectedDateKey}T12:00:00`);
                const endDate = new Date(`${endDateStr}T12:00:00`);
                if (startDate > endDate) return alert('a data final não pode ser anterior à data de início.');

                const recurrenceId = Date.now().toString();
                let currentDate = new Date(startDate);
                
                const selectedWeekdays = recurrenceType === 'weekly' 
                    ? Array.from(weeklyRecurrenceOptions.querySelectorAll('input:checked')).map(cb => parseInt(cb.value))
                    : [];

                if (recurrenceType === 'weekly' && selectedWeekdays.length === 0) {
                    return alert('por favor, selecione pelo menos um dia da semana para a recorrência semanal.');
                }

                while(currentDate <= endDate) {
                    const dateKey = currentDate.toISOString().split('T')[0];
                    let shouldAddTask = false;

                    if (recurrenceType === 'daily') {
                        shouldAddTask = true;
                    } else if (recurrenceType === 'weekly') {
                        if (selectedWeekdays.includes(currentDate.getDay())) {
                            shouldAddTask = true;
                        }
                    }
                    
                    if (shouldAddTask) {
                        if (!calendarTasks[dateKey]) calendarTasks[dateKey] = [];
                        calendarTasks[dateKey].push({
                            id: Date.now().toString() + Math.random(),
                            time,
                            description,
                            icon,
                            priority,
                            color: selectedColor,
                            recurrenceId
                        });
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }
        }
        
        saveCalendarTasks();
        renderDayTasks();
        renderCalendar(currentCalendarDate);
        
        // Navega de volta para a view do dia
        taskFormView.style.display = 'none';
        dayViewSection.style.display = 'block';
    });

    window.removeTask = function(taskId) {
        if (!calendarTasks[selectedDateKey]) return;

        const taskToRemove = calendarTasks[selectedDateKey].find(t => t.id === taskId);
        if (!taskToRemove) return;

        const linkedListId = taskToRemove.linkedListId;

        if (taskToRemove.recurrenceId) {
            const deleteAll = confirm("esta é uma tarefa recorrente. deseja apagar TODAS as futuras ocorrências?\n\n(clique em 'ok' para apagar todas, ou 'cancelar' para apagar apenas esta.)");
            
            if (deleteAll) {
                const recurrenceId = taskToRemove.recurrenceId;
                const taskDate = new Date(`${selectedDateKey}T12:00:00`);
                
                for (const dateKey in calendarTasks) {
                    const currentDate = new Date(`${dateKey}T12:00:00`);
                    if (currentDate >= taskDate) {
                        calendarTasks[dateKey] = calendarTasks[dateKey].filter(task => task.recurrenceId !== recurrenceId);
                        if (calendarTasks[dateKey].length === 0) {
                            delete calendarTasks[dateKey];
                        }
                    }
                }
            } else {
                calendarTasks[selectedDateKey] = calendarTasks[selectedDateKey].filter(t => t.id !== taskId);
            }
        } else {
            calendarTasks[selectedDateKey] = calendarTasks[selectedDateKey].filter(t => t.id !== taskId);
        }

        if (calendarTasks[selectedDateKey] && calendarTasks[selectedDateKey].length === 0) {
            delete calendarTasks[selectedDateKey];
        }

        saveCalendarTasks();
        renderDayTasks(); // Re-renderiza a lista de tarefas do dia atual
        renderCalendar(currentCalendarDate); // Atualiza os ícones no calendário

        if(linkedListId) {
            // Só renderiza listas se a aba de listas estiver ativa
            const listasSection = document.getElementById('listas-section');
            if (listasSection && listasSection.style.display === 'block') {
                loadAndRenderLists(); 
            }
        }
    }
    
    function getAllAvailableIcons() {
        // Combina todos os ícones disponíveis: taskIcons, categoryIcons e ícones adicionais
        const allIcons = {};
        
        // Adiciona ícones de tarefas
        Object.assign(allIcons, taskIcons);
        
        // Adiciona ícones de categoria
        Object.assign(allIcons, categoryIcons);
        
        // Adiciona ícones adicionais que podem não estar nos outros objetos
        const additionalIcons = {
            // === ÍCONES CIRCULARES/BÁSICOS ===
            "estrela": "./images/star.svg",
            
            // === SAÚDE E BEM-ESTAR ===
            "pílulas": "./images/pills.svg", "dente": "./images/tooth.svg", "escova de dente": "./images/hairbrush.svg",
            "injeção": "./images/injection.svg",
            
            // === ESPORTES ===
            "futebol": "./images/football.svg", "ping pong": "./images/football.svg", "vôlei": "./images/football.svg",
            
            // === NATUREZA E PLANTAS ===
            "folha": "./images/plant.svg", "lesma": "./images/snail.svg",
            
            // === OUTROS/VARIADOS ===
            "dna": "./images/health.svg", "olho": "./images/eye.svg", "juiz": "./images/people.svg"
        };
        
        Object.assign(allIcons, additionalIcons);
        
        return allIcons;
    }

    // Função auxiliar para extrair a cor do caminho do ícone
    function getIconColorFromPath(iconPath) {
        // Extrai a cor do caminho antigo (colored/[cor]/) ou retorna 'blue' como padrão
        const colorMatch = iconPath.match(/\/colored\/([^\/]+)\//);
        if (colorMatch) {
            return colorMatch[1];
        }
        // Para novos caminhos, retorna 'blue' como padrão
        return 'blue';
    }
    
    function getColoredIcons(iconName, color = 'blue') {
        const normalizedName = typeof iconName === 'string' ? iconName.toLowerCase() : iconName;
        const availableIcons = getAllAvailableIcons();

        if (availableIcons[iconName]) {
            return sanitizeIconPath(availableIcons[iconName]);
        }

        if (normalizedName && availableIcons[normalizedName]) {
            return sanitizeIconPath(availableIcons[normalizedName]);
        }

        // Mapeamento dos nomes do código para os nomes dos arquivos (cores aplicadas via CSS)
        const iconNameMap = {
            "nenhum": "circledashed",
            "lista": "circledashed",
            "compras": "shopping",
            "médico": "health",
            "medicação": "pills",
            "dentista": "tooth",
            "dinheiro": "money",
            "coração": "heart",
            "pet": "pet",
            "exercício": "gym",
            "esportes": "football",
            "meditação": "meditation",
            "trabalho": "work",
            "beleza": "hairbrush",
            "escova": "hairbrush",
            "comida": "burger",
            "presente": "gift",
            "aniversário": "birthday",
            "festa": "party",
            "férias": "vacation",
            "viagem": "plane",
            "reunião": "people",
            "pessoas": "people",
            "computador": "computer",
            "filme": "picture",
            "mídia": "picture",
            "cogumelo": "mushroom",
            "estudo": "study",
            "casa": "house",
            "carro": "plane",
            "câmera": "picture",
            "unhas": "nails",
            "pele": "body",
            "escrever": "write",
            "arte": "picture",
            "flor": "flower",
            "planta": "plant",
            "maçã": "apple",
            "caixa": "box",
            "cérebro": "study",
            "comprar": "buy",
            "cenoura": "carrot",
            "cigarro": "cigarette",
            "data": "circledashed",
            "sorvete": "icecream",
            "pessoa": "people",
            "telefone": "computer",
            "pipoca": "popcorn",
            "camisa": "shirt",
            "assinaturas": "infinite",
            "futebol": "football",
            "ping pong": "football",
            "vôlei": "football",
            "dna": "health",
            "olho": "eye",
            "injeção": "injection",
            "juiz": "people",
            "folha": "plant",
            "pílulas": "pills",
            "lesma": "snail",
            "estrela": "star",
            "dente": "tooth",
            "escova de dente": "hairbrush",
            "música": "music",
            "arma": "gun"
        };

        // Retorna ícones sem pasta colorida (cores aplicadas via CSS)
        const fallbackKey = normalizedName && iconNameMap[normalizedName] ? iconNameMap[normalizedName] : iconNameMap[iconName];
        const fileName = fallbackKey || normalizedName || iconName;
        return sanitizeIconPath(`./images/${fileName}.svg`);
    }

    function normalizeIconColor(color) {
        return supportedIconColors.includes(color) ? color : 'blue';
    }

    function getIconKeyFromPath(iconPath) {
        if (!iconPath) return 'nenhum';
        const cleanPath = iconPath.split('?')[0];
        const fileName = cleanPath.substring(cleanPath.lastIndexOf('/') + 1).replace('.svg', '');
        return iconFileNameToKeyMap[fileName] || 'nenhum';
    }

    function applyColorToIconOptions(pickerElement, color) {
        if (!pickerElement) return;
        const normalizedColor = normalizeIconColor(color);
        pickerElement.querySelectorAll('.task-icon-option').forEach(option => {
            const iconName = option.dataset.iconName;
            if (!iconName) return;
            const coloredPath = getColoredIcons(iconName, normalizedColor);
            option.dataset.iconPath = coloredPath;

            let img = option.querySelector('img');
            if (!img) {
                img = document.createElement('img');
                option.appendChild(img);
            }

            img.src = coloredPath + '?t=' + Date.now() + '&r=' + Math.random();
            img.className = `icon-color-${normalizedColor}`;
            img.dataset.color = normalizedColor;
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'contain';
            img.style.borderRadius = '5px';
        });
    }

    function selectColorOption(colorPickerElement, color) {
        if (!colorPickerElement) return;
        const normalizedColor = normalizeIconColor(color);
        colorPickerElement.querySelectorAll('.color-option').forEach(option => {
            option.classList.toggle('selected', option.dataset.color === normalizedColor);
        });
    }


    function renderIconPicker(pickerElement, hiddenInputElement, iconObject, onSelectCallback = null, colorPickerElement = null) {
        if (!pickerElement) {
            console.error('renderIconPicker: pickerElement não encontrado');
            return;
        }
        pickerElement.innerHTML = '';
        const icons = iconObject || taskIcons;
        
        // Determina a cor atual
        let currentColor = 'blue';
        if (colorPickerElement) {
            const selectedColorOption = colorPickerElement.querySelector('.color-option.selected');
            if (selectedColorOption) {
                currentColor = selectedColorOption.dataset.color;
            }
        }

        for (const key in icons) {
            // Para seletores com colorPickerElement, usa cores dinâmicas
            let iconPath;
            if (colorPickerElement) {
                iconPath = getColoredIcons(key, currentColor);
            } else {
                iconPath = icons[key]; // Para outros seletores, mantém o comportamento atual
            }
            
            const option = document.createElement('div');
            option.className = 'task-icon-option';
            option.dataset.iconPath = iconPath;
            option.dataset.iconName = key;
            
             // Cria a imagem com timestamp para evitar cache
             const img = document.createElement('img');
             img.src = iconPath + '?t=' + Date.now() + '&r=' + Math.random();
             img.className = `icon-color-${currentColor}`;
             img.dataset.color = currentColor;
             option.appendChild(img);
            
            option.addEventListener('click', function() {
                if (hiddenInputElement) {
                    pickerElement.querySelector('.selected')?.classList.remove('selected');
                    this.classList.add('selected');
                    hiddenInputElement.value = this.getAttribute('data-icon-path');
                }
                if (onSelectCallback) {
                    onSelectCallback(iconPath);
                }
            });
            pickerElement.appendChild(option);
        }
        
        // Adiciona event listener para o seletor de cor se fornecido
        if (colorPickerElement) {
            colorPickerElement.addEventListener('click', (e) => {
                const colorOption = e.target.closest('.color-option');
                if (colorOption) {
                    // Remove seleção anterior
                    colorPickerElement.querySelectorAll('.color-option').forEach(option => {
                        option.classList.remove('selected');
                    });
                    
                    // Seleciona nova cor
                    colorOption.classList.add('selected');
                    const selectedColor = colorOption.dataset.color;
                    
                    // Atualiza TODOS os ícones com a nova cor
                    pickerElement.querySelectorAll('.task-icon-option').forEach(iconOption => {
                        const iconName = iconOption.dataset.iconName;
                        const coloredPath = getColoredIcons(iconName, selectedColor);
                        const img = iconOption.querySelector('img');
                        img.src = coloredPath + '?t=' + Date.now() + '&r=' + Math.random();
                        img.className = `icon-color-${selectedColor}`;
                        img.dataset.color = selectedColor;
                        iconOption.dataset.iconPath = coloredPath;
                    });
                    
                    // Atualiza o ícone selecionado
                    const selectedIcon = pickerElement.querySelector('.task-icon-option.selected');
                    if (selectedIcon && hiddenInputElement) {
                        const iconName = selectedIcon.dataset.iconName;
                        const coloredPath = getColoredIcons(iconName, selectedColor);
                        hiddenInputElement.value = coloredPath;
                    }
                }
            });
        }
        
        

        if(hiddenInputElement) {
            const firstOption = pickerElement.querySelector('.task-icon-option');
            if (firstOption) {
                firstOption.click();
            }
        }
    }

    
    function deleteListAndLinkedTask(listDiv, listName) {
        const listIdToDelete = listDiv.dataset.listId;
        if (!listIdToDelete) return;
        
        const linkedTaskInfo = findLinkedTask(listIdToDelete);
        let confirmMessage = `tem certeza que deseja excluir a lista "${listName}"?`;
        
        if (linkedTaskInfo) {
            const isRecurring = linkedTaskInfo.task.recurrenceId;
            confirmMessage += isRecurring 
                ? "\n\nesta ação também removerá TODAS as suas ocorrências agendadas no planner."
                : "\n\nesta ação também a removerá do planner.";
        }
        
        if (!confirm(confirmMessage)) return;

        if (linkedTaskInfo) {
            if (linkedTaskInfo.task.recurrenceId) {
                const recurrenceId = linkedTaskInfo.task.recurrenceId;
                 for (const dateKey in calendarTasks) {
                    calendarTasks[dateKey] = calendarTasks[dateKey].filter(task => task.recurrenceId !== recurrenceId);
                    if (calendarTasks[dateKey].length === 0) {
                        delete calendarTasks[dateKey];
                    }
                }
            } else {
                 const { dateKey, taskIndex } = linkedTaskInfo;
                calendarTasks[dateKey].splice(taskIndex, 1);
                if (calendarTasks[dateKey].length === 0) {
                    delete calendarTasks[dateKey];
                }
            }
        }
        
        saveCalendarTasks();
        renderCalendar(currentCalendarDate);

        listDiv.remove();
        saveLists();
    }

    function updateShoppingListTotal(listDiv) {
        const totalEl = listDiv.querySelector('.list-total span');
        if (!totalEl) return;

        const items = listDiv.querySelectorAll('ul li');
        let total = 0;
        items.forEach(item => {
            total += parseFloat(item.dataset.value) || 0;
        });
        totalEl.textContent = formatCurrency(total);
    }

    function finalizePurchase(listId) {
        const listDiv = document.querySelector(`.list[data-list-id="${listId}"]`);
        if (!listDiv || listDiv.classList.contains('finalized')) return;

        const listName = listDiv.querySelector('h2').textContent;
        const iconSrc = listDiv.querySelector('.list-title-icon').src;
        
        const categoryEntry = Object.entries(categoryIcons).find(([name, path]) => iconSrc.includes(path.substring(2)));
        const categoryName = categoryEntry ? categoryEntry[0] : 'compras';

        let total = 0;
        listDiv.querySelectorAll('ul li').forEach(item => {
            total += parseFloat(item.dataset.value) || 0;
        });

        if (total <= 0) {
            alert("Adicione itens com valor antes de finalizar a compra.");
            return;
        }

        if(confirm(`Finalizar a compra "${listName}" com o valor total de ${formatCurrency(total)}? Uma nova despesa será adicionada na categoria "${categoryName}".`)) {
            const transactionId = Date.now(); // ID único para a transação
            const newTransaction = {
                id: transactionId, // Armazena o ID
                date: new Date().toISOString().split('T')[0],
                desc: listName,
                category: categoryName,
                type: 'despesa',
                value: -Math.abs(total),
                icon: iconSrc
            };

            if (!dataByMonth[currentMonth]) dataByMonth[currentMonth] = [];
            dataByMonth[currentMonth].push(newTransaction);
            
            saveFinancialData();
            updateFinanceDisplay();
            
            listDiv.classList.add('finalized');
            listDiv.querySelector('.finalize-purchase-btn').style.display = 'none';
            listDiv.querySelector('.undo-finalize-btn').style.display = 'block';
            listDiv.querySelector('.shopping-input-group').querySelectorAll('input, button').forEach(el => el.disabled = true);
            
            // Armazena os dados da transação no elemento da lista
            listDiv.dataset.transactionId = transactionId;
            listDiv.dataset.transactionMonth = currentMonth;
            
            saveLists();
            
            alert("Compra finalizada e adicionada às suas finanças!");
        }
    }

    function undoFinalizePurchase(listId) {
        const listDiv = document.querySelector(`.list[data-list-id="${listId}"]`);
        if (!listDiv) return;

        const transactionId = parseInt(listDiv.dataset.transactionId);
        const transactionMonth = listDiv.dataset.transactionMonth;

        if (transactionId && transactionMonth && dataByMonth[transactionMonth]) {
            // Remove a transação financeira correspondente
            dataByMonth[transactionMonth] = dataByMonth[transactionMonth].filter(t => t.id !== transactionId);
            saveFinancialData();
            updateFinanceDisplay();
        }
        
        // Reverte o estado visual e funcional da lista
        listDiv.classList.remove('finalized');
        listDiv.querySelector('.finalize-purchase-btn').style.display = 'block';
        listDiv.querySelector('.undo-finalize-btn').style.display = 'none';
        listDiv.querySelector('.shopping-input-group').querySelectorAll('input, button').forEach(el => el.disabled = false);

        // Limpa os dados da transação do elemento
        delete listDiv.dataset.transactionId;
        delete listDiv.dataset.transactionMonth;

        saveLists();
    }


    window.createList = function(listName, initialItems = [], initialPriority = 'baixa', listId = Date.now().toString(), listIcon = taskIcons.lista, isShoppingList = false, isFinalized = false, isRoutine = false, transactionId = null, transactionMonth = null, borderColor = null, iconColorName = null) {
        if (!listName) return;

        const listDiv = document.createElement("div");
        listDiv.className = "list priority-" + initialPriority;
        listDiv.dataset.listId = listId;
        listDiv.dataset.isShopping = isShoppingList;
        if (isRoutine) {
            listDiv.dataset.isRoutine = 'true';
        }
        if (transactionId) {
            listDiv.dataset.transactionId = transactionId;
            listDiv.dataset.transactionMonth = transactionMonth;
        }
        
        // Define a cor da borda baseada na prioridade ou na cor informada
        const isDarkMode = document.body.classList.contains('dark-mode');
        const normalizedBorderColorName = borderColor ? getColorNameFromValue(borderColor) : null;
        const resolvedBorderColor = borderColor || getPriorityColor(initialPriority, isDarkMode);
        listDiv.style.borderLeftColor = resolvedBorderColor;

        const resolvedIconColorName = (iconColorName || normalizedBorderColorName || getColorNameFromValue(resolvedBorderColor) || getColorNameFromPriority(initialPriority) || 'blue');
        listDiv.dataset.colorName = resolvedIconColorName;

        const titleContainer = document.createElement('div');
        titleContainer.className = 'list-title-container';
        titleContainer.style.display = 'flex';
        titleContainer.style.justifyContent = 'space-between';
        titleContainer.style.alignItems = 'center';
        titleContainer.style.marginBottom = '10px';
        const iconImg = document.createElement('img');

        const defaultIconPath = sanitizeIconPath(taskIcons.lista || taskIcons.nenhum || './images/circledashed.svg');
        let resolvedIconPath = sanitizeIconPath(listIcon || '');

        if (resolvedIconPath.includes('images/colored/')) {
            const fileName = resolvedIconPath.split('/').pop();
            const iconNameFromLegacy = fileName.replace('.svg', '');
            const newIconName = legacyIconNameMap[iconNameFromLegacy] || iconNameFromLegacy;
            resolvedIconPath = `./images/${newIconName}.svg`;
        }

        if (!resolvedIconPath) {
            resolvedIconPath = defaultIconPath;
        }

        if (isShoppingList) {
            const shoppingIconPath = sanitizeIconPath(taskIcons.compras || defaultIconPath);
            if (!listIcon || resolvedIconPath === defaultIconPath) {
                resolvedIconPath = shoppingIconPath;
            }
        }

        iconImg.src = resolvedIconPath + '?t=' + Date.now();
        iconImg.className = 'list-title-icon icon-color-' + resolvedIconColorName;
        iconImg.dataset.color = resolvedIconColorName;
        const title = document.createElement("h2");
        title.textContent = listName;
        title.style.margin = 0;
        title.style.fontSize = '14px';
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'list-title-actions';
        const editBtn = document.createElement("button");
        editBtn.innerHTML = '<img src="buttons/pencil.svg" alt="Editar">';
        editBtn.className = "edit-list-btn";
        editBtn.onclick = () => openListEditorSection(listId);
        const removeBtn = document.createElement("button");
        removeBtn.innerHTML = '<img src="buttons/closelist.svg" alt="Remover Lista">';
        removeBtn.className = "delete-list-circular-btn";
        removeBtn.onclick = () => deleteListAndLinkedTask(listDiv, listName);
        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(removeBtn);
        titleContainer.appendChild(iconImg);
        titleContainer.appendChild(title);
        titleContainer.appendChild(actionsDiv);
        
        const prioritySelect = document.createElement("select");
        prioritySelect.className = "list-priority-select";
        prioritySelect.innerHTML = `<option value="baixa">baixa prioridade</option><option value="media">média prioridade</option><option value="alta">alta prioridade</option>`;
        prioritySelect.value = initialPriority;
        prioritySelect.onchange = () => {
            const newPriority = prioritySelect.value;
            const isDarkMode = document.body.classList.contains('dark-mode');
            const newColor = getPriorityColor(newPriority, isDarkMode);
            const newColorName = getColorNameFromPriority(newPriority);
            
            // Atualiza a classe de prioridade
            listDiv.classList.remove('priority-baixa', 'priority-media', 'priority-alta');
            listDiv.classList.add('priority-' + newPriority);
            
            // Atualiza a cor da borda
            listDiv.style.borderLeftColor = newColor;

            // Atualiza o ícone com a nova cor
            const currentIconSrc = iconImg.src;
            const iconFileName = currentIconSrc.split('/').pop().split('?')[0].replace('.svg', '');
            const iconName = Object.keys(taskIcons).find(key => taskIcons[key].includes(iconFileName)) || 'compras';
            const newIconPath = getColoredIcons(iconName, newColorName);
            iconImg.src = newIconPath + '?t=' + Date.now();
            iconImg.className = 'list-title-icon icon-color-' + newColorName;
            iconImg.dataset.color = newColorName;
            listDiv.dataset.colorName = newColorName;

            saveLists();
        };

        const inputGroup = document.createElement("div");
        const ul = document.createElement("ul");
        
        if (isShoppingList) {
            inputGroup.className = "shopping-input-group";
            const itemInput = document.createElement("input");
            itemInput.type = "text";
            itemInput.placeholder = "item";
            const valueInput = document.createElement("input");
            valueInput.type = "number";
            valueInput.placeholder = "R$";
            valueInput.step = "0.01";
            const addBtn = document.createElement("button");
            addBtn.textContent = "+";
            addBtn.className = "add-btn";

            inputGroup.append(itemInput, valueInput, addBtn);
            
            addBtn.onclick = () => {
                const text = itemInput.value.trim();
                const value = parseFloat(valueInput.value) || 0;
                if (!text) return;
                addItem(text, false, value);
                itemInput.value = "";
                valueInput.value = "";
                itemInput.focus();
                saveLists();
            };
        } else {
            inputGroup.className = "list-input-group";
            const input = document.createElement("input");
            input.type = "text";
            input.placeholder = "novo item";
            const addBtn = document.createElement("button");
            addBtn.textContent = "adicionar";
            addBtn.className = "add-btn";
            inputGroup.appendChild(input);
            inputGroup.appendChild(addBtn);
            
            addBtn.onclick = () => { 
                const text = input.value.trim(); 
                if (!text) return; 
                input.value = ""; 
                addItem(text); 
                checkCompletion(listDiv); 
                saveLists(); 
            };
        }
        
        const addItem = (text, checked = false, value = 0) => {
            const li = document.createElement("li");
            const contentDiv = document.createElement('div');
            contentDiv.className = 'list-item-content';
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.checked = checked;
            checkbox.onchange = () => { checkCompletion(listDiv); saveLists(); };
            const span = document.createElement("span");
            span.textContent = text;
            contentDiv.appendChild(checkbox);
            contentDiv.appendChild(span);
            
            if (isShoppingList) {
                li.dataset.value = value;
            }
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'list-item-actions';
            
            let valueDiv;
            if(isShoppingList){
                 valueDiv = document.createElement('div');
                 valueDiv.className = 'list-item-value';
                 valueDiv.textContent = formatCurrency(value);
            }
            
            const createInitialButtons = () => {
                actionsDiv.innerHTML = '';
                const editBtnItem = document.createElement('button');
                editBtnItem.className = 'edit-item-btn';
                editBtnItem.innerHTML = '<img src="buttons/pencil.svg" alt="Editar">';
                editBtnItem.onclick = () => toggleEditMode(true, li);

                const deleteBtnItem = document.createElement('button');
                deleteBtnItem.className = 'delete-item-btn';
                deleteBtnItem.innerHTML = '<img src="buttons/trash.svg" alt="Remover">';
                deleteBtnItem.onclick = () => {
                    li.remove();
                    if(isShoppingList) updateShoppingListTotal(listDiv);
                    checkCompletion(listDiv);
                    saveLists();
                };
                actionsDiv.appendChild(editBtnItem);
                actionsDiv.appendChild(deleteBtnItem);
            };

            const toggleEditMode = (isEditing, currentLi) => {
                 if (isEditing) {
                    const currentText = span.textContent;
                    const textInputField = document.createElement('input');
                    textInputField.type = 'text';
                    textInputField.value = currentText;
                    contentDiv.replaceChild(textInputField, span);
                    
                    if(isShoppingList){
                        const currentValue = parseFloat(currentLi.dataset.value);
                        const valueInputField = document.createElement('input');
                        valueInputField.type = 'number';
                        valueInputField.step = '0.01';
                        valueInputField.className = 'list-item-value-input';
                        valueInputField.value = currentValue.toFixed(2);
                        li.replaceChild(valueInputField, valueDiv);
                    }

                    textInputField.focus();
                    actionsDiv.innerHTML = '';
                    const saveBtn = document.createElement('button');
                    saveBtn.className = 'save-item-btn';
                    saveBtn.innerHTML = '<img src="buttons/ok.svg" alt="Salvar">';
                    saveBtn.onclick = () => {
                        span.textContent = textInputField.value;
                        if(isShoppingList){
                            const newValue = parseFloat(currentLi.querySelector('.list-item-value-input').value) || 0;
                            currentLi.dataset.value = newValue;
                            valueDiv.textContent = formatCurrency(newValue);
                            updateShoppingListTotal(listDiv);
                        }
                        toggleEditMode(false, currentLi);
                        saveLists();
                    };

                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'cancel-item-btn';
                    cancelBtn.innerHTML = '<img src="buttons/close.svg" alt="Cancelar">';
                    cancelBtn.onclick = () => toggleEditMode(false, currentLi);

                    actionsDiv.appendChild(saveBtn);
                    actionsDiv.appendChild(cancelBtn);
                } else {
                    const textInputField = contentDiv.querySelector('input[type="text"]');
                    if (textInputField) contentDiv.replaceChild(span, textInputField);
                    
                    if(isShoppingList){
                        const valueInputField = currentLi.querySelector('.list-item-value-input');
                        if (valueInputField) currentLi.replaceChild(valueDiv, valueInputField);
                    }
                    createInitialButtons();
                }
            };
            
            createInitialButtons();
            
            li.appendChild(contentDiv);
            if(isShoppingList) {
                li.appendChild(valueDiv);
            }
            li.appendChild(actionsDiv);
            ul.appendChild(li);
            if(isShoppingList) updateShoppingListTotal(listDiv);
        };
        
        listDiv.appendChild(titleContainer);
        listDiv.appendChild(prioritySelect);
        listDiv.appendChild(inputGroup);
        listDiv.appendChild(ul);
        
        if (isShoppingList) {
            const totalDiv = document.createElement('div');
            totalDiv.className = 'list-total';
            totalDiv.innerHTML = 'total: <span>r$ 0,00</span>';
            
            const finalizeBtn = document.createElement('button');
            finalizeBtn.className = 'finalize-purchase-btn';
            finalizeBtn.textContent = 'finalizar compra';
            finalizeBtn.onclick = () => finalizePurchase(listId);
            
            const undoBtn = document.createElement('button');
            undoBtn.className = 'undo-finalize-btn';
            undoBtn.textContent = 'desfazer finalização';
            undoBtn.onclick = () => undoFinalizePurchase(listId);
            
            listDiv.appendChild(totalDiv);
            listDiv.appendChild(finalizeBtn);
            listDiv.appendChild(undoBtn);
        }
        
        listsContainer.appendChild(listDiv);
        
        initialItems.forEach(item => addItem(item.text, item.checked, item.value));
        checkCompletion(listDiv);
        
        if (isFinalized) {
            listDiv.classList.add('finalized');
            const finalizeBtn = listDiv.querySelector('.finalize-purchase-btn');
            const undoBtn = listDiv.querySelector('.undo-finalize-btn');
            if (finalizeBtn) finalizeBtn.style.display = 'none';
            if (undoBtn) undoBtn.style.display = 'block';
            
            if(listDiv.querySelector('.shopping-input-group')) {
                listDiv.querySelector('.shopping-input-group').querySelectorAll('input, button').forEach(el => el.disabled = true);
            }
        }
    }

    function checkCompletion(listDiv) {
        const checkboxes = listDiv.querySelectorAll("ul li input[type='checkbox']");
        const isRoutine = listDiv.dataset.isRoutine === 'true';
        
        const oldMessage = listDiv.querySelector('.routine-complete-message');
        if (oldMessage) {
            oldMessage.remove();
        }

        if (checkboxes.length === 0) { 
            listDiv.classList.remove("completed"); 
            return; 
        }

        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        listDiv.classList.toggle("completed", allChecked);

        if (isRoutine && allChecked) {
            const messageEl = document.createElement('p');
            messageEl.className = 'routine-complete-message';
            messageEl.textContent = 'rotina do dia completa!';
            listDiv.appendChild(messageEl);
        }
    }
    
    // ----------------------------------------------------
    // INICIALIZAÇÃO E EVENT LISTENERS
    // ----------------------------------------------------

    newGoalHasDeadlineCheckbox.addEventListener('change', () => {
        newGoalDeadlineInput.style.display = newGoalHasDeadlineCheckbox.checked ? 'block' : 'none';
    });

    themeToggle.addEventListener('click', () => applyTheme(document.body.classList.contains('dark-mode') ? 'light' : 'dark'));
    
    // Event listener para botão de configurações (placeholder)
    if (settingsBtn) {
        settingsBtn.addEventListener('click', () => {
            alert('Configurações serão implementadas em breve!');
        });
    }
    expenseList.addEventListener('click', function(e) {
        const button = e.target.closest('button');
        if (!button) return;
        
        const index = button.getAttribute('data-index');
        if (button.classList.contains('edit-btn')) window.editExpense(parseInt(index));
        else if (button.classList.contains('delete-btn')) window.deleteExpense(parseInt(index));
    });

    showAddTransactionBtn.addEventListener('click', () => {
        transactionListView.style.setProperty('display', 'none', 'important');
        addTransactionContainer.style.setProperty('display', 'block', 'important');
    });
    
    backToTransactionsListBtn.addEventListener('click', () => {
        addTransactionContainer.style.display = 'none';
        transactionListView.style.display = 'block';
        cancelEdit(); // Reseta o formulário caso estivesse em modo de edição
    });

    const closeAddTransactionBtn = document.getElementById('close-add-transaction-btn');
    if (closeAddTransactionBtn) {
        closeAddTransactionBtn.addEventListener('click', () => {
            addTransactionContainer.style.display = 'none';
            transactionListView.style.display = 'block';
            cancelEdit(); // Reseta o formulário caso estivesse em modo de edição
        });
    }

    newListForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const listName = newListNameInput.value.trim().toLowerCase();
        if (!listName) return;

        const listPriority = newListPriorityInput.value;
        const newListId = Date.now().toString();
        const isShopping = shoppingListCheckbox.checked;
        const isRoutine = linkAsRoutineCheckbox.checked;
        
        createList(listName, [], listPriority, newListId, taskIcons.lista, isShopping, false, isRoutine);
        saveLists(); // Save the new list to localStorage
        
        if (linkToPlannerCheckbox.checked) {
            const eventDateStr = listEventDateInput.value;
            const eventTime = listEventTimeInput.value;
            const recurrenceType = isRoutine ? listRecurrenceTypeInput.value : 'none';

            if (!eventDateStr || !eventTime) {
                alert('Por favor, preencha a data e o horário para agendar a lista.');
                return;
            }

            const createTask = (dateKey, recurrenceId = null) => {
                 if (!calendarTasks[dateKey]) calendarTasks[dateKey] = [];
                 calendarTasks[dateKey].push({
                    id: Date.now().toString() + Math.random(),
                    time: eventTime,
                    description: listName, 
                    icon: taskIcons.lista,
                    priority: listPriority === 'alta' ? 'alta' : 'nenhuma',
                    recurrenceId: recurrenceId,
                    linkedListId: newListId
                });
            };

            if (recurrenceType === 'none') {
                createTask(eventDateStr);
            } else {
                const endDateStr = listRecurrenceEndDateInput.value;
                if (!endDateStr) return alert('Por favor, selecione uma data final para a recorrência.');

                const startDate = new Date(`${eventDateStr}T12:00:00`);
                const endDate = new Date(`${endDateStr}T12:00:00`);
                if (startDate > endDate) return alert('A data final não pode ser anterior à data de início.');

                const selectedWeekdays = recurrenceType === 'weekly' 
                    ? Array.from(listWeeklyRecurrenceOptions.querySelectorAll('input:checked')).map(cb => parseInt(cb.value))
                    : [];

                if (recurrenceType === 'weekly' && selectedWeekdays.length === 0) {
                    return alert('Por favor, selecione pelo menos um dia da semana para a recorrência semanal.');
                }
                
                const recurrenceId = Date.now().toString();
                let currentDate = new Date(startDate);

                while(currentDate <= endDate) {
                    const dateKey = currentDate.toISOString().split('T')[0];
                    let shouldAddTask = false;

                    if (recurrenceType === 'daily') {
                        shouldAddTask = true;
                    } else if (recurrenceType === 'weekly' && selectedWeekdays.includes(currentDate.getDay())) {
                        shouldAddTask = true;
                    }
                    
                    if (shouldAddTask) {
                        createTask(dateKey, recurrenceId);
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }
            saveCalendarTasks();
            renderCalendar(currentCalendarDate);
        }
        
        newListForm.reset();
        plannerLinkOptions.style.display = 'none';
        routineOptions.style.display = 'none';
        linkToPlannerCheckbox.checked = false;
        linkAsRoutineCheckbox.checked = false;
        listEventDateInput.required = false;
        listEventTimeInput.required = false;
    });

    listEditorForm.addEventListener('submit', (e) => {
        e.preventDefault();

        const listId = editorListIdInput.value;
        const newName = editorListNameInput.value.trim();
        let newListIcon = sanitizeIconPath(editorListIconInput.value);
        const newPriority = editorListPriorityInput.value;

        // Obtém a cor baseada na prioridade
        const isDarkMode = document.body.classList.contains('dark-mode');
        const newColorName = getColorNameFromPriority(newPriority);
        const newColor = getPriorityColor(newPriority, isDarkMode);

        if (!newName) {
            alert("O nome da lista não pode ficar em branco.");
            return;
        }

        let allLists = JSON.parse(localStorage.getItem('todoLists')) || [];
        const listIndex = allLists.findIndex(list => list.id === listId);
        if (listIndex > -1) {
            const existingList = allLists[listIndex];
            const priorityChanged = existingList.priority !== newPriority;
            const colorValue = priorityChanged ? newColor : (existingList.color || newColor);
            const colorNameValue = priorityChanged
                ? newColorName
                : (existingList.colorName || getColorNameFromValue(existingList.color) || getColorNameFromPriority(newPriority));

            if (!newListIcon) {
                newListIcon = sanitizeIconPath(existingList.icon);
            }

            existingList.name = newName;
            existingList.icon = newListIcon;
            existingList.priority = newPriority;
            existingList.color = colorValue;
            existingList.colorName = colorNameValue;
        }
        localStorage.setItem('todoLists', JSON.stringify(allLists));

        const isScheduling = editorSchedulingSection.style.display === 'block';

        if (isScheduling) {
            const linkedTaskInfo = findLinkedTask(listId);
            if (linkedTaskInfo && linkedTaskInfo.task.recurrenceId) {
                const recurrenceId = linkedTaskInfo.task.recurrenceId;
                for (const dateKey in calendarTasks) {
                    calendarTasks[dateKey] = calendarTasks[dateKey].filter(task => task.recurrenceId !== recurrenceId);
                    if (calendarTasks[dateKey].length === 0) delete calendarTasks[dateKey];
                }
            } else if (linkedTaskInfo) {
                calendarTasks[linkedTaskInfo.dateKey].splice(linkedTaskInfo.taskIndex, 1);
                if (calendarTasks[linkedTaskInfo.dateKey].length === 0) delete calendarTasks[linkedTaskInfo.dateKey];
            }

            const eventDateStr = editorEventDateInput.value;
            const eventTime = editorEventTimeInput.value;
            const isRoutine = editorLinkAsRoutineCheckbox.checked;
            const recurrenceType = isRoutine ? editorRecurrenceTypeInput.value : 'none';

            if (!eventDateStr || !eventTime) {
                alert("Por favor, preencha a data e o horário do agendamento.");
                return;
            }

            const createTask = (dateKey, recurrenceId = null) => {
                 if (!calendarTasks[dateKey]) calendarTasks[dateKey] = [];
                 calendarTasks[dateKey].push({
                    id: Date.now().toString() + Math.random(),
                    time: eventTime,
                    description: newName, 
                    icon: newListIcon,
                    priority: allLists[listIndex].priority === 'alta' ? 'alta' : 'nenhuma',
                    recurrenceId: recurrenceId,
                    linkedListId: listId
                });
            };

            if (recurrenceType === 'none') {
                createTask(eventDateStr);
            } else {
                const endDateStr = editorRecurrenceEndDateInput.value;
                if (!endDateStr) return alert('Por favor, selecione uma data final para a recorrência.');
                
                const startDate = new Date(`${eventDateStr}T12:00:00`);
                const endDate = new Date(`${endDateStr}T12:00:00`);
                if (startDate > endDate) return alert('A data final não pode ser anterior à data de início.');

                const selectedWeekdays = recurrenceType === 'weekly' 
                    ? Array.from(editorWeeklyRecurrenceOptions.querySelectorAll('input:checked')).map(cb => parseInt(cb.value))
                    : [];

                if (recurrenceType === 'weekly' && selectedWeekdays.length === 0) {
                    return alert('Por favor, selecione pelo menos um dia da semana para a recorrência.');
                }
                
                const recurrenceId = Date.now().toString();
                let currentDate = new Date(startDate);

                while(currentDate <= endDate) {
                    const dateKey = currentDate.toISOString().split('T')[0];
                    if (
                        recurrenceType === 'daily' || 
                        (recurrenceType === 'weekly' && selectedWeekdays.includes(currentDate.getDay()))
                    ) {
                        createTask(dateKey, recurrenceId);
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }
        }

        saveCalendarTasks();
        // Só renderiza listas se a aba de listas estiver ativa
        const listasSection = document.getElementById('listas-section');
        if (listasSection && listasSection.style.display === 'block') {
            loadAndRenderLists();
        }
        renderCalendar(currentCalendarDate);
        closeListEditorSection();
    });

    addScheduleBtn.addEventListener('click', () => {
        addScheduleBtn.style.display = 'none';
        editorSchedulingSection.style.display = 'block';
        editorRoutineContainer.style.display = 'flex';
    });

    removeScheduleBtn.addEventListener('click', () => {
        const listId = editorListIdInput.value;
        const linkedTaskInfo = findLinkedTask(listId);
        if(linkedTaskInfo && confirm("Tem certeza que deseja remover o agendamento desta lista do planner? Se for uma rotina, todas as ocorrências serão removidas.")) {
            if (linkedTaskInfo.task.recurrenceId) {
                const recurrenceId = linkedTaskInfo.task.recurrenceId;
                for (const dateKey in calendarTasks) {
                    calendarTasks[dateKey] = calendarTasks[dateKey].filter(task => task.recurrenceId !== recurrenceId);
                    if (calendarTasks[dateKey].length === 0) delete calendarTasks[dateKey];
                }
            } else {
                const { dateKey, taskIndex } = linkedTaskInfo;
                calendarTasks[dateKey].splice(taskIndex, 1);
                if (calendarTasks[dateKey].length === 0) delete calendarTasks[dateKey];
            }

            saveCalendarTasks();
            editorSchedulingSection.style.display = 'none';
            addScheduleBtn.style.display = 'block';
            renderCalendar(currentCalendarDate);
        }
    });

    // Event listener para mudança de prioridade no editor de lista (muda a cor do ícone)
    if (editorListPriorityInput) {
        editorListPriorityInput.addEventListener('change', (e) => {
            const selectedPriority = e.target.value;
            const selectedColor = getColorNameFromPriority(selectedPriority);
            
            // Atualiza a cor de todos os ícones no picker
            editorListIconPicker.querySelectorAll('.task-icon-option img').forEach(img => {
                img.className = 'icon-color-' + selectedColor;
                img.dataset.color = selectedColor;
            });
            
            // Atualiza o ícone selecionado
            const currentIconPath = editorListIconInput.value;
            const currentIconName = Object.keys(taskIcons).find(key => {
                return currentIconPath.includes(taskIcons[key].split('/').pop().replace('.svg', ''));
            });
            
            if (currentIconName) {
                const newIconPath = getColoredIcons(currentIconName, selectedColor);
                editorListIconInput.value = newIconPath;
            }
        });
    }

    linkToPlannerCheckbox.addEventListener('change', () => {
        const isChecked = linkToPlannerCheckbox.checked;
        plannerLinkOptions.style.display = isChecked ? 'flex' : 'none';
        routineContainer.style.display = isChecked ? 'flex' : 'none';
        listEventDateInput.required = isChecked;
        listEventTimeInput.required = isChecked;
        if (!isChecked) {
            routineOptions.style.display = 'none';
            linkAsRoutineCheckbox.checked = false;
        }
    });

    linkAsRoutineCheckbox.addEventListener('change', () => {
        routineOptions.style.display = linkAsRoutineCheckbox.checked ? 'flex' : 'none';
        if(linkAsRoutineCheckbox.checked) {
            plannerLinkOptions.style.display = 'flex'; // Garante que as opções de data/hora apareçam
            linkToPlannerCheckbox.checked = true;
        }
        listRecurrenceTypeInput.value = linkAsRoutineCheckbox.checked ? 'daily' : 'none';
        listRecurrenceTypeInput.dispatchEvent(new Event('change'));
    });
    
    tasksList.addEventListener('click', (e) => {
        const taskItem = e.target.closest('.task-list-item');
        if (taskItem && taskItem.dataset.listId) {
            if (e.target.closest('button')) return;
            openListDetailsSection(taskItem.dataset.listId);
        }
    });

    // LISTENERS PARA NAVEGAÇÃO
    openAddTaskFormBtn.addEventListener('click', () => {
        cancelTaskEdit(); 
        dayViewSection.style.setProperty('display', 'none', 'important');
        taskFormView.style.setProperty('display', 'block', 'important');
    });

    // Event listener para o seletor de cores das tarefas
    if (taskColorPicker) {
        taskColorPicker.addEventListener('click', (e) => {
            const colorOption = e.target.closest('.color-option');
            if (colorOption) {
                // Remove seleção anterior
                taskColorPicker.querySelectorAll('.color-option').forEach(option => {
                    option.classList.remove('selected');
                });
                
                // Seleciona nova cor
                colorOption.classList.add('selected');
                const selectedColor = colorOption.dataset.color;
                taskIconColorInput.value = selectedColor;
                
                // Atualiza TODOS os ícones com a nova cor
                taskIconPicker.querySelectorAll('.task-icon-option').forEach(iconOption => {
                    const iconName = iconOption.dataset.iconName;
                    const coloredPath = getColoredIcons(iconName, selectedColor);
                    
                    // Remove a imagem e recria com a nova cor
                    const img = iconOption.querySelector('img');
                    img.remove();
                    
                    const newImg = document.createElement('img');
                    newImg.src = coloredPath + '?t=' + Date.now() + '&r=' + Math.random();
                    newImg.className = `icon-color-${selectedColor}`;
                    newImg.dataset.color = selectedColor;
                    newImg.style.width = '100%';
                    newImg.style.height = '100%';
                    newImg.style.objectFit = 'contain';
                    newImg.style.borderRadius = '5px';
                    
                    iconOption.appendChild(newImg);
                    iconOption.dataset.iconPath = coloredPath;
                });
                
                // Atualiza o valor do ícone selecionado
                const selectedIcon = taskIconPicker.querySelector('.task-icon-option.selected');
                if (selectedIcon) {
                    const iconName = selectedIcon.dataset.iconName;
                    const coloredPath = getColoredIcons(iconName, selectedColor);
                    taskIconHiddenInput.value = coloredPath;
                }
            }
        });
    }

    closeDayViewBtn.addEventListener('click', () => {
        plannerDetailsContainer.style.setProperty('display', 'none', 'important');
        // Oculta o botão de adicionar tarefa quando fecha a view de dia
        openAddTaskFormBtn.style.setProperty('display', 'none', 'important');
    });
    
    backToDayViewBtn.addEventListener('click', () => {
        taskFormView.style.setProperty('display', 'none', 'important');
        dayViewSection.style.setProperty('display', 'block', 'important');
        
        // Garante que o botão de adicionar tarefa seja visível
        openAddTaskFormBtn.style.setProperty('display', 'inline-flex', 'important');
        openAddTaskFormBtn.style.setProperty('visibility', 'visible', 'important');
        openAddTaskFormBtn.style.setProperty('opacity', '1', 'important');
    });

    viewDetailsBtn.addEventListener('click', () => {
        renderExpenses(); 
        transactionListView.style.setProperty('display', 'block', 'important');
        addTransactionContainer.style.setProperty('display', 'none', 'important');
        budgetsView.style.display = 'none';
        investmentsView.style.display = 'none';
        categorySection.style.display = 'none';
        transactionsView.style.display = 'block';
        
        // Garante que o botão de adicionar transação seja visível
        showAddTransactionBtn.style.setProperty('display', 'inline-flex', 'important');
        showAddTransactionBtn.style.setProperty('visibility', 'visible', 'important');
        showAddTransactionBtn.style.setProperty('opacity', '1', 'important');
        
        // Scroll para garantir que o botão seja visível
        setTimeout(() => {
            const rect = transactionListView.getBoundingClientRect();
            const scrollTop = window.pageYOffset + rect.bottom - window.innerHeight + 100;
            window.scrollTo({ top: scrollTop, behavior: 'smooth' });
        }, 200);
    });

    closeTransactionsViewBtn.addEventListener('click', () => {
        transactionsView.style.display = 'none';
    });

    // Back to transactions list - goes from add/edit form to transactions list
    backToTransactionsListBtn.addEventListener('click', () => {
        addTransactionContainer.style.setProperty('display', 'none', 'important');
        transactionListView.style.setProperty('display', 'block', 'important');
        
        // Garante que o botão de adicionar transação seja visível
        showAddTransactionBtn.style.setProperty('display', 'inline-flex', 'important');
        showAddTransactionBtn.style.setProperty('visibility', 'visible', 'important');
        showAddTransactionBtn.style.setProperty('opacity', '1', 'important');
        
        cancelEdit(); // Resets form if in edit mode
    });

    // Show add transaction form
    showAddTransactionBtn.addEventListener('click', () => {
        transactionListView.style.setProperty('display', 'none', 'important');
        addTransactionContainer.style.setProperty('display', 'block', 'important');
    });

    viewCategorySpendingBtn.addEventListener('click', () => {
        updateCategorySpending();
        transactionsView.style.display = 'none';
        investmentsView.style.display = 'none';
        budgetsView.style.display = 'block';
        budgetsView.scrollIntoView({ behavior: 'smooth', block: 'start' });
        categorySection.style.display = 'none'; // Close category section when switching to budgets
    });

    closeBudgetsViewBtn.addEventListener('click', () => {
        budgetsView.style.display = 'none';
    });
    
    viewInvestmentsBtn.addEventListener('click', () => {
        renderInvestmentGoals();
        renderGoalIconPicker(); // Renderiza o seletor de ícones
        transactionsView.style.display = 'none';
        budgetsView.style.display = 'none';
        investmentsView.style.display = 'block';
        investmentsView.scrollIntoView({ behavior: 'smooth', block: 'start' });
        categorySection.style.display = 'none'; // Close category section when switching to investments
    });

    closeInvestmentsViewBtn.addEventListener('click', () => {
        investmentsView.style.display = 'none';
    });

    // Event listeners para os botões da seção de categorias
    const closeCategorySectionBtn = document.getElementById('close-category-section');
    const backFromCategoriesBtn = document.getElementById('back-from-categories');
    
    // Botão de fechar (X) - fecha apenas a seção de orçamentos
    closeCategorySectionBtn.addEventListener('click', () => {
        categorySection.style.display = 'none';
        budgetsView.style.display = 'none';
    });
    
    // Botão de voltar - volta para a tela de orçamentos
    backFromCategoriesBtn.addEventListener('click', () => {
        categorySection.style.display = 'none';
        budgetsView.style.display = 'block';
    });

    // Event listeners para navegação entre lista e formulário de investimentos
    if (openAddInvestmentFormBtn) {
        openAddInvestmentFormBtn.addEventListener('click', () => {
            if (!goalsContainer || !investmentFormView) {
                console.error('Elementos necessários não encontrados para abrir formulário');
                return;
            }
            goalsContainer.style.display = 'none';
            openAddInvestmentFormBtn.style.display = 'none';
            investmentFormView.style.display = 'block';
            renderGoalIconPicker(); // Renderiza o seletor de ícones
        });
    } else {
        console.error('openAddInvestmentFormBtn não encontrado');
    }

    if (backToInvestmentsListBtn) {
        backToInvestmentsListBtn.addEventListener('click', () => {
            if (!investmentFormView || !goalsContainer || !openAddInvestmentFormBtn) {
                console.error('Elementos necessários não encontrados para voltar à lista');
                return;
            }
            investmentFormView.style.display = 'none';
            goalsContainer.style.display = 'block';
            openAddInvestmentFormBtn.style.display = 'block';
            newGoalForm.reset(); // Limpa o formulário
            newGoalDeadlineInput.style.display = 'none';
            
            // Reseta os ícones para azul
            resetGoalIconsToBlue();
        });
    } else {
        console.error('backToInvestmentsListBtn não encontrado');
    }


    typeInput.addEventListener('change', (e) => {
        renderCategorySelect(e.target.value === 'receita');
    });



    // === NAVIGATION EVENT LISTENERS ===
    // Bottom navigation handles main section switching
    // Removed top navigation buttons (planner, finanças, listas)
    manageCategoriesBtnBudgets.addEventListener('click', () => {
        previousSection = 'budgets-view';
        openCategorySection();
    });
    addCategoryButton.addEventListener('click', addCategory);
    
    // Event listeners para edição de categoria
    saveCategoryButton.addEventListener('click', () => {
        saveCategoryEdit();
        cancelCategoryEdit();
    });
    
    cancelEditButton.addEventListener('click', cancelCategoryEdit);

    // Event listener desabilitado - cores automáticas baseadas no nome da categoria
    // As cores agora são definidas automaticamente pela função getCategoryColor()

    // Event listener para o seletor de cores dos investimentos
    if (goalColorPicker) {
        goalColorPicker.addEventListener('click', (e) => {
            const colorOption = e.target.closest('.color-option');
            if (colorOption) {
                // Remove seleção anterior
                goalColorPicker.querySelectorAll('.color-option').forEach(option => {
                    option.classList.remove('selected');
                });
                
                // Seleciona nova cor
                colorOption.classList.add('selected');
                const selectedColor = colorOption.dataset.color;
                goalColor.value = selectedColor;
                
                // Atualiza TODOS os ícones com a nova cor
                goalIconPicker.querySelectorAll('.task-icon-option').forEach(iconOption => {
                    const iconName = iconOption.dataset.iconName;
                    const coloredPath = getColoredIcons(iconName, selectedColor);
                    
                    // Remove a imagem e recria com a nova cor
                    const img = iconOption.querySelector('img');
                    img.remove();
                    
                    const newImg = document.createElement('img');
                    newImg.src = coloredPath + '?t=' + Date.now() + '&r=' + Math.random();
                    newImg.className = `icon-color-${selectedColor}`;
                    newImg.dataset.color = selectedColor;
                    newImg.style.width = '100%';
                    newImg.style.height = '100%';
                    newImg.style.objectFit = 'contain';
                    newImg.style.borderRadius = '5px';
                    
                    iconOption.appendChild(newImg);
                    iconOption.dataset.iconPath = coloredPath;
                });
                
                // Atualiza o valor do ícone selecionado
                const selectedIcon = goalIconPicker.querySelector('.task-icon-option.selected');
                if (selectedIcon) {
                    const iconName = selectedIcon.dataset.iconName;
                    const coloredPath = getColoredIcons(iconName, selectedColor);
                    goalIconHiddenInput.value = coloredPath;
                }
            }
        });
    }

    // Event listener para o seletor de cores das listas
    if (listColorPicker) {
        listColorPicker.addEventListener('click', (e) => {
            const colorOption = e.target.closest('.color-option');
            if (colorOption) {
                // Remove seleção anterior
                listColorPicker.querySelectorAll('.color-option').forEach(option => {
                    option.classList.remove('selected');
                });
                
                // Seleciona nova cor
                colorOption.classList.add('selected');
                const selectedColor = colorOption.dataset.color;
                listColor.value = selectedColor;
                
                // Atualiza TODOS os ícones com a nova cor
                listIconPickerGrid.querySelectorAll('.task-icon-option').forEach(iconOption => {
                    const iconName = iconOption.dataset.iconName;
                    const coloredPath = getColoredIcons(iconName, selectedColor);
                    
                    // Remove a imagem e recria com a nova cor
                    const img = iconOption.querySelector('img');
                    img.remove();
                    
                    const newImg = document.createElement('img');
                    newImg.src = coloredPath + '?t=' + Date.now() + '&r=' + Math.random();
                    newImg.className = `icon-color-${selectedColor}`;
                    newImg.dataset.color = selectedColor;
                    newImg.style.width = '100%';
                    newImg.style.height = '100%';
                    newImg.style.objectFit = 'contain';
                    newImg.style.borderRadius = '5px';
                    
                    iconOption.appendChild(newImg);
                    iconOption.dataset.iconPath = coloredPath;
                });
            }
        });
    }
    calendarMonthSelect.addEventListener('change', (e) => {
        currentCalendarDate.setMonth(parseInt(e.target.value));
        currentCalendarDate.setDate(1); 
        updateMonthlyView();
     });
     
    
    recurrenceTypeInput.addEventListener('change', () => {
        const isRecurrent = recurrenceTypeInput.value !== 'none';
        recurrenceEndDateInput.style.display = isRecurrent ? 'block' : 'none';
        recurrenceEndDateInput.required = isRecurrent;
        weeklyRecurrenceOptions.style.display = recurrenceTypeInput.value === 'weekly' ? 'block' : 'none';
    });



    
    listRecurrenceTypeInput.addEventListener('change', () => {
        const isRecurrent = listRecurrenceTypeInput.value !== 'none';
        listRecurrenceEndDateInput.style.display = isRecurrent ? 'block' : 'none';
        listRecurrenceEndDateInput.required = isRecurrent;
        listWeeklyRecurrenceOptions.style.display = listRecurrenceTypeInput.value === 'weekly' ? 'block' : 'none';
    });

    editorLinkAsRoutineCheckbox.addEventListener('change', () => {
        editorRoutineOptions.style.display = editorLinkAsRoutineCheckbox.checked ? 'flex' : 'none';
        editorRecurrenceTypeInput.value = editorLinkAsRoutineCheckbox.checked ? 'daily' : 'none';
        editorRecurrenceTypeInput.dispatchEvent(new Event('change'));
    });

    editorRecurrenceTypeInput.addEventListener('change', () => {
        const isRecurrent = editorRecurrenceTypeInput.value !== 'none';
        editorRecurrenceEndDateInput.style.display = isRecurrent ? 'block' : 'none';
        editorRecurrenceEndDateInput.required = isRecurrent;
        editorWeeklyRecurrenceOptions.style.display = editorRecurrenceTypeInput.value === 'weekly' ? 'block' : 'none';
    });


    // Removed window.onclick modal handlers since we're using sections now
    
    function showMensalSection(sectionId) {
        // Update previous section tracking
        const currentActiveSection = document.querySelector('.mensal-content-section[style*="block"]');
        if (currentActiveSection && currentActiveSection.id !== sectionId) {
            previousSection = currentActiveSection.id;
        }
        
        // Esconde TODAS as seções mensais com !important para garantir
        document.querySelectorAll('.mensal-content-section').forEach(section => {
            section.style.display = 'none';
            section.style.setProperty('display', 'none', 'important');
        });
        
        // Mostra apenas a seção selecionada
        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
            targetSection.style.display = 'block';
            targetSection.style.setProperty('display', 'block', 'important');
        }
        
        document.querySelectorAll('#mensal-controls .mensal-sub-toggle').forEach(btn => btn.classList.remove('active-sub'));
        // Update bottom navigation instead of top navigation
        const bottomNavItems = document.querySelectorAll('.bottom-nav-item');
        bottomNavItems.forEach(item => {
            item.classList.remove('active');
            if (item.dataset.section === sectionId) {
                item.classList.add('active');
            }
        });
        
        // Esconde todas as sub-views ao trocar de aba principal
        // Não esconde os containers principais para manter os botões visíveis
        // plannerDetailsContainer.style.display = 'none';
        // document.getElementById('finance-details-container').style.display = 'none';

        // Esconde as listas e o formulário quando não estiver na aba de listas
        if (sectionId !== 'listas-section') {
            listsContainer.style.display = 'none';
            newListForm.style.display = 'none';
        }

        if (sectionId === 'planner-section') {
            // Garante que o container do planner esteja visível
            plannerDetailsContainer.style.setProperty('display', 'block', 'important');
            // Hide all detail views within the container
            dayViewSection.style.setProperty('display', 'none', 'important');
            taskFormView.style.setProperty('display', 'none', 'important');
            
            // Oculta o botão de adicionar tarefa quando não estiver na view de dia
            openAddTaskFormBtn.style.setProperty('display', 'none', 'important');
        }

        if (sectionId === 'financeiro-section') {
            // Garante que o container de finanças esteja visível
            document.getElementById('finance-details-container').style.display = 'block';
            // Hide all detail views within the container
            transactionsView.style.display = 'none';
            budgetsView.style.display = 'none';
            investmentsView.style.display = 'none';
            categorySection.style.display = 'none';
            updateFinanceDisplay();
        }
        if (sectionId === 'listas-section') {
            listsContainer.style.display = 'flex'; // Mostra o container das listas
            newListForm.style.display = 'flex'; // Mostra o formulário de adicionar lista
            loadAndRenderLists();
        }
        if (sectionId === 'planner-section') {
            renderCalendar(currentCalendarDate);
        }
    }

    function updateMonthlyView() {
        const year = currentCalendarDate.getFullYear();
        const monthIndex = currentCalendarDate.getMonth();
        currentMonth = `${monthNamesPt[monthIndex]}-${year}`;
        
        calendarMonthSelect.value = monthIndex;
        
        
        const activeSectionId = document.querySelector('.bottom-nav-item.active')?.dataset.section || 'planner-section';
        showMensalSection(activeSectionId);
    }
    

    function initApp() {
        loadFinancialData();
        loadCalendarTasks();
        loadInvestmentGoals();
        applyTheme(localStorage.getItem('theme') || 'light');
        currentCalendarDate = new Date();
        initCalendarSelect();
        
        
        renderIconPicker(taskIconPicker, taskIconHiddenInput, taskIcons, null, taskColorPicker);
        renderIconPicker(editorListIconPicker, editorListIconInput, taskIcons, null, document.getElementById('editor-list-color-picker'));
        renderGoalIconPicker();
        renderIconPicker(listIconPickerGrid, null, taskIcons, selectListIcon, listColorPicker);
        renderIconPicker(categoryIconPicker, categoryIconHiddenInput, taskIcons, null, null);
        
        // Inicializa os seletores de cor
        if (goalColorPicker) {
            goalColorPicker.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
            });
            const blueOption = goalColorPicker.querySelector('[data-color="blue"]');
            if (blueOption) blueOption.classList.add('selected');
            if (goalColor) goalColor.value = 'blue';
        }
        
        if (listColorPicker) {
            listColorPicker.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
            });
            const blueOption = listColorPicker.querySelector('[data-color="blue"]');
            if (blueOption) blueOption.classList.add('selected');
            if (listColor) listColor.value = 'blue';
        }
        
        // Inicializa o seletor de cor do editor de listas
        const editorListColorPicker = document.getElementById('editor-list-color-picker');
        if (editorListColorPicker) {
            editorListColorPicker.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
            });
            const blueOption = editorListColorPicker.querySelector('[data-color="blue"]');
            if (blueOption) blueOption.classList.add('selected');
        }
        
        
        // Verifica se todos os elementos de investimento estão disponíveis
        if (openAddInvestmentFormBtn && investmentFormView && backToInvestmentsListBtn) {
            console.log('Elementos de investimento carregados corretamente');
        } else {
            console.error('Alguns elementos de investimento não foram encontrados:', {
                openAddInvestmentFormBtn: !!openAddInvestmentFormBtn,
                investmentFormView: !!investmentFormView,
                backToInvestmentsListBtn: !!backToInvestmentsListBtn
            });
        }
        
        renderCategorySelect(false);
        renderCategoryLimitSelect();
        updateMonthlyView();
    }

    initApp();
    
    // Bottom Navigation Control
    document.addEventListener('DOMContentLoaded', function() {
      const bottomNavItems = document.querySelectorAll('.bottom-nav-item');
      
      bottomNavItems.forEach(item => {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          const sectionId = this.dataset.section;
          
          // Update active state
          bottomNavItems.forEach(nav => nav.classList.remove('active'));
          this.classList.add('active');
          
          // Show the section
          showMensalSection(sectionId);
        });
      });
      
      // Update bottom nav active state when switching sections
      const originalShowMensalSection = window.showMensalSection;
      window.showMensalSection = function(sectionId) {
        originalShowMensalSection(sectionId);
        
        // Update bottom nav
        bottomNavItems.forEach(item => {
          item.classList.remove('active');
          if (item.dataset.section === sectionId) {
            item.classList.add('active');
          }
        });
      };
    });
  </script>


  <!-- Bottom Navigation (Mobile) -->
  <nav class="bottom-nav">
    <div class="bottom-nav-items">
      <a href="#" class="bottom-nav-item active" data-section="planner-section">
        <img src="buttons/calendar.svg" alt="Planner">
        <span>planner</span>
      </a>
      <a href="#" class="bottom-nav-item" data-section="financeiro-section">
        <img src="buttons/finance.svg" alt="Finanças">
        <span>finanças</span>
      </a>
      <a href="#" class="bottom-nav-item" data-section="listas-section">
        <img src="buttons/checklist.svg" alt="Listas">
        <span>listas</span>
      </a>
    </div>
  </nav>

</body>
</html>
